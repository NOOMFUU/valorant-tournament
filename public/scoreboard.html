<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scoreboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;700&family=Rajdhani:wght@500;600;700&family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --val-red: #ff4655;
            --val-dark: #0f1923;
            --val-dark-blue: #1c252e;
            --text-primary: #ece8e1;
            --accent-gold: #c6b784;
            --bracket-mid: #dda828;  /* สีสำหรับ Middle Bracket */
            --bracket-low: #00d4ff;  /* สีสำหรับ Lower Bracket */
        }

        body { 
            background-color: var(--val-dark); 
            color: var(--text-primary); 
            font-family: 'Inter', sans-serif; 
            overflow: hidden; 
        }

        /* Typography */
        .font-header { font-family: 'Oswald', sans-serif; text-transform: uppercase; letter-spacing: 0.05em; }
        .font-tech { font-family: 'Rajdhani', sans-serif; text-transform: uppercase; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }

        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        .custom-scroll::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: var(--val-red); }

        /* Navigation */
        .nav-tab {
            position: relative;
            opacity: 0.5;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            border-bottom: 3px solid transparent;
        }
        .nav-tab:hover { opacity: 0.9; color: white; }
        .nav-tab.active { 
            opacity: 1; 
            color: white; 
            border-bottom-color: var(--val-red); 
            text-shadow: 0 0 20px rgba(255, 70, 85, 0.6);
        }

        /* Card Styles */
        .broadcast-card {
            background: #1c252e;
            border: 1px solid rgba(255,255,255,0.05);
            transition: all 0.3s ease;
        }
        .broadcast-card:hover {
            background: #252e38;
            border-color: rgba(255,255,255,0.2);
            transform: translateY(-4px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .match-card-live {
            border: 1px solid var(--val-red);
            box-shadow: 0 0 20px rgba(255, 70, 85, 0.15);
        }
        .match-card-finished {
            border-left: 3px solid #444;
            opacity: 0.8;
        }
        .match-card-finished:hover { opacity: 1; border-color: white; }

        /* Team Card Special */
        .team-card-hover .team-logo-container { transition: transform 0.5s ease; }
        .team-card-hover:hover .team-logo-container { transform: scale(1.05); }
        
        /* Table Styling */
        .standings-table th {
            font-family: 'Rajdhani', sans-serif;
            font-weight: 700;
            color: #8b9bb4;
            letter-spacing: 0.1em;
            padding: 12px 16px;
            font-size: 0.8rem;
            border-bottom: 2px solid rgba(255,255,255,0.1);
            white-space: nowrap;
        }
        .standings-table td {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 0.9rem;
            transition: background 0.2s;
        }
        .standings-table tr:nth-child(even) td { background: rgba(255,255,255,0.02); }
        .standings-table tr:hover td { background: rgba(255,255,255,0.05); }
        .rank-1 { border-left: 3px solid var(--accent-gold); background: linear-gradient(90deg, rgba(198, 183, 132, 0.1) 0%, transparent 100%); }
        .rank-2 { border-left: 3px solid silver; }
        .rank-3 { border-left: 3px solid #cd7f32; }

        /* Animations */
        .animate-enter { animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; transform: translateY(30px); }
        @keyframes slideUp { to { opacity: 1; transform: translateY(0); } }

        /* Background Grid */
        .bg-grid {
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 60px 60px;
        }

        /* Bracket Connectors (Simple CSS) */
        .bracket-connector {
            position: absolute;
            right: -32px;
            top: 50%;
            width: 32px;
            height: 1px;
            background: rgba(255,255,255,0.1);
        }
    </style>
</head>
<body class="flex flex-col h-screen select-none bg-[#0f1923]">
    
    <div class="fixed inset-0 bg-grid pointer-events-none z-0"></div>
    <div class="fixed top-0 right-0 w-[800px] h-[800px] bg-[#ff4655] opacity-[0.03] blur-[150px] pointer-events-none rounded-full z-0"></div>
    <div class="fixed bottom-0 left-0 w-[600px] h-[600px] bg-[#1fa474] opacity-[0.02] blur-[120px] pointer-events-none rounded-full z-0"></div>

    <div id="loader" class="fixed inset-0 z-[9999] flex flex-col items-center justify-center bg-[#0f1923] transition-opacity duration-700">
        <div class="flex items-center gap-4">
            <span class="w-12 h-12 border-4 border-t-[#ff4655] border-r-transparent border-b-transparent border-l-[#ff4655] rounded-full animate-spin"></span>
        </div>
        <div class="mt-4 text-2xl font-header tracking-[0.3em] text-white animate-pulse">ESTABLISHING UPLINK</div>
    </div>

    <header class="h-24 border-b border-white/10 bg-[#0f1923]/90 backdrop-blur-md flex justify-between items-center px-8 z-50 shrink-0 relative">
        <div class="flex items-center gap-6">
            <div class="flex flex-col">
                <p class="text-[10px] text-gray-400 font-bold uppercase tracking-[0.3em] pl-1 transition-opacity duration-300" id="tourneyName">Connecting...</p>
            </div>
        </div>

        <nav id="mainNav" class="flex gap-2 h-full items-end mx-8 overflow-x-auto custom-scroll no-scrollbar"></nav>

        <div class="hidden xl:flex flex-col items-end border-l border-white/10 pl-8 h-12 justify-center">
            <div class="flex items-center gap-2 mb-1">
                <div class="w-2 h-2 bg-[#ff4655] rounded-full animate-pulse"></div>
                <span class="text-[10px] font-bold uppercase tracking-widest text-white">Live Feed</span>
            </div>
            <div class="font-mono text-2xl font-bold text-gray-300 leading-none tracking-widest" id="clock">00:00</div>
        </div>
    </header>

    <main class="flex-1 relative overflow-hidden flex flex-col z-10">
        <div id="contentArea" class="w-full h-full overflow-y-auto custom-scroll p-6 md:p-10"></div>
    </main>

    <div id="matchModal" class="fixed inset-0 z-[200] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/95 backdrop-blur-sm transition-opacity" onclick="closeMatchModal()"></div>
        <div class="relative w-full max-w-5xl bg-[#1a1d21] border border-white/10 rounded-sm shadow-2xl overflow-hidden animate-enter">
            <div id="modalContent"></div>
        </div>
    </div>

    <div id="teamModal" class="fixed inset-0 z-[200] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/95 backdrop-blur-sm transition-opacity" onclick="closeTeamModal()"></div>
        <div class="relative w-full max-w-6xl h-[90vh] bg-[#1a1d21] border border-white/10 rounded-sm shadow-2xl overflow-hidden animate-enter flex flex-col">
            <div class="flex justify-between items-center p-6 border-b border-white/10 bg-[#0f1113]">
                <h3 class="font-header text-2xl text-white tracking-widest">TEAM DOSSIER</h3>
                <button onclick="closeTeamModal()" class="text-gray-500 hover:text-white transition"><i class="fa-solid fa-xmark text-2xl"></i></button>
            </div>
            <div id="teamModalContent" class="flex-1 overflow-y-auto custom-scroll p-8 bg-gradient-to-b from-[#1a1d21] to-[#0f1923]"></div>
        </div>
    </div>

    <script>
        const API_BASE = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') && window.location.port !== '3000' ? 'http://localhost:3000' : '';
        const socket = io(API_BASE || undefined);
        let tournamentData = null, matchesData = [], teamsData = [];
        const DEFAULT_LOGO = "https://via.placeholder.com/100?text=TEAM";

        // --- CONFIGURATION ---
        const TIE_BREAKER_ORDER = ['POINTS', 'HEAD_TO_HEAD', 'MAP_DIFF', 'ROUND_DIFF'];

        // Clock
        setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'}), 1000);

        // Socket Events
        socket.on('connect', () => loadData());
        socket.on('match_update', () => loadData(true));
        socket.on('bracket_update', () => loadData(true));
        socket.on('teams_update', () => loadData(true));

        async function loadData(silent = false) {
            try {
                const ts = Date.now();
                const [tourneys, matches, teams] = await Promise.all([
                    fetch(`${API_BASE}/api/tournaments?t=${ts}`).then(r=>r.json()), 
                    fetch(`${API_BASE}/api/matches?t=${ts}`).then(r=>r.json()), 
                    fetch(`${API_BASE}/api/teams?t=${ts}`).then(r=>r.json())
                ]);

                if(!tourneys.length) {
                    document.getElementById('contentArea').innerHTML = '<div class="h-full flex flex-col items-center justify-center text-gray-600"><i class="fa-solid fa-server text-5xl mb-4 opacity-50"></i><h2 class="font-header text-2xl tracking-widest">NO SIGNAL</h2></div>';
                    document.getElementById('loader').classList.add('opacity-0', 'pointer-events-none');
                    return;
                }

                tournamentData = tourneys[0]; 
                matchesData = matches; 
                teamsData = teams;

                document.getElementById('tourneyName').innerText = tournamentData.name;
                if(!silent) document.getElementById('loader').classList.add('opacity-0', 'pointer-events-none');

                renderNav();

                // State Restoration
                const activeTab = document.querySelector('.nav-tab.active');
                if(activeTab) {
                    if(activeTab.dataset.type === 'teams') renderTeamsPage();
                    else renderStageContent(activeTab.dataset.index);
                } else {
                    if(tournamentData.stages.length) switchStage(0);
                    else switchTeams(); 
                }
            } catch(e) { console.error("Data Sync Error", e); }
        }

        // --- NAVIGATION ---
        function renderNav() {
            const nav = document.getElementById('mainNav');
            const currentActiveIndex = document.querySelector('.nav-tab.active')?.dataset.index;
            const currentActiveType = document.querySelector('.nav-tab.active')?.dataset.type;
            
            let html = `<button onclick="switchTeams()" class="nav-tab px-8 py-5 font-header text-xl font-bold tracking-widest uppercase flex items-center gap-2 shrink-0 ${currentActiveType === 'teams' ? 'active' : ''}" data-type="teams"><i class="fa-solid fa-users-viewfinder text-sm opacity-60"></i> ALL TEAMS</button>`;
            
            html += tournamentData.stages.map((s, i) => `
                <button onclick="switchStage(${i})" class="nav-tab px-8 py-5 font-header text-xl font-bold tracking-widest uppercase flex items-center gap-2 shrink-0 ${currentActiveType === 'stage' && currentActiveIndex == i ? 'active' : ''}" data-index="${i}" data-type="stage">
                    <span class="text-[10px] bg-white/10 px-2 py-0.5 rounded font-mono text-gray-300 border border-white/5">STAGE 0${i+1}</span> ${s.name}
                </button>`).join('');
            nav.innerHTML = html;
        }

        function switchTeams() { updateActiveTab('teams'); renderTeamsPage(); }
        function switchStage(i) { document.getElementById('tourneyName').style.opacity = '1'; updateActiveTab('stage', i); renderStageContent(i); }
        function updateActiveTab(type, index) {
            document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
            const selector = type === 'teams' ? '[data-type="teams"]' : `[data-index="${index}"]`;
            const btn = document.querySelector(selector);
            if(btn) btn.classList.add('active');
        }

        // --- TEAMS PAGE ---
        function renderTeamsPage() {
            document.getElementById('tourneyName').style.opacity = '0';
            const container = document.getElementById('contentArea');
            container.innerHTML = `
                <div class="max-w-[1800px] mx-auto animate-enter">
                    <div class="flex items-center justify-between mb-8 pb-4 border-b border-white/5">
                        <div class="flex flex-col">
                            <h2 class="font-header text-4xl text-white tracking-wide uppercase">Participating Teams</h2>
                            <p class="text-xs text-gray-500 font-mono mt-1">SEASON STATISTICS & ROSTERS</p>
                        </div>
                        <div class="font-mono text-xs text-[#ff4655] font-bold tracking-widest border border-[#ff4655]/30 px-4 py-2 bg-[#ff4655]/10 rounded-sm">
                            ${teamsData.length} UNITS REGISTERED
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                        ${teamsData.map(t => `
                            <div onclick="openTeamDetail('${t._id}')" class="broadcast-card group relative overflow-hidden cursor-pointer flex flex-col border hover:border-[#ff4655] transition-all duration-300 rounded-sm">
                                <div class="absolute top-0 left-0 w-1 h-full bg-[#ff4655] opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                <div class="p-4 flex items-center gap-4 bg-[#1a1d21]">
                                    <div class="w-16 h-16 bg-black/20 rounded flex items-center justify-center shrink-0 border border-white/5 group-hover:border-white/20 transition">
                                        <img src="${t.logo || DEFAULT_LOGO}" class="w-12 h-12 object-contain">
                                    </div>
                                    <div class="flex flex-col overflow-hidden">
                                        <h3 class="font-header text-2xl text-white font-bold uppercase truncate tracking-wide leading-none mb-1 group-hover:text-[#ff4655] transition-colors">${t.name}</h3>
                                        <div class="flex items-center gap-2 text-[10px] font-mono text-gray-500">
                                            <span class="bg-white/5 px-1.5 rounded text-gray-400">${t.shortName || 'TAG'}</span>
                                            <span>•</span>
                                            <span>${t.members?.length || 0} PLAYERS</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="px-4 py-3 bg-[#15171a] border-t border-white/5 flex justify-between items-center">
                                    <div class="flex flex-col">
                                        <span class="text-[9px] text-gray-500 font-bold uppercase tracking-wider">Record</span>
                                        <span class="font-mono text-sm text-white"><span class="text-green-400">${t.wins || 0}W</span> - <span class="text-red-400">${t.losses || 0}L</span></span>
                                    </div>
                                    <div class="opacity-0 group-hover:opacity-100 transition-opacity transform translate-x-2 group-hover:translate-x-0 duration-300">
                                        <i class="fa-solid fa-arrow-right text-gray-500 hover:text-white"></i>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
        }

        // --- STAGE CONTROLLER ---
        function renderStageContent(i) {
            const stage = tournamentData.stages[i];
            const container = document.getElementById('contentArea');
            const ms = stage.matches.map(mid => matchesData.find(m => m._id === mid)).filter(m => m);
            
            container.innerHTML = ''; 
            
            if (stage.type === 'round_robin' || stage.type === 'swiss') {
                let stageTeams = [];
                if (stage.stageParticipants && stage.stageParticipants.length > 0) {
                    stageTeams = teamsData.filter(t => stage.stageParticipants.includes(t._id));
                } else { stageTeams = teamsData; }
                renderStandingsAndSchedule(container, ms, stage.type, stageTeams);
            } else {
                // Supports Single, Double, Triple Elim & GSL
                renderBracket(container, ms, stage.type);
            }
        }

        // --- BRACKET RENDERER (Updated for Triple Elim) ---
        function renderBracket(container, matches, stageType) {
            const upper = [], middle = [], lower = [], final = [];

            // Logic matching bracketManager.js
            matches.forEach(m => {
                if (m.matchOrder === 999 || m.round === 999) final.push(m);
                else if (m.round >= 200) lower.push(m); // Lower/Last Chance Bracket
                else if (m.round >= 100) middle.push(m); // Middle Bracket
                else upper.push(m); // Upper Bracket
            });

            const groupByRound = (arr, roundOffset = 0) => {
                const map = {};
                arr.forEach(m => {
                    const r = m.round;
                    if(!map[r]) map[r] = [];
                    map[r].push(m);
                });
                return Object.keys(map).sort((a,b)=>a-b).map(k => ({ 
                    round: k, 
                    displayRound: k - roundOffset,
                    matches: map[k].sort((a,b)=>a.matchOrder-b.matchOrder) 
                }));
            };

            const createSection = (rounds, title, colorClass, iconClass) => {
                if(!rounds.length) return '';
                return `
                <div class="mb-8 border-b border-white/5 pb-6 last:border-0 relative bracket-section">
                    <div class="flex items-center gap-3 mb-4 sticky left-0 relative z-10">
                        <div class="w-1 h-6 ${colorClass} shadow-[0_0_15px_currentColor]"></div>
                        <h3 class="text-xl font-header text-white tracking-widest italic drop-shadow uppercase flex items-center gap-3">
                            <i class="${iconClass} text-sm opacity-50"></i> ${title}
                        </h3>
                    </div>
                    <div class="flex gap-8 pb-2 relative z-10">
                        ${rounds.map(r => `
                            <div class="flex flex-col gap-2 w-[220px] shrink-0 relative">
                                <div class="mb-1 text-[9px] text-gray-500 font-bold uppercase tracking-[0.2em] flex items-center gap-2">
                                    <span class="w-1.5 h-1.5 rounded-full bg-white/10"></span> Round ${r.displayRound}
                                </div>
                                ${r.matches.map(m => createMatchCard(m)).join('')}
                            </div>
                        `).join('')}
                    </div>
                </div>`;
            };

            // Structure: Upper -> Middle -> Lower -> Finals
            // We use a wide container for horizontal scrolling of deep brackets
            container.innerHTML = `
            <div class="w-full h-full overflow-x-auto custom-scroll p-4 animate-enter">
                <div class="min-w-max pl-6 pr-20 flex flex-col gap-4">
                    
                    ${createSection(groupByRound(upper), 'UPPER BRACKET', 'bg-[#ff4655]', 'fa-solid fa-arrow-up')}
                    
                    ${createSection(groupByRound(middle, 100), stageType === 'triple_elim' ? 'MIDDLE BRACKET' : 'LOWER BRACKET', 'bg-[#dda828]', 'fa-solid fa-arrow-right')}
                    
                    ${createSection(groupByRound(lower, 200), 'LAST CHANCE BRACKET', 'bg-[#00d4ff]', 'fa-solid fa-turn-up')}
                    
                    ${final.length ? `
                    <div class="mt-6 pt-6 border-t border-white/10 relative">
                        <div class="absolute -top-2.5 left-10 bg-[#0f1923] px-3 text-[#ff4655] font-header text-xs tracking-widest uppercase">CHAMPIONSHIP MATCH</div>
                        <div class="flex items-center gap-8">
                            ${groupByRound(final).map(r => `
                                <div class="flex flex-col gap-2 w-[260px] shrink-0">
                                     ${r.matches.map(m => createMatchCard(m, true)).join('')}
                                </div>
                            `).join('')}
                        </div>
                    </div>` : ''}

                </div>
            </div>`;
        }

        // --- COMPONENT: MATCH CARD ---
        function createMatchCard(m, isFinal = false) {
            const [sA, sB] = calculateScores(m.scores);
            const isLive = m.status === 'live';
            const isFinished = m.status === 'finished';
            const format = m.format || 'BO3';
            
            let timeDisplay = 'TBD';
            if (m.scheduledTime) {
                const d = new Date(m.scheduledTime);
                timeDisplay = d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                if (d.toDateString() !== new Date().toDateString()) {
                    timeDisplay = d.toLocaleDateString([], {month:'short', day:'numeric'}) + ' ' + timeDisplay;
                }
            }
            
            let statusText = timeDisplay;
            let statusClass = 'text-gray-500';
            if (isLive) { statusText = 'LIVE'; statusClass = 'text-[#ff4655] font-bold animate-pulse'; }
            else if (isFinished) { statusText = 'Final'; statusClass = 'text-gray-500'; }

            // Logic for winners
            const winA = m.winner && String(m.winner._id || m.winner) === String(m.teamA?._id);
            const winB = m.winner && String(m.winner._id || m.winner) === String(m.teamB?._id);

            // Progression Logic
            const getMatchLabel = (id) => {
                const target = matchesData.find(x => x._id === id);
                if (!target) return 'TBD';
                return target.name.replace(/Upper Bracket/i, 'UB').replace(/Lower Bracket/i, 'LB').replace(/Round /i, 'R').replace(/Match /i, 'M');
            };
            const nextWin = m.nextMatchId ? getMatchLabel(m.nextMatchId) : null;
            const nextLose = m.loserMatchId ? getMatchLabel(m.loserMatchId) : null;

            const renderTeam = (team, score, isWinner) => {
                const name = team ? team.name : 'TBD';
                const logo = team ? team.logo : null;
                const teamId = team ? team._id : '';
                const scoreClass = isWinner ? 'text-[#ff4655] font-bold' : (team ? 'text-white' : 'text-gray-600');
                const opacity = (isFinished && !isWinner) ? 'opacity-60' : 'opacity-100';
                const fontWeight = isWinner ? 'font-bold' : 'font-medium';

                return `
                <div class="flex justify-between items-center h-7 px-2.5 ${opacity} transition-colors hover:bg-white/5" ${teamId ? `onmouseenter="highlightTeam('${teamId}')" onmouseleave="resetHighlight()"` : ''}>
                    <div class="flex items-center gap-2 overflow-hidden">
                        ${logo ? `<img src="${logo}" class="w-3.5 h-3.5 object-contain">` : '<div class="w-3.5 h-3.5 bg-white/10 rounded-full"></div>'}
                        <span class="${fontWeight} text-xs text-white truncate tracking-wide">${name}</span>
                    </div>
                    <span class="font-mono text-sm ${scoreClass}">${team ? score : '-'}</span>
                </div>`;
            };

            return `
            <div onclick="openMatchDetail('${m._id}')" data-id="${m._id}" data-next="${m.nextMatchId||''}" class="match-card-el broadcast-card rounded-sm overflow-hidden cursor-pointer relative group ${isFinal ? 'scale-105 shadow-2xl border-purple-500/30' : ''} hover:border-[#ff4655] transition-all duration-300">
                <div class="flex justify-between items-center px-2.5 py-1.5 bg-[#15171a] border-b border-white/5">
                     <div class="flex items-center gap-2">
                        ${isLive ? `<span class="w-1.5 h-1.5 rounded-full bg-[#ff4655] shadow-[0_0_8px_#ff4655]"></span>` : ''}
                        <span class="text-[9px] font-bold text-gray-500 uppercase tracking-wider truncate max-w-[120px] group-hover:text-white transition-colors">${m.name || 'Match'}</span>
                        <span class="text-[8px] px-1 rounded bg-white/5 text-gray-500 border border-white/5 font-mono">${format}</span>
                     </div>
                     <span class="text-[10px] font-mono ${statusClass}">${statusText}</span>
                </div>
                <div class="py-1 bg-gradient-to-b from-[#1a1d21] to-[#15171a]">
                    ${renderTeam(m.teamA, sA, winA)}
                    ${renderTeam(m.teamB, sB, winB)}
                </div>
                ${(nextWin || nextLose) ? `
                <div class="mt-0.5 pt-1 border-t border-white/5 flex justify-between items-center px-2.5 pb-1 text-[8px] font-mono text-gray-500">
                    ${nextWin ? `<div class="flex items-center gap-1"><span class="text-green-500/70 font-bold">W:</span> <span>${nextWin}</span></div>` : '<div></div>'}
                    ${nextLose ? `<div class="flex items-center gap-1"><span class="text-red-500/70 font-bold">L:</span> <span>${nextLose}</span></div>` : ''}
                </div>` : ''}
                ${isFinal ? '<div class="absolute -top-1 -right-1 w-3 h-3 bg-purple-500 rounded-full animate-ping"></div>' : ''}
            </div>`;
        }

        // --- ROUND ROBIN RENDERER (Keep existing logic) ---
        function calculateDetailedStats(matches, teams) {
            const stats = {};
            teams.forEach(t => stats[t._id] = { id: t._id, name: t.name, logo: t.logo, w:0, l:0, pts:0, mapW:0, mapL:0, mapDiff:0, roundsWon:0, roundsLost:0, roundDiff:0, matchesPlayed: 0, h2hResults: {} });

            matches.forEach(m => {
                if(m.status === 'finished' && m.winner) {
                    const idA = m.teamA?._id; const idB = m.teamB?._id;
                    if(!stats[idA] || !stats[idB]) return;
                    stats[idA].matchesPlayed++; stats[idB].matchesPlayed++;
                    const winnerId = m.winner._id || m.winner;
                    const [scoreA, scoreB] = calculateScores(m.scores);
                    if(String(winnerId) === String(idA)) { 
                        stats[idA].w++; stats[idA].pts += 1; stats[idB].l++; 
                        stats[idA].h2hResults[idB] = { win: true }; stats[idB].h2hResults[idA] = { win: false };
                    } else { 
                        stats[idB].w++; stats[idB].pts += 1; stats[idA].l++; 
                        stats[idB].h2hResults[idA] = { win: true }; stats[idA].h2hResults[idB] = { win: false };
                    }
                    stats[idA].mapW += scoreA; stats[idA].mapL += scoreB;
                    stats[idB].mapW += scoreB; stats[idB].mapL += scoreA;
                    if(m.scores) {
                        m.scores.forEach(s => {
                            const rA = parseInt(s.teamAScore) || 0; const rB = parseInt(s.teamBScore) || 0;
                            stats[idA].roundsWon += rA; stats[idA].roundsLost += rB;
                            stats[idB].roundsWon += rB; stats[idB].roundsLost += rA;
                        });
                    }
                }
            });
            Object.values(stats).forEach(s => { s.mapDiff = s.mapW - s.mapL; s.roundDiff = s.roundsWon - s.roundsLost; });
            return Object.values(stats).sort((a, b) => {
                if (b.pts !== a.pts) return b.pts - a.pts;
                if (a.h2hResults[b.id]) return a.h2hResults[b.id].win ? -1 : 1;
                if (b.mapDiff !== a.mapDiff) return b.mapDiff - a.mapDiff;
                return b.roundDiff - a.roundDiff;
            });
        }

        function renderStandingsAndSchedule(container, matches, type, participants) {
            const stats = calculateDetailedStats(matches, participants);
            const rounds = {};
            matches.forEach(m => { const r = m.round || 1; if(!rounds[r]) rounds[r] = []; rounds[r].push(m); });
            const sortedRounds = Object.keys(rounds).sort((a,b) => parseInt(a)-parseInt(b));

            let scheduleHtml = sortedRounds.map(r => `
                <div class="mb-6 last:mb-0">
                    <div class="flex items-center gap-3 mb-2 pl-1 border-b border-white/5 pb-1">
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest">${type === 'round_robin' ? 'Round' : 'Round'} 0${r}</h3>
                    </div>
                    <div class="flex flex-col gap-2">
                    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3">
                        ${rounds[r].map(m => createMatchCard(m)).join('')}
                    </div>
                </div>
            `).join('');

            if(matches.length === 0) scheduleHtml = `<div class="p-12 border border-dashed border-white/10 rounded text-center text-gray-600 font-mono text-sm uppercase">Pending Schedule Generation...</div>`;

            container.innerHTML = `
            <div class="max-w-[1920px] mx-auto animate-enter grid grid-cols-1 lg:grid-cols-12 gap-8 h-full">
                <div class="lg:col-span-5 xl:col-span-4 flex flex-col h-full">
                    <div class="broadcast-card rounded-sm overflow-hidden flex-1 flex flex-col sticky top-0 border-t-4 border-t-[#ff4655]">
                        <div class="p-6 bg-gradient-to-r from-[#1a1d21] to-[#15171a] border-b border-white/10 flex justify-between items-center">
                            <span class="text-2xl font-header text-white tracking-wide italic">GROUP STANDINGS</span>
                            <i class="fa-solid fa-ranking-star text-[#ff4655] text-xl"></i>
                        </div>
                        <div class="overflow-x-auto flex-1">
                            <table class="standings-table w-full text-left">
                                <thead class="bg-[#111]">
                                    <tr>
                                        <th class="text-center w-10">#</th>
                                        <th>TEAM</th>
                                        <th class="text-center text-white" title="Wins - Losses">W-L</th>
                                        <th class="text-center hidden sm:table-cell" title="Maps Won - Lost">MAP</th>
                                        <th class="text-center" title="Map Difference">MAPΔ</th>
                                        <th class="text-center hidden md:table-cell" title="Round Difference">RΔ</th>
                                    </tr>
                                </thead>
                                <tbody class="text-gray-300">
                                    ${stats.map((s, idx) => `
                                        <tr class="rank-${idx+1}">
                                            <td class="text-center font-mono font-bold text-gray-500">${idx+1}</td>
                                            <td class="font-bold">
                                                <div class="flex items-center gap-4">
                                                    <img src="${s.logo || DEFAULT_LOGO}" class="w-8 h-8 object-contain drop-shadow">
                                                    <div class="flex flex-col">
                                                        <span class="uppercase tracking-tight leading-none text-white text-lg font-header">${s.name || 'Unknown'}</span>
                                                        <span class="text-[9px] text-gray-500 font-mono hidden md:block mt-0.5">PTS: ${s.pts}</span>
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="text-center font-mono font-bold text-lg text-white">${s.w}-${s.l}</td>
                                            <td class="text-center font-mono text-xs text-gray-400 hidden sm:table-cell">${s.mapW}-${s.mapL}</td>
                                            <td class="text-center font-mono font-bold text-sm ${getColor(s.mapDiff)}">${s.mapDiff>0?'+':''}${s.mapDiff}</td>
                                            <td class="text-center font-mono text-xs text-gray-400 hidden md:table-cell ${getColor(s.roundDiff)}">${s.roundDiff>0?'+':''}${s.roundDiff}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-7 xl:col-span-8 overflow-y-auto pr-2 custom-scroll">
                     ${scheduleHtml}
                </div>
            </div>`;
        }

        // --- UTILS & MODALS (Reused) ---
        function calculateScores(scores) {
            if (!scores) return [0,0];
            let a=0,b=0; 
            scores.forEach(s=>{ 
                const sa = parseInt(s.teamAScore)||0;
                const sb = parseInt(s.teamBScore)||0;
                if(sa > sb) a++; else if(sb > sa) b++; 
            }); 
            return [a,b]; 
        }

        function getColor(val) {
            if(val > 0) return 'text-green-400';
            if(val < 0) return 'text-[#ff4655]';
            return 'text-gray-500';
        }

        // Team Modal
        function openTeamDetail(teamId) {
            const team = teamsData.find(t => t._id === teamId);
            if (!team) return;
            
            // Filter matches for this team
            const teamMatches = matchesData.filter(m => 
                (m.teamA && m.teamA._id === teamId) || (m.teamB && m.teamB._id === teamId)
            ).sort((a, b) => new Date(b.scheduledTime || 0) - new Date(a.scheduledTime || 0));

            // Calculate stats
            const totalMatches = teamMatches.filter(m => m.status === 'finished').length;
            const wins = team.wins || 0;
            const losses = team.losses || 0;
            const winRate = totalMatches > 0 ? Math.round((wins / totalMatches) * 100) : 0;

            // Render Match History HTML
            const historyHtml = teamMatches.map(m => {
                const isA = m.teamA && m.teamA._id === teamId;
                const opponent = isA ? m.teamB : m.teamA;
                const [sA, sB] = calculateScores(m.scores);
                const myScore = isA ? sA : sB;
                const oppScore = isA ? sB : sA;
                
                let resultClass = 'border-l-4 border-gray-600';
                let resultText = 'SCHEDULED';
                let scoreColor = 'text-gray-400';

                if (m.status === 'finished') {
                    if (myScore > oppScore) { resultClass = 'border-l-4 border-green-500 bg-green-500/5'; resultText = 'VICTORY'; scoreColor = 'text-green-400'; } 
                    else { resultClass = 'border-l-4 border-red-500 bg-red-500/5'; resultText = 'DEFEAT'; scoreColor = 'text-red-400'; }
                } else if (m.status === 'live') {
                    resultClass = 'border-l-4 border-[#ff4655] bg-[#ff4655]/5'; resultText = 'LIVE'; scoreColor = 'text-[#ff4655]';
                }

                const dateStr = m.scheduledTime ? new Date(m.scheduledTime).toLocaleDateString() : 'TBD';

                return `
                <div onclick="openMatchDetail('${m._id}')" class="flex items-center justify-between p-4 bg-[#15171a] border border-white/5 rounded mb-2 cursor-pointer hover:bg-[#1a1d21] transition ${resultClass}">
                    <div class="flex flex-col">
                        <span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">${resultText}</span>
                        <span class="text-xs text-gray-400 font-mono">${dateStr}</span>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="font-header text-xl text-white ${scoreColor}">${myScore}</span>
                        <span class="text-gray-600 font-mono">-</span>
                        <span class="font-header text-xl text-white ${m.status === 'finished' && oppScore > myScore ? 'text-green-400' : 'text-gray-400'}">${oppScore}</span>
                    </div>
                    <div class="flex items-center gap-3 w-32 justify-end">
                        <span class="font-bold text-sm text-gray-300 truncate">${opponent ? opponent.name : 'TBD'}</span>
                        <img src="${opponent ? (opponent.logo || DEFAULT_LOGO) : DEFAULT_LOGO}" class="w-8 h-8 object-contain">
                    </div>
                </div>`;
            }).join('');

            document.getElementById('teamModalContent').innerHTML = `
                <div class="flex flex-col gap-8">
                    <div class="flex items-center gap-8 pb-8 border-b border-white/10">
                        <img src="${team.logo || DEFAULT_LOGO}" class="w-32 h-32 object-contain bg-black/20 rounded-lg border border-white/5 p-2">
                        <div>
                            <h2 class="text-6xl font-header text-white leading-none mb-2">${team.name}</h2>
                            <div class="flex items-center gap-4 text-sm font-mono text-gray-400">
                                <span class="bg-white/10 px-2 py-0.5 rounded text-white">${team.shortName}</span>
                                <span>•</span>
                                <span>${team.members.length} Active Players</span>
                            </div>
                        </div>
                        <div class="ml-auto flex gap-4 text-center">
                            <div class="bg-[#15171a] p-4 rounded border border-white/5 min-w-[100px]"><div class="text-3xl font-header text-white">${wins}</div><div class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Wins</div></div>
                            <div class="bg-[#15171a] p-4 rounded border border-white/5 min-w-[100px]"><div class="text-3xl font-header text-white">${losses}</div><div class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Losses</div></div>
                            <div class="bg-[#15171a] p-4 rounded border border-white/5 min-w-[100px]"><div class="text-3xl font-header text-[#ff4655]">${winRate}%</div><div class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Win Rate</div></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-1">
                            <h3 class="font-header text-xl text-white mb-4 flex items-center gap-2"><i class="fa-solid fa-users text-[#ff4655]"></i> Active Roster</h3>
                            <div class="flex flex-col gap-2">
                                ${team.members.map(m => `<div class="bg-[#15171a] p-3 border border-white/5 flex justify-between items-center"><div><div class="font-bold text-white">${m.name}</div><div class="text-[10px] font-mono text-gray-500">#${m.tag}</div></div><span class="text-[10px] font-bold uppercase tracking-widest px-2 py-1 rounded ${m.role === 'Main' ? 'bg-[#1fa474]/10 text-[#1fa474]' : 'bg-gray-700/20 text-gray-500'}">${m.role}</span></div>`).join('')}
                            </div>
                        </div>
                        <div class="lg:col-span-2">
                            <h3 class="font-header text-xl text-white mb-4 flex items-center gap-2"><i class="fa-solid fa-clock-rotate-left text-[#ff4655]"></i> Match History</h3>
                            <div class="flex flex-col gap-1 max-h-[500px] overflow-y-auto custom-scroll pr-2">
                                ${historyHtml || '<div class="text-gray-500 italic p-4 text-center">No matches recorded.</div>'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('teamModal').classList.remove('hidden');
            document.getElementById('teamModal').classList.add('flex');
        }
        function closeTeamModal() { document.getElementById('teamModal').classList.add('hidden'); document.getElementById('teamModal').classList.remove('flex'); }

        // Match Modal (Detail View)
        function openMatchDetail(matchId) {
            const m = matchesData.find(x => x._id === matchId);
            if (!m) return;
            const [sA, sB] = calculateScores(m.scores);
            const content = document.getElementById('modalContent');
            const isLive = m.status === 'live';
            
            let mapsList = m.scores;
            if ((!mapsList || mapsList.length === 0) && m.vetoData && m.vetoData.pickedMaps && m.vetoData.pickedMaps.length > 0) {
                mapsList = m.vetoData.pickedMaps.map(p => ({
                    mapName: p.map,
                    teamAScore: 0,
                    teamBScore: 0
                }));
            }

            content.innerHTML = `
                <div class="bg-[#0f1113] p-4 flex justify-between items-center border-b border-white/10">
                    <div class="flex items-center gap-4">
                        <span class="text-xs bg-white/5 text-gray-300 px-3 py-1 font-bold uppercase tracking-widest border border-white/10">${m.name}</span>
                        <span class="text-xs text-[#ff4655] font-mono tracking-widest">${new Date(m.scheduledTime).toLocaleDateString()}</span>
                    </div>
                    <button onclick="closeMatchModal()" class="text-gray-500 hover:text-white transition"><i class="fa-solid fa-xmark text-2xl"></i></button>
                </div>
                <div class="relative py-16 px-8 overflow-hidden bg-[#1a1d21]">
                    <div class="flex items-center justify-center gap-10">
                        <div class="flex flex-col items-center gap-2 w-1/3">
                            <img src="${m.teamA?.logo || DEFAULT_LOGO}" class="w-32 h-32 object-contain">
                            <h3 class="font-header text-3xl text-white uppercase text-center">${m.teamA?.name || 'TBD'}</h3>
                        </div>
                        <div class="flex flex-col items-center">
                            <div class="font-header text-7xl text-white font-bold flex gap-4">
                                <span class="${sA > sB ? 'text-[#ff4655]' : ''}">${sA}</span>
                                <span class="text-gray-600">-</span>
                                <span class="${sB > sA ? 'text-[#ff4655]' : ''}">${sB}</span>
                            </div>
                            <div class="mt-2 text-xs font-bold uppercase tracking-[0.2em] ${isLive ? 'text-[#ff4655] animate-pulse' : 'text-gray-500'}">
                                ${isLive ? 'LIVE NOW' : m.status}
                            </div>
                        </div>
                        <div class="flex flex-col items-center gap-2 w-1/3">
                            <img src="${m.teamB?.logo || DEFAULT_LOGO}" class="w-32 h-32 object-contain">
                            <h3 class="font-header text-3xl text-white uppercase text-center">${m.teamB?.name || 'TBD'}</h3>
                        </div>
                    </div>
                </div>
                <div class="p-8 bg-[#1a1d21] border-t border-white/10 grid grid-cols-1 gap-2">
                     ${(mapsList||[]).map((s,i) => `
                        <div class="bg-black/20 p-3 flex justify-between items-center border-l-2 border-white/10">
                            <span class="text-xs text-gray-500 uppercase tracking-widest">MAP ${i+1}: ${s.mapName || 'VETO'}</span>
                            <div class="font-header text-white text-xl">
                                <span class="${parseInt(s.teamAScore) > parseInt(s.teamBScore) ? 'text-[#ff4655]' : ''}">${s.teamAScore}</span>
                                <span class="px-2 text-gray-600">:</span>
                                <span class="${parseInt(s.teamBScore) > parseInt(s.teamAScore) ? 'text-[#ff4655]' : ''}">${s.teamBScore}</span>
                            </div>
                        </div>
                     `).join('')}
                </div>
            `;
            document.getElementById('matchModal').classList.remove('hidden');
            document.getElementById('matchModal').classList.add('flex');
        }
        function closeMatchModal() { document.getElementById('matchModal').classList.add('hidden'); document.getElementById('matchModal').classList.remove('flex'); }

        window.addEventListener('keydown', (e) => { if(e.key === 'Escape') { closeMatchModal(); closeTeamModal(); } });

        function highlightTeam(teamId) {
            if (!teamId) return;
            const teamMatches = new Set();
            matchesData.forEach(m => {
                if ((m.teamA && m.teamA._id === teamId) || (m.teamB && m.teamB._id === teamId)) {
                    teamMatches.add(m._id);
                }
            });

            document.querySelectorAll('.match-card-el').forEach(card => {
                if (teamMatches.has(card.dataset.id)) {
                    card.classList.add('ring-1', 'ring-[#ff4655]', 'bg-[#252e38]', 'z-10');
                    card.classList.remove('opacity-40');
                } else {
                    card.classList.add('opacity-40');
                    card.classList.remove('ring-1', 'ring-[#ff4655]', 'bg-[#252e38]', 'z-10');
                }
            });
        }

        function resetHighlight() {
            document.querySelectorAll('.match-card-el').forEach(card => card.classList.remove('ring-1', 'ring-[#ff4655]', 'bg-[#252e38]', 'opacity-40', 'z-10'));
        }
    </script>
</body>
</html>