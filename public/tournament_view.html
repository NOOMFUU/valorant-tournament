<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tournament Bracket | VLR Style</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Oswald:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #0f1923; color: #ece8e1; font-family: 'Inter', sans-serif; overflow: hidden; }
        .font-header { font-family: 'Oswald', sans-serif; text-transform: uppercase; }
        .font-mono { font-family: 'Courier New', monospace; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f1923; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #ff4655; }

        /* Bracket Specifics */
        .bracket-viewport { cursor: grab; background-image: radial-gradient(#2d3139 1px, transparent 1px); background-size: 30px 30px; }
        .bracket-viewport:active { cursor: grabbing; }
        
        .match-node {
            width: 280px;
            background: #1a1d21;
            border: 1px solid #2d3139;
            position: relative;
            z-index: 10;
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
        }
        .match-node:hover { border-color: #ff4655; transform: translateY(-4px); box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 50; }
        .match-node.live { border-left: 4px solid #ff4655; box-shadow: 0 0 20px rgba(255, 70, 85, 0.15); }
        
        .bracket-column {
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            min-width: 320px;
            padding: 40px 0;
            position: relative;
        }

        /* SVG Lines Layer */
        #bracketSvg {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 0;
        }
        path.connector {
            fill: none;
            stroke: #444;
            stroke-width: 2;
            opacity: 0.6;
        }
        path.connector.highlight { stroke: #ff4655; opacity: 1; stroke-width: 4; filter: drop-shadow(0 0 5px #ff4655); }

        /* Tabs */
        .nav-tab {
            padding: 12px 24px;
            font-family: 'Oswald', sans-serif;
            font-weight: bold;
            color: #8b978f;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            cursor: pointer;
        }
        .nav-tab:hover { color: white; }
        .nav-tab.active { color: #ff4655; border-bottom-color: #ff4655; }

        /* Table */
        .vlr-table th { text-align: left; padding: 10px; font-size: 12px; color: #8b978f; text-transform: uppercase; border-bottom: 1px solid #333; }
        .vlr-table td { padding: 10px; border-bottom: 1px solid #222; font-size: 14px; }
        .vlr-table tr:hover td { background: rgba(255,255,255,0.03); }

        /* Highlight Styles */
        .match-node.dimmed { opacity: 0.3; }
        .match-node.highlight-team { opacity: 1; border-color: #ff4655; box-shadow: 0 0 25px rgba(255, 70, 85, 0.3); z-index: 20; }
        path.connector.dimmed { opacity: 0.1; }
        path.connector.highlight-path { stroke: #ff4655; opacity: 1; stroke-width: 3; }

        /* Modal Animation */
        .animate-enter { animation: slideUp 0.3s ease-out forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Team Card */
        .team-card { transition: all 0.2s; cursor: pointer; }
        .team-card:hover { background: #25282e; }
        .roster-row { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .roster-row.open { max-height: 300px; overflow-y: auto; }

        /* Liquipedia Style Overrides */
        .lp-grid { display: grid; grid-template-columns: repeat(1, 1fr); gap: 1rem; }
        @media (min-width: 640px) { .lp-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (min-width: 1024px) { .lp-grid { grid-template-columns: repeat(4, 1fr); } }
    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- Header -->
    <header class="h-20 bg-[#111] border-b border-[#222] flex items-center px-8 shrink-0 z-20 shadow-lg">
        <div class="flex items-center gap-4 mr-12">
            <div class="w-10 h-10 bg-[#ff4655] flex items-center justify-center rounded">
                <i class="fa-solid fa-trophy text-white text-xl"></i>
            </div>
            <div>
                <h1 class="text-2xl font-header tracking-wide text-white leading-none" id="tourneyTitle">LOADING...</h1>
                <div class="text-[10px] text-gray-500 font-bold uppercase tracking-widest">Tournament Bracket View</div>
            </div>
        </div>
        <nav id="stageTabs" class="flex h-full overflow-x-auto no-scrollbar"></nav>
        <button onclick="toggleFullScreen()" class="ml-auto text-gray-500 hover:text-white transition px-8"><i class="fa-solid fa-expand text-xl"></i></button>
    </header>

    <!-- Main Content -->
    <main class="flex-1 relative overflow-hidden bg-[#0f1923]" id="mainContainer">
        <div id="contentArea" class="w-full h-full">
            <!-- Dynamic Content Injected Here -->
        </div>
        
        <!-- Zoom Controls -->
        <div id="zoomControls" class="absolute bottom-8 right-8 flex flex-col gap-2 z-50 hidden">
            <button onclick="zoomIn()" class="w-10 h-10 bg-[#1a1d21] border border-[#333] text-white hover:bg-[#ff4655] hover:border-[#ff4655] rounded flex items-center justify-center transition shadow-lg"><i class="fa-solid fa-plus"></i></button>
            <button onclick="zoomReset()" class="w-10 h-10 bg-[#1a1d21] border border-[#333] text-white hover:bg-[#ff4655] hover:border-[#ff4655] rounded flex items-center justify-center transition shadow-lg"><i class="fa-solid fa-compress"></i></button>
            <button onclick="zoomOut()" class="w-10 h-10 bg-[#1a1d21] border border-[#333] text-white hover:bg-[#ff4655] hover:border-[#ff4655] rounded flex items-center justify-center transition shadow-lg"><i class="fa-solid fa-minus"></i></button>
        </div>
    </main>

    <div id="matchModal" class="fixed inset-0 z-[200] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-sm transition-opacity" onclick="closeMatchModal()"></div>
        <div class="relative w-full max-w-4xl bg-[#1a1d21] border border-[#333] rounded shadow-2xl overflow-hidden animate-enter">
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
        const API_BASE = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') && window.location.port !== '3000' ? 'http://localhost:3000' : '';
        const socket = io(API_BASE || undefined);
        
        let tournamentData = null;
        let matchesData = [];
        let teamsData = [];
        let activeView = 'overview';
        let activeStageIndex = 0;
        
        // Zoom/Pan State
        let scale = 1;
        let panning = false;
        let pointX = 0, pointY = 0, startX = 0, startY = 0;
        let translateX = 0, translateY = 0;
        const ZOOM_SPEED = 0.1;

        // --- INITIALIZATION ---
        async function init() {
            try {                
                const [tRes, mRes, tmRes] = await Promise.all([
                    fetch(`${API_BASE}/api/tournaments`),
                    fetch(`${API_BASE}/api/matches`),
                    fetch(`${API_BASE}/api/teams`)
                ]);
                
                const tourneys = await tRes.json();
                matchesData = await mRes.json();
                teamsData = await tmRes.json();

                if (tourneys.length > 0) {
                    tournamentData = tourneys[0];
                    document.getElementById('tourneyTitle').innerText = tournamentData.name;
                    renderTabs();
                    renderContent();
                } else {
                    document.getElementById('contentArea').innerHTML = `<div class="flex h-full items-center justify-center text-gray-500">NO TOURNAMENT DATA</div>`;
                }
            } catch (e) { console.error(e); }
        }

        socket.on('match_update', () => init());
        socket.on('bracket_update', () => init());

        // --- TABS ---
        function renderTabs() {
            const container = document.getElementById('stageTabs');
            let html = `
                <button onclick="switchView('overview')" class="nav-tab ${activeView === 'overview' ? 'active' : ''}">Overview</button>
                <button onclick="switchView('teams')" class="nav-tab ${activeView === 'teams' ? 'active' : ''}">Teams</button>
            `;
            html += tournamentData.stages.map((s, i) => `
                <button onclick="switchStage(${i})" class="nav-tab ${i === activeStageIndex && activeView === 'stage' ? 'active' : ''}">
                    ${s.name}
                </button>
            `).join('');
            container.innerHTML = html;
        }

        function switchView(view) {
            activeView = view;
            renderTabs();
            resetPanZoom();
            renderContent();
        }

        function switchStage(index) {
            activeView = 'stage';
            activeStageIndex = index;
            renderTabs();
            resetPanZoom();
            renderContent();
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
            }
        }

        function renderContent() {
            const container = document.getElementById('contentArea');
            const zoomCtrls = document.getElementById('zoomControls');
            
            if (activeView === 'overview') renderOverview(container);
            else if (activeView === 'teams') renderTeams(container);
            else renderStage(container, activeStageIndex);
            
            if (activeView === 'stage') zoomCtrls.classList.remove('hidden');
            else zoomCtrls.classList.add('hidden');
        }

        // --- OVERVIEW ---
        function renderOverview(container) {
            const prizePool = tournamentData.prizePool || "TBA";
            const formatDesc = tournamentData.formatDescription || `
                <div class="space-y-4 text-gray-300 text-sm leading-relaxed">
                    <p><strong class="text-white">Group Stage:</strong> Two groups of four teams in a GSL format. Top two teams from each group advance to the Playoffs.</p>
                    <p><strong class="text-white">Playoffs:</strong> Double-Elimination bracket. All matches are Bo3, except for the Lower Bracket Final and Grand Final which are Bo5.</p>
                </div>
            `;

            container.innerHTML = `<div class="w-full h-full overflow-auto custom-scroll p-8">
                <div class="max-w-5xl mx-auto space-y-8 animate-enter">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="md:col-span-2 bg-[#1a1d21] border border-[#333] rounded p-6">
                            <h3 class="font-header text-xl text-white mb-4 border-l-4 border-[#ff4655] pl-3">Tournament Format</h3>
                            ${formatDesc}
                        </div>
                        <div class="bg-[#1a1d21] border border-[#333] rounded p-6">
                            <h3 class="font-header text-xl text-white mb-4 border-l-4 border-[#dda828] pl-3">Prize Pool</h3>
                            <div class="text-3xl font-header text-[#dda828] mb-2">${prizePool}</div>
                            <div class="text-xs text-gray-500 uppercase font-bold tracking-widest">Total Winnings</div>
                            
                            <div class="mt-6 space-y-2">
                                <div class="flex justify-between text-sm border-b border-[#333] pb-1"><span>1st Place</span><span class="text-white">฿ 25,000</span></div>
                                <div class="flex justify-between text-sm border-b border-[#333] pb-1"><span>2nd Place</span><span class="text-white">฿ 15,000</span></div>
                                <div class="flex justify-between text-sm border-b border-[#333] pb-1"><span>3rd Place</span><span class="text-white">฿ 7,000</span></div>
                                <div class="flex justify-between text-sm border-b border-[#333] pb-1"><span>4th Place</span><span class="text-white">฿ 3,000</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        // --- TEAMS ---
        function renderTeams(container) {
            container.innerHTML = `<div class="w-full h-full overflow-auto custom-scroll p-8">
                <div class="max-w-7xl mx-auto animate-enter">
                    <!-- Header -->
                    <div class="flex items-center justify-between mb-6 border-b border-[#333] pb-4">
                        <div class="flex items-baseline gap-4">
                            <h2 class="text-3xl font-header text-white tracking-wide">PARTICIPANTS</h2>
                            <span class="text-xs text-[#ff4655] font-bold uppercase tracking-widest cursor-pointer hover:text-white transition">[EDIT]</span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="toggleAllRosters()" id="btnShowPlayers" class="bg-[#1a1d21] border border-[#333] text-gray-400 hover:text-white hover:border-[#ff4655] px-4 py-1.5 rounded text-xs font-bold uppercase transition">Show Players</button>
                            <button class="bg-[#1a1d21] border border-[#333] text-gray-400 hover:text-white hover:border-[#ff4655] px-4 py-1.5 rounded text-xs font-bold uppercase transition">Player Info</button>
                        </div>
                    </div>

                    <!-- Sub Header -->
                    <div class="flex items-center gap-2 mb-4">
                        <div class="w-1 h-4 bg-[#ff4655]"></div>
                        <h3 class="text-white text-sm font-bold uppercase tracking-widest">Invited Teams</h3>
                    </div>

                    <!-- Grid Container -->
                    <div class="lp-grid">
                        ${teamsData.map(t => createLiquipediaCard(t)).join('')}
                    </div>
                </div>
            </div>`;
        }

        function createLiquipediaCard(t) {
            return `
                <div class="bg-[#1a1d21] border border-[#333] flex flex-col h-full shadow-lg hover:border-[#ff4655] transition-colors group">
                    <!-- Top: Name -->
                    <div class="bg-[#222] border-b border-[#333] p-2 text-center h-10 flex items-center justify-center">
                        <a href="#" class="text-white font-bold hover:text-[#ff4655] text-sm truncate px-2 transition-colors">${t.name}</a>
                    </div>
                    
                    <!-- Middle: Logo/Roster (Interactive) -->
                    <div class="relative h-64 bg-[#0f1113] border-b border-[#333] cursor-pointer overflow-hidden" onclick="toggleLPRoster('${t._id}')">
                        <!-- Logo View -->
                        <div class="absolute inset-0 flex items-center justify-center transition-opacity duration-300" id="lp-logo-${t._id}">
                            <img src="${t.logo || 'https://via.placeholder.com/100'}" class="max-h-[70%] max-w-[70%] object-contain opacity-80 group-hover:opacity-100 transition-opacity">
                        </div>
                        
                        <!-- Roster View -->
                        <div class="absolute inset-0 flex flex-col bg-[#0f1113] opacity-0 transition-opacity duration-300 pointer-events-none" id="lp-roster-${t._id}">
                            <div class="flex-1 overflow-y-auto">
                                ${(t.members || []).map(m => {
                                    let roleColor = 'text-gray-500'; let roleText = 'M';
                                    if(m.role === 'Main') { roleColor = 'text-[#1fa474]'; roleText = 'M'; }
                                    else if(m.role === 'Sub') { roleColor = 'text-[#dda828]'; roleText = 'S'; }
                                    else if(m.role === 'Coach') { roleColor = 'text-[#ff4655]'; roleText = 'C'; }
                                    return `<div class="flex items-center px-3 py-1.5 border-b border-[#222] hover:bg-[#1a1d21] transition-colors w-full"><span class="${roleColor} font-bold text-[9px] w-4 text-center mr-2 bg-[#1a1d21] rounded-sm border border-[#333]">${roleText}</span><span class="text-gray-300 text-[10px] font-bold truncate">${m.name}</span></div>`;
                                }).join('')}
                                ${(t.members || []).length === 0 ? '<div class="text-center text-gray-600 text-xs italic py-8">No Roster</div>' : ''}
                            </div>
                            <div class="p-1 text-center text-[9px] text-gray-600 bg-[#15171a] border-t border-[#222]">
                                <i class="fa-solid fa-rotate-left"></i> Tap to see logo
                            </div>
                        </div>
                    </div>

                    <!-- Bottom: Info -->
                    <div class="bg-[#222] p-1 text-center text-[10px] text-gray-500 h-8 flex items-center justify-center font-mono uppercase tracking-wider">
                        ${t.shortName || 'INVITED'}
                    </div>
                </div>
            `;
        }

        function toggleLPRoster(tid) {
            const logo = document.getElementById(`lp-logo-${tid}`);
            const roster = document.getElementById(`lp-roster-${tid}`);
            
            if (logo.classList.contains('opacity-0')) {
                logo.classList.remove('opacity-0');
                roster.classList.add('opacity-0');
                roster.classList.add('pointer-events-none');
            } else {
                logo.classList.add('opacity-0');
                roster.classList.remove('opacity-0');
                roster.classList.remove('pointer-events-none');
            }
        }

        let areRostersVisible = false;
        function toggleAllRosters() {
            areRostersVisible = !areRostersVisible;
            const btn = document.getElementById('btnShowPlayers');
            if(btn) {
                btn.innerText = areRostersVisible ? "Hide Players" : "Show Players";
                btn.classList.toggle('text-white', areRostersVisible);
                btn.classList.toggle('border-[#ff4655]', areRostersVisible);
            }

            teamsData.forEach(t => {
                const logo = document.getElementById(`lp-logo-${t._id}`);
                const roster = document.getElementById(`lp-roster-${t._id}`);
                if(logo && roster) {
                    if (areRostersVisible) {
                        logo.classList.add('opacity-0');
                        roster.classList.remove('opacity-0', 'pointer-events-none');
                    } else {
                        logo.classList.remove('opacity-0');
                        roster.classList.add('opacity-0', 'pointer-events-none');
                    }
                }
            });
        }

        // --- STAGE RENDERER ---
        function renderStage(container, index) {
            const stage = tournamentData.stages[index];
            const stageMatches = stage.matches.map(mid => matchesData.find(m => m._id === mid)).filter(m => m);

            if (stage.type === 'round_robin' || stage.type === 'swiss' || stage.type === 'cross_group') {
                if (stage.type === 'cross_group') {
                    renderCrossGroupStage(container, stage, stageMatches);
                    return;
                }
                renderGroupStage(container, stage, stageMatches);
            } else if (stage.type === 'gsl') {
                renderGSLStage(container, stage, stageMatches);
            } else {
                renderBracketStage(container, stage, stageMatches);
            }
        }

        // --- CROSS GROUP STAGE VIEW ---
        function renderCrossGroupStage(container, stage, matches) {
            const stats = {};
            const teamIds = new Set();
            
            if (stage.stageParticipants) stage.stageParticipants.forEach(tid => teamIds.add(tid));
            matches.forEach(m => {
                if(m.teamA) teamIds.add(m.teamA._id || m.teamA);
                if(m.teamB) teamIds.add(m.teamB._id || m.teamB);
            });

            teamIds.forEach(tid => {
                const t = teamsData.find(x => x._id === tid);
                if(t) stats[tid] = { id: tid, name: t.name, short: t.shortName, logo: t.logo, w:0, l:0, mapW:0, mapL:0, diff:0 };
            });

            matches.forEach(m => {
                if (m.status === 'finished' && m.winner) {
                    const wId = m.winner._id || m.winner;
                    const lId = (m.teamA._id === wId || m.teamA === wId) ? (m.teamB._id || m.teamB) : (m.teamA._id || m.teamA);
                    
                    if(stats[wId]) stats[wId].w++;
                    if(stats[lId]) stats[lId].l++;

                    let sA = 0, sB = 0, mapsA = 0, mapsB = 0;
                    m.scores.forEach(s => { 
                        const scA = parseInt(s.teamAScore)||0; const scB = parseInt(s.teamBScore)||0;
                        sA += scA; sB += scB; 
                        if (scA > scB) mapsA++; else if (scB > scA) mapsB++; 
                    });

                    const tA = m.teamA._id || m.teamA; const tB = m.teamB._id || m.teamB;
                    if(stats[tA]) { stats[tA].mapW += mapsA; stats[tA].mapL += mapsB; stats[tA].diff += (sA - sB); }
                    if(stats[tB]) { stats[tB].mapW += mapsB; stats[tB].mapL += mapsA; stats[tB].diff += (sB - sA); }
                }
            });

            const participants = stage.stageParticipants || [];
            const mid = Math.ceil(participants.length / 2);
            const alphaIds = participants.slice(0, mid);
            const omegaIds = participants.slice(mid);

            const getSortedStats = (ids) => ids.map(id => stats[id]).filter(s => s).sort((a,b) => (b.w - a.w) || ((b.mapW-b.mapL) - (a.mapW-a.mapL)) || (b.diff - a.diff));
            const alphaStats = getSortedStats(alphaIds);
            const omegaStats = getSortedStats(omegaIds);

            const renderTable = (title, sortedStats, colorClass) => `
                <div class="bg-[#1a1d21] border border-[#333] rounded overflow-hidden h-fit shadow-lg mb-6">
                    <div class="px-4 py-3 bg-[#111] border-b border-[#333] flex justify-between items-center">
                        <span class="font-header text-lg text-white tracking-wide ${colorClass}">${title}</span>
                        <i class="fa-solid fa-list-ol text-gray-600"></i>
                    </div>
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-gray-500 uppercase bg-[#15171a] border-b border-[#333]">
                            <tr><th class="px-4 py-3 font-bold w-12 text-center">#</th><th class="px-4 py-3 font-bold">Team</th><th class="px-4 py-3 font-bold text-center">W</th><th class="px-4 py-3 font-bold text-center">L</th><th class="px-4 py-3 font-bold text-center">Maps</th><th class="px-4 py-3 font-bold text-center">Diff</th></tr>
                        </thead>
                        <tbody class="divide-y divide-[#222]">
                            ${sortedStats.map((s, idx) => `
                                <tr class="hover:bg-white/5 transition-colors">
                                    <td class="px-4 py-3 text-center font-mono text-gray-500">${idx + 1}</td>
                                    <td class="px-4 py-3 font-bold text-white flex items-center gap-3"><img src="${s.logo || 'https://via.placeholder.com/30'}" class="w-6 h-6 object-contain"><span class="truncate">${s.name}</span></td>
                                    <td class="px-4 py-3 text-center text-green-400 font-bold">${s.w}</td>
                                    <td class="px-4 py-3 text-center text-red-400 font-bold">${s.l}</td>
                                    <td class="px-4 py-3 text-center text-gray-400 font-mono">${s.mapW}-${s.mapL}</td>
                                    <td class="px-4 py-3 text-center font-mono font-bold ${s.diff>0?'text-green-400':(s.diff<0?'text-red-400':'text-gray-500')}">${s.diff>0?'+':''}${s.diff}</td>
                                </tr>`).join('')}
                            ${sortedStats.length === 0 ? '<tr><td colspan="6" class="text-center text-gray-500 py-8 italic">No teams</td></tr>' : ''}
                        </tbody>
                    </table>
                </div>`;

            const rounds = {};
            matches.forEach(m => { const r = m.round || 1; if(!rounds[r]) rounds[r] = []; rounds[r].push(m); });
            let matchesHtml = '';
            Object.keys(rounds).sort((a,b)=>a-b).forEach(r => {
                matchesHtml += `
                    <div class="mb-8 last:mb-0">
                        <div class="flex items-center gap-4 mb-4">
                            <div class="bg-[#333] text-white text-xs font-bold px-3 py-1 rounded uppercase tracking-widest shadow-md">Round ${r}</div>
                            <div class="h-px bg-gradient-to-r from-[#333] to-transparent flex-1"></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">${rounds[r].map(m => createMatchCard(m)).join('')}</div>
                    </div>`;
            });

            container.innerHTML = `<div class="w-full h-full overflow-y-auto custom-scroll p-8">
                <div class="max-w-7xl mx-auto">
                    <div class="mb-16 relative bg-[#15171a]/50 border border-white/5 rounded-xl p-8 backdrop-blur-sm shadow-xl animate-enter">
                        <div class="absolute top-0 left-0 w-1 h-full bg-[#ff4655] rounded-l-xl"></div>
                        <div class="flex items-center gap-4 mb-8"><h3 class="font-header text-5xl text-white drop-shadow-lg">CROSS GROUP</h3><div class="h-px bg-gradient-to-r from-[#ff4655] to-transparent flex-1 opacity-50"></div></div>
                        <div class="grid grid-cols-1 xl:grid-cols-2 gap-8 mb-8">
                            <div>${renderTable('GROUP ALPHA', alphaStats, 'text-[#ff4655]')}</div>
                            <div>${renderTable('GROUP OMEGA', omegaStats, 'text-[#00d4ff]')}</div>
                        </div>
                        <div class="bg-[#1a1d21] border border-[#333] rounded p-6">
                            <h4 class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-4 flex items-center gap-2"><i class="fa-solid fa-calendar-days text-[#ff4655]"></i> Schedule</h4>
                            <div class="space-y-2">${matchesHtml}</div>
                        </div>
                    </div></div>
                </div>`;
        }

        // --- GROUP STAGE VIEW ---
        function renderGroupStage(container, stage, matches) {
            const groups = {};
            const getGroupName = (name) => {
                const match = name.match(/(?:Group|Grp)\s+([A-Z0-9]{1,2})\b/i);
                return match ? `Group ${match[1].toUpperCase()}` : 'General';
            };

            matches.forEach(m => {
                const gName = getGroupName(m.name);
                if (!groups[gName]) groups[gName] = [];
                groups[gName].push(m);
            });

            let html = '';
            const sortedGroups = Object.keys(groups).sort();

            html += `<div class="flex justify-end mb-6 animate-enter gap-4">
                <div class="relative">
                    <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 text-xs"></i>
                    <input type="text" oninput="filterGroupMatches(this.value)" placeholder="Search matches..." class="bg-[#1a1d21] border border-[#333] text-white text-xs pl-9 pr-4 py-2 rounded-full focus:border-[#ff4655] outline-none placeholder-gray-600 font-mono w-48 transition-colors">
                </div>`;

            if (sortedGroups.length > 1) {
                html += `
                    <div class="flex items-center gap-3 bg-[#1a1d21] px-4 py-2 rounded-full border border-[#333] shadow-lg hover:border-[#ff4655] transition-colors">
                        <i class="fa-solid fa-filter text-[#ff4655] text-sm"></i>
                        <select onchange="filterGroups(this.value)" class="bg-transparent text-white text-xs font-bold uppercase outline-none cursor-pointer tracking-wider appearance-none pr-2">
                            <option value="all" class="bg-[#1a1d21]">Show All Groups</option>
                            ${sortedGroups.map(g => `<option value="${g}" class="bg-[#1a1d21]">${g}</option>`).join('')}
                        </select>
                        <i class="fa-solid fa-chevron-down text-gray-500 text-[10px]"></i>
                    </div>
                `;
            }
            html += `</div>`;

            sortedGroups.forEach(groupName => {
                const groupMatches = groups[groupName];
                const stats = {};
                const teamIds = new Set();
                
                groupMatches.forEach(m => {
                    if(m.teamA) teamIds.add(m.teamA._id || m.teamA);
                    if(m.teamB) teamIds.add(m.teamB._id || m.teamB);
                });
                
                teamIds.forEach(tid => {
                    const t = teamsData.find(x => x._id === tid);
                    if(t) stats[tid] = { id: tid, name: t.name, short: t.shortName, logo: t.logo, w:0, l:0, mapW:0, mapL:0, diff:0 };
                });

                groupMatches.forEach(m => {
                    if (m.status === 'finished' && m.winner) {
                        const wId = m.winner._id || m.winner;
                        const lId = (m.teamA._id === wId || m.teamA === wId) ? (m.teamB._id || m.teamB) : (m.teamA._id || m.teamA);
                        
                        if(stats[wId]) stats[wId].w++;
                        if(stats[lId]) stats[lId].l++;

                        let sA = 0, sB = 0;
                        m.scores.forEach(s => { sA += parseInt(s.teamAScore)||0; sB += parseInt(s.teamBScore)||0; });
                        
                        let mapsA = 0, mapsB = 0;
                        m.scores.forEach(s => { if(parseInt(s.teamAScore) > parseInt(s.teamBScore)) mapsA++; else mapsB++; });

                        const tA = m.teamA._id || m.teamA;
                        const tB = m.teamB._id || m.teamB;

                        if(stats[tA]) { stats[tA].mapW += mapsA; stats[tA].mapL += mapsB; stats[tA].diff += (sA - sB); }
                        if(stats[tB]) { stats[tB].mapW += mapsB; stats[tB].mapL += mapsA; stats[tB].diff += (sB - sA); }
                    }
                });

                const sortedStats = Object.values(stats).sort((a,b) => (b.w - a.w) || ((b.mapW-b.mapL) - (a.mapW-a.mapL)) || (b.diff - a.diff));

                const tableHtml = `
                    <div class="bg-[#1a1d21] border border-[#333] rounded overflow-hidden h-fit shadow-lg">
                        <div class="px-4 py-3 bg-[#111] border-b border-[#333] flex justify-between items-center">
                            <span class="font-header text-lg text-white tracking-wide">STANDINGS</span>
                            <i class="fa-solid fa-list-ol text-[#ff4655]"></i>
                        </div>
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs text-gray-500 uppercase bg-[#15171a] border-b border-[#333]">
                                <tr>
                                    <th class="px-4 py-3 font-bold w-12 text-center">#</th>
                                    <th class="px-4 py-3 font-bold">Team</th>
                                    <th class="px-4 py-3 font-bold text-center">W</th>
                                    <th class="px-4 py-3 font-bold text-center">L</th>
                                    <th class="px-4 py-3 font-bold text-center">Maps</th>
                                    <th class="px-4 py-3 font-bold text-center">Diff</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-[#222]">
                                ${sortedStats.map((s, idx) => `
                                    <tr class="hover:bg-white/5 transition-colors">
                                        <td class="px-4 py-3 text-center font-mono text-gray-500">${idx + 1}</td>
                                        <td class="px-4 py-3 font-bold text-white flex items-center gap-3">
                                            <img src="${s.logo || 'https://via.placeholder.com/30'}" class="w-6 h-6 object-contain">
                                            <span class="truncate">${s.name}</span>
                                        </td>
                                        <td class="px-4 py-3 text-center text-green-400 font-bold">${s.w}</td>
                                        <td class="px-4 py-3 text-center text-red-400 font-bold">${s.l}</td>
                                        <td class="px-4 py-3 text-center text-gray-400 font-mono">${s.mapW}-${s.mapL}</td>
                                        <td class="px-4 py-3 text-center font-mono font-bold ${s.diff>0?'text-green-400':(s.diff<0?'text-red-400':'text-gray-500')}">${s.diff>0?'+':''}${s.diff}</td>
                                    </tr>
                                `).join('')}
                                ${sortedStats.length === 0 ? '<tr><td colspan="6" class="text-center text-gray-500 py-8 italic">No teams in this group</td></tr>' : ''}
                            </tbody>
                        </table>
                    </div>
                `;

                const rounds = {};
                groupMatches.forEach(m => {
                    const r = m.round || 1;
                    if(!rounds[r]) rounds[r] = [];
                    rounds[r].push(m);
                });

                let matchesHtml = '';
                Object.keys(rounds).sort((a,b)=>a-b).forEach(r => {
                    matchesHtml += `
                        <div class="mb-8 last:mb-0">
                            <div class="flex items-center gap-4 mb-4">
                                <div class="bg-[#333] text-white text-xs font-bold px-3 py-1 rounded uppercase tracking-widest shadow-md">Round ${r}</div>
                                <div class="h-px bg-gradient-to-r from-[#333] to-transparent flex-1"></div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                ${rounds[r].map(m => createMatchCard(m)).join('')}
                            </div>
                        </div>
                    `;
                });

                html += `
                    <div class="mb-16 relative bg-[#15171a]/50 border border-white/5 rounded-xl p-8 backdrop-blur-sm shadow-xl group-container animate-enter" data-group="${groupName}">
                        <div class="absolute top-0 left-0 w-1 h-full bg-[#ff4655] rounded-l-xl"></div>
                        <div class="flex items-center gap-4 mb-8"><h3 class="font-header text-5xl text-white drop-shadow-lg">${groupName}</h3><div class="h-px bg-gradient-to-r from-[#ff4655] to-transparent flex-1 opacity-50"></div></div>
                        <div class="grid grid-cols-1 xl:grid-cols-12 gap-8">
                            <div class="xl:col-span-5">${tableHtml}</div>
                            <div class="xl:col-span-7">
                                <div class="bg-[#1a1d21] border border-[#333] rounded p-6 h-full"><h4 class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-4 flex items-center gap-2"><i class="fa-solid fa-calendar-days text-[#ff4655]"></i> Schedule</h4><div class="space-y-2">${matchesHtml}</div></div>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = `<div class="w-full h-full overflow-y-auto custom-scroll p-8"><div class="max-w-6xl mx-auto">${html}</div></div>`;
        }

        // --- GSL STAGE VIEW ---
        function renderGSLStage(container, stage, matches) {
            const groups = {};
            const getGroupName = (name) => {
                const match = name.match(/(?:Group|Grp)\s+([A-Z0-9]{1,2})\b/i);
                return match ? `Group ${match[1].toUpperCase()}` : 'General';
            };

            matches.forEach(m => {
                const gName = getGroupName(m.name);
                if (!groups[gName]) groups[gName] = [];
                groups[gName].push(m);
            });

            let html = '';
            const sortedGroups = Object.keys(groups).sort();
            
            // Filter UI
            html += `<div class="flex justify-end mb-6 animate-enter gap-4"><div class="relative"><i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 text-xs"></i><input type="text" oninput="filterGroupMatches(this.value)" placeholder="Search matches..." class="bg-[#1a1d21] border border-[#333] text-white text-xs pl-9 pr-4 py-2 rounded-full focus:border-[#ff4655] outline-none placeholder-gray-600 font-mono w-48 transition-colors"></div>`;
            if (sortedGroups.length > 1) {
                html += `<div class="flex items-center gap-3 bg-[#1a1d21] px-4 py-2 rounded-full border border-[#333] shadow-lg hover:border-[#ff4655] transition-colors"><i class="fa-solid fa-filter text-[#ff4655] text-sm"></i><select onchange="filterGroups(this.value)" class="bg-transparent text-white text-xs font-bold uppercase outline-none cursor-pointer tracking-wider appearance-none pr-2"><option value="all" class="bg-[#1a1d21]">Show All Groups</option>${sortedGroups.map(g => `<option value="${g}" class="bg-[#1a1d21]">${g}</option>`).join('')}</select><i class="fa-solid fa-chevron-down text-gray-500 text-[10px]"></i></div>`;
            }
            html += `</div>`;

            sortedGroups.forEach(groupName => {
                const gMatches = groups[groupName];
                const openA = gMatches.find(m => m.name.includes('Opening A'));
                const openB = gMatches.find(m => m.name.includes('Opening B'));
                const winners = gMatches.find(m => m.name.includes('Winners'));
                const elim = gMatches.find(m => m.name.includes('Elimination'));
                const decider = gMatches.find(m => m.name.includes('Decider'));

                const mCard = (m) => m ? createMatchCard(m) : '<div class="h-24 bg-[#1a1d21] border border-[#333] rounded flex items-center justify-center text-gray-600 text-xs font-bold uppercase tracking-widest">TBD</div>';

                html += `
                    <div class="mb-16 relative bg-[#15171a]/50 border border-white/5 rounded-xl p-8 backdrop-blur-sm shadow-xl group-container animate-enter" data-group="${groupName}">
                        <div class="absolute top-0 left-0 w-1 h-full bg-[#ff4655] rounded-l-xl"></div>
                        <div class="flex items-center gap-4 mb-8"><h3 class="font-header text-5xl text-white drop-shadow-lg">${groupName}</h3><div class="h-px bg-gradient-to-r from-[#ff4655] to-transparent flex-1 opacity-50"></div></div>
                        
                        <div class="flex flex-col lg:flex-row gap-8 overflow-x-auto pb-4">
                            <div class="flex flex-col gap-4 min-w-[300px] flex-1">
                                <div class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-2 border-b border-[#333] pb-1">Opening Matches</div>
                                ${mCard(openA)}
                                ${mCard(openB)}
                            </div>
                            <div class="flex flex-col justify-between min-w-[300px] flex-1">
                                <div>
                                    <div class="text-xs font-bold text-[#1fa474] uppercase tracking-widest mb-2 border-b border-[#1fa474]/30 pb-1">Winners Match</div>
                                    ${mCard(winners)}
                                </div>
                                <div>
                                    <div class="text-xs font-bold text-[#ff4655] uppercase tracking-widest mb-2 border-b border-[#ff4655]/30 pb-1">Elimination Match</div>
                                    ${mCard(elim)}
                                </div>
                            </div>
                            <div class="flex flex-col justify-center min-w-[300px] flex-1">
                                <div class="text-xs font-bold text-yellow-500 uppercase tracking-widest mb-2 border-b border-yellow-500/30 pb-1">Decider Match</div>
                                ${mCard(decider)}
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = `<div class="w-full h-full overflow-auto custom-scroll p-8"><div class="max-w-7xl mx-auto">${html}</div></div>`;
        }

        function filterGroups(group) {
            document.querySelectorAll('.group-container').forEach(el => {
                if (group === 'all' || el.dataset.group === group) {
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
            });
        }

        function filterGroupMatches(query) {
            const term = query.toLowerCase();
            document.querySelectorAll('.match-card-item').forEach(el => {
                const searchData = el.dataset.search || '';
                if (searchData.includes(term)) {
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
            });
        }

        // --- BRACKET STAGE VIEW ---
        function renderBracketStage(container, stage, matches) {
            // 1. Group matches by Group Name (e.g., "Group A", "Group B")
            const groups = {};
            matches.forEach(m => {
                const matchGroup = m.name.match(/(?:Group|Grp)\s+([A-Z0-9]{1,2})\b/i);
                const gName = matchGroup ? `Group ${matchGroup[1].toUpperCase()}` : 'Main Bracket';
                if (!groups[gName]) groups[gName] = [];
                groups[gName].push(m);
            });

            const sortedGroups = Object.keys(groups).sort();
            let html = '';

            sortedGroups.forEach((gName, idx) => {
                const groupMatches = groups[gName];
                const upper = [], lower = [], final = [];
                
                groupMatches.forEach(m => {
                    if (m.matchOrder === 999 || m.round === 999) final.push(m);
                    else if (m.round >= 100) lower.push(m);
                    else upper.push(m);
                });

                const groupRounds = (arr) => {
                    const map = {};
                    arr.forEach(m => {
                        if(!map[m.round]) map[m.round] = [];
                        map[m.round].push(m);
                    });
                    return Object.keys(map).sort((a,b)=>a-b).map(k => map[k].sort((a,b)=>a.matchOrder-b.matchOrder));
                };

                const ubRounds = groupRounds(upper);
                const lbRounds = groupRounds(lower);
                const finalRounds = groupRounds(final);
                const svgId = `bracketSvg-${idx}`;

                html += `
                    <div class="relative group-bracket flex-shrink-0 mr-24">
                        ${sortedGroups.length > 1 ? `<h3 class="font-header text-3xl text-white mb-8 border-l-4 border-[#ff4655] pl-4">${gName}</h3>` : ''}
                        <div class="relative min-w-max pb-10">
                            <svg id="${svgId}" class="absolute inset-0 w-full h-full pointer-events-none z-0"></svg>
                            <div class="flex flex-col gap-16 p-10">
                                <div class="flex gap-16" id="upperBracket-${idx}">
                                    ${ubRounds.length ? renderRoundColumns(ubRounds, 'UB') : ''}
                                    ${finalRounds.length ? renderRoundColumns(finalRounds, 'GF') : ''}
                                </div>
                                ${lbRounds.length ? `<div class="flex gap-16 mt-8" id="lowerBracket-${idx}">${renderRoundColumns(lbRounds, 'LB')}</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = `
                <div id="bracketViewport" class="bracket-viewport w-full h-full overflow-hidden relative">
                    <div id="bracketCanvas" class="absolute top-0 left-0 flex gap-20 p-20 origin-top-left transition-transform duration-75 ease-out">
                        ${html}
                    </div>
                </div>`;

            // Draw Lines after render
            setTimeout(() => {
                sortedGroups.forEach((gName, idx) => {
                    drawBracketLines(groups[gName], `bracketSvg-${idx}`);
                });
            }, 100);
            
            initPanZoom();
        }

        function renderRoundColumns(rounds, prefix) {
            return rounds.map((matches, i) => {
                let label = `${prefix} Round ${i+1}`;
                if (prefix === 'GF') label = (rounds.length > 1) ? `Grand Final R${i+1}` : 'Grand Final';
                
                return `
                <div class="bracket-column">
                    <div class="absolute top-0 left-0 text-[10px] font-bold text-gray-500 uppercase tracking-widest w-full text-center border-b border-[#333] pb-2 mb-4">
                        ${label}
                    </div>
                    ${matches.map(m => createBracketNode(m)).join('')}
                </div>
            `}).join('');
        }

        function createBracketNode(m) {
            const isLive = m.status === 'live';
            const sA = calculateScore(m, 'A');
            const sB = calculateScore(m, 'B');
            const winA = m.winner && (m.winner === m.teamA?._id || m.winner._id === m.teamA?._id);
            const winB = m.winner && (m.winner === m.teamB?._id || m.winner._id === m.teamB?._id);
            
            let statusClass = 'upcoming';
            if (isLive) statusClass = 'live';
            else if (m.status === 'finished') statusClass = 'finished';

            const nameA = m.teamA ? m.teamA.shortName : getSourceText(m._id, 'teamA');
            const nameB = m.teamB ? m.teamB.shortName : getSourceText(m._id, 'teamB');

            const idA = m.teamA ? m.teamA._id : '';
            const idB = m.teamB ? m.teamB._id : '';

            return `
                <div class="match-node ${statusClass} cursor-pointer group" id="match-${m._id}" data-next="${m.nextMatchId||''}" data-loser="${m.loserMatchId||''}" onclick="openMatchDetail('${m._id}')">
                    <div class="flex justify-between items-center px-3 py-2 bg-[#15171a] border-b border-[#2d3139] text-[10px] text-gray-500 font-bold uppercase tracking-wider">
                        <span>${isLive ? '<span class="text-[#ff4655] font-bold animate-pulse">LIVE</span>' : (m.scheduledTime ? new Date(m.scheduledTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : 'TBD')}</span>
                        <span>${m.format || 'BO3'}</span>
                    </div>
                    <div class="p-2 space-y-1">
                        <div class="flex justify-between items-center p-2 rounded ${winA ? 'bg-white/5' : ''} transition" onmouseenter="highlightTeam('${idA}')" onmouseleave="resetHighlight()">
                            <div class="flex items-center gap-3 overflow-hidden">
                                <img src="${m.teamA?.logo || 'https://via.placeholder.com/30'}" class="w-6 h-6 object-contain bg-black/30 rounded p-0.5">
                                <span class="text-sm font-bold truncate ${winA ? 'text-white' : 'text-gray-400'} font-header tracking-wide" title="${nameA}">${nameA}</span>
                            </div>
                            <span class="font-mono text-lg font-bold ${winA ? 'text-[#ff4655]' : 'text-gray-600'}">${sA}</span>
                        </div>
                        <div class="flex justify-between items-center p-2 rounded ${winB ? 'bg-white/5' : ''} transition" onmouseenter="highlightTeam('${idB}')" onmouseleave="resetHighlight()">
                            <div class="flex items-center gap-3 overflow-hidden">
                                <img src="${m.teamB?.logo || 'https://via.placeholder.com/30'}" class="w-6 h-6 object-contain bg-black/30 rounded p-0.5">
                                <span class="text-sm font-bold truncate ${winB ? 'text-white' : 'text-gray-400'} font-header tracking-wide" title="${nameB}">${nameB}</span>
                            </div>
                            <span class="font-mono text-lg font-bold ${winB ? 'text-[#ff4655]' : 'text-gray-600'}">${sB}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function createMatchCard(m) {
            const sA = calculateScore(m, 'A');
            const sB = calculateScore(m, 'B');
            const isLive = m.status === 'live';
            const searchTerms = `${m.name} ${m.teamA?.name || ''} ${m.teamA?.shortName || ''} ${m.teamB?.name || ''} ${m.teamB?.shortName || ''}`.toLowerCase();
            
            return `
                <div class="bg-[#1a1d21] border border-[#333] rounded p-3 hover:border-[#ff4655] transition group cursor-pointer match-card-item" data-search="${searchTerms}" onclick="openMatchDetail('${m._id}')">
                    <div class="flex justify-between items-center mb-2 text-[10px] text-gray-500 font-bold uppercase">
                        <span>${isLive ? '<span class="text-[#ff4655] animate-pulse">LIVE</span>' : (m.scheduledTime ? new Date(m.scheduledTime).toLocaleString() : 'TBD')}</span>
                        <span>${m.name}</span>
                    </div>
                    <div class="flex justify-between items-center mb-1">
                        <div class="flex items-center gap-2">
                            <img src="${m.teamA?.logo || 'https://via.placeholder.com/30'}" class="w-5 h-5 object-contain">
                            <span class="text-sm font-bold text-white">${m.teamA?.name || 'TBD'}</span>
                        </div>
                        <span class="font-mono text-lg ${sA > sB ? 'text-[#ff4655]' : 'text-gray-400'}">${sA}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <img src="${m.teamB?.logo || 'https://via.placeholder.com/30'}" class="w-5 h-5 object-contain">
                            <span class="text-sm font-bold text-white">${m.teamB?.name || 'TBD'}</span>
                        </div>
                        <span class="font-mono text-lg ${sB > sA ? 'text-[#ff4655]' : 'text-gray-400'}">${sB}</span>
                    </div>
                </div>
            `;
        }

        function calculateScore(m, side) {
            if(!m.scores) return 0;
            let w = 0;
            m.scores.forEach(s => {
                const a = parseInt(s.teamAScore)||0;
                const b = parseInt(s.teamBScore)||0;
                if(side === 'A' && a > b) w++;
                if(side === 'B' && b > a) w++;
            });
            return w;
        }

        function getSourceText(matchId, slot) {
            const wSrc = matchesData.find(m => m.nextMatchId === matchId && m.nextMatchSlot === slot);
            if (wSrc) return `Winner of ${shortenName(wSrc.name)}`;
            const lSrc = matchesData.find(m => m.loserMatchId === matchId && m.loserMatchSlot === slot);
            if (lSrc) return `Loser of ${shortenName(lSrc.name)}`;
            return 'TBD';
        }

        function shortenName(name) {
            return name.replace(/Upper Bracket/g, 'UB').replace(/Lower Bracket/g, 'LB').replace(/Round /g, 'R').replace(/Match /g, 'M').replace(/Grand Final/g, 'GF');
        }

        function highlightTeam(teamId) {
            if(!teamId) return;
            
            document.querySelectorAll('.match-node').forEach(el => el.classList.add('dimmed'));
            document.querySelectorAll('path.connector').forEach(el => el.classList.add('dimmed'));

            const teamMatches = matchesData.filter(m => {
                const tA = m.teamA?._id || m.teamA;
                const tB = m.teamB?._id || m.teamB;
                return tA === teamId || tB === teamId;
            });
            const teamMatchIds = new Set(teamMatches.map(m => m._id));

            teamMatches.forEach(m => {
                const el = document.getElementById(`match-${m._id}`);
                if(el) {
                    el.classList.remove('dimmed');
                    el.classList.add('highlight-team');
                }
            });

            document.querySelectorAll('path.connector').forEach(path => {
                const src = path.getAttribute('data-source');
                const tgt = path.getAttribute('data-target');
                if(teamMatchIds.has(src) && teamMatchIds.has(tgt)) {
                    path.classList.remove('dimmed');
                    path.classList.add('highlight-path');
                }
            });
        }

        function resetHighlight() {
            document.querySelectorAll('.match-node').forEach(el => {
                el.classList.remove('dimmed', 'highlight-team');
            });
            document.querySelectorAll('path.connector').forEach(el => {
                el.classList.remove('dimmed', 'highlight-path');
            });
        }

        function openMatchDetail(matchId) {
            const m = matchesData.find(x => x._id === matchId);
            if (!m) return;
            
            const sA = calculateScore(m, 'A');
            const sB = calculateScore(m, 'B');
            const isLive = m.status === 'live';
            
            let mapsList = m.scores || [];
            if (mapsList.length === 0 && m.vetoData && m.vetoData.pickedMaps && m.vetoData.pickedMaps.length > 0) {
                mapsList = m.vetoData.pickedMaps.map(p => ({
                    mapName: p.map,
                    teamAScore: 0,
                    teamBScore: 0
                }));
            }

            const content = document.getElementById('modalContent');
            content.innerHTML = `
                <div class="bg-[#0f1113] p-4 flex justify-between items-center border-b border-[#333]">
                    <div class="flex items-center gap-4">
                        <span class="text-xs bg-white/5 text-gray-300 px-3 py-1 font-bold uppercase tracking-widest border border-white/10">${m.name}</span>
                        <span class="text-xs text-[#ff4655] font-mono tracking-widest">${m.scheduledTime ? new Date(m.scheduledTime).toLocaleDateString() : 'TBD'}</span>
                    </div>
                    <button onclick="closeMatchModal()" class="text-gray-500 hover:text-white transition"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
                <div class="relative py-12 px-8 overflow-hidden bg-[#1a1d21]">
                    <div class="flex items-center justify-center gap-10">
                        <div class="flex flex-col items-center gap-2 w-1/3">
                            <img src="${m.teamA?.logo || 'https://via.placeholder.com/100'}" class="w-24 h-24 object-contain">
                            <h3 class="font-header text-2xl text-white uppercase text-center">${m.teamA?.name || 'TBD'}</h3>
                        </div>
                        <div class="flex flex-col items-center">
                            <div class="font-header text-6xl text-white font-bold flex gap-4">
                                <span class="${sA > sB ? 'text-[#ff4655]' : ''}">${sA}</span>
                                <span class="text-gray-600">-</span>
                                <span class="${sB > sA ? 'text-[#ff4655]' : ''}">${sB}</span>
                            </div>
                            <div class="mt-2 text-xs font-bold uppercase tracking-[0.2em] ${isLive ? 'text-[#ff4655] animate-pulse' : 'text-gray-500'}">
                                ${isLive ? 'LIVE NOW' : m.status}
                            </div>
                        </div>
                        <div class="flex flex-col items-center gap-2 w-1/3">
                            <img src="${m.teamB?.logo || 'https://via.placeholder.com/100'}" class="w-24 h-24 object-contain">
                            <h3 class="font-header text-2xl text-white uppercase text-center">${m.teamB?.name || 'TBD'}</h3>
                        </div>
                    </div>
                </div>
                <div class="p-6 bg-[#15171a] border-t border-[#333] grid grid-cols-1 gap-2 max-h-[40vh] overflow-y-auto custom-scroll">
                     ${mapsList.map((s,i) => `<div class="bg-black/20 p-3 flex justify-between items-center border-l-2 border-[#333]"><span class="text-xs text-gray-500 uppercase tracking-widest">MAP ${i+1}: ${s.mapName || 'VETO'}</span><div class="font-header text-white text-xl"><span class="${parseInt(s.teamAScore) > parseInt(s.teamBScore) ? 'text-[#ff4655]' : ''}">${s.teamAScore}</span><span class="px-2 text-gray-600">:</span><span class="${parseInt(s.teamBScore) > parseInt(s.teamAScore) ? 'text-[#ff4655]' : ''}">${s.teamBScore}</span></div></div>`).join('')}
                     ${mapsList.length === 0 ? '<div class="text-center text-gray-600 text-xs italic py-4">No map data available</div>' : ''}
                </div>
            `;
            document.getElementById('matchModal').classList.remove('hidden');
            document.getElementById('matchModal').classList.add('flex');
        }

        function closeMatchModal() {
            document.getElementById('matchModal').classList.add('hidden');
            document.getElementById('matchModal').classList.remove('flex');
        }
        
        window.addEventListener('keydown', (e) => { if(e.key === 'Escape') closeMatchModal(); });

        // --- SVG LINE DRAWING ---
        function drawBracketLines(matches, svgId = 'bracketSvg') {
            const svg = document.getElementById(svgId);
            if(!svg) return;
            svg.innerHTML = '';
            
            // Resize SVG to fit container
            const container = svg.parentElement;
            svg.setAttribute('width', container.scrollWidth);
            svg.setAttribute('height', container.scrollHeight);

            matches.forEach(m => {
                const sourceEl = document.getElementById(`match-${m._id}`);
                if(!sourceEl) return;

                // Draw line to Next Match (Winner)
                if(m.nextMatchId) {
                    const targetMatch = matchesData.find(x => x._id === m.nextMatchId);

                    const targetEl = document.getElementById(`match-${m.nextMatchId}`);
                    if(targetEl) drawPath(svg, sourceEl, targetEl, false);
                }
            });
        }

        function drawPath(svg, startEl, endEl, isLoser) {
            const startRect = startEl.getBoundingClientRect();
            const endRect = endEl.getBoundingClientRect();
            const containerRect = svg.getBoundingClientRect();

            // Calculate relative coordinates
            const startX = startRect.right - containerRect.left;
            const startY = startRect.top + (startRect.height / 2) - containerRect.top;
            const endX = endRect.left - containerRect.left;
            const endY = endRect.top + (endRect.height / 2) - containerRect.top;

            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            
            path.setAttribute("data-source", startEl.id.replace('match-', ''));
            path.setAttribute("data-target", endEl.id.replace('match-', ''));
            
            // Bezier Curve Logic
            const midX = (startX + endX) / 2;
            let d = '';

            if (isLoser) {
                // Dashed line for loser bracket drop (often goes down then right)
                // Simple elbow for loser drops
                d = `M ${startX} ${startY} L ${midX} ${startY} L ${midX} ${endY} L ${endX} ${endY}`;
                path.setAttribute("stroke-dasharray", "4");
                path.setAttribute("stroke", "#666");
            } else {
                // Orthogonal line for winners (VLR style)
                d = `M ${startX} ${startY} L ${midX} ${startY} L ${midX} ${endY} L ${endX} ${endY}`;
                path.setAttribute("stroke", "#666");
            }

            path.setAttribute("d", d);
            path.setAttribute("fill", "none");
            path.setAttribute("stroke-width", "3");
            path.classList.add("connector");
            
            svg.appendChild(path);
        }

        // Handle Resize
        window.addEventListener('resize', () => {
            const activeStage = tournamentData?.stages[activeStageIndex];
            if(activeStage && activeStage.type !== 'round_robin' && activeStage.type !== 'swiss') {
                const stageMatches = activeStage.matches.map(mid => matchesData.find(m => m._id === mid)).filter(m => m);
                
                // Re-draw for all groups
                const groups = {};
                stageMatches.forEach(m => {
                    const matchGroup = m.name.match(/(?:Group|Grp)\s+([A-Z0-9]{1,2})\b/i);
                    const gName = matchGroup ? `Group ${matchGroup[1].toUpperCase()}` : 'Main Bracket';
                    if (!groups[gName]) groups[gName] = [];
                    groups[gName].push(m);
                });
                Object.keys(groups).sort().forEach((gName, idx) => {
                    drawBracketLines(groups[gName], `bracketSvg-${idx}`);
                });
            }
        });

        // --- PAN & ZOOM LOGIC ---
        function initPanZoom() {
            const viewport = document.getElementById('bracketViewport');
            const canvas = document.getElementById('bracketCanvas');
            if(!viewport || !canvas) return;

            viewport.onmousedown = function (e) {
                e.preventDefault();
                startX = e.clientX - translateX;
                startY = e.clientY - translateY;
                panning = true;
            };

            // Touch Support
            viewport.addEventListener('touchstart', (e) => {
                if (e.touches.length === 1) {
                    panning = true;
                    startX = e.touches[0].clientX - translateX;
                    startY = e.touches[0].clientY - translateY;
                }
            }, { passive: false });

            viewport.onmouseup = function (e) { panning = false; };
            viewport.onmouseleave = function (e) { panning = false; };
            viewport.addEventListener('touchend', () => { panning = false; });

            viewport.onmousemove = function (e) {
                e.preventDefault();
                if (!panning) return;
                translateX = e.clientX - startX;
                translateY = e.clientY - startY;
                updateTransform();
            };

            viewport.addEventListener('touchmove', (e) => {
                if (panning && e.touches.length === 1) {
                    e.preventDefault();
                    translateX = e.touches[0].clientX - startX;
                    translateY = e.touches[0].clientY - startY;
                    updateTransform();
                }
            }, { passive: false });

            viewport.onwheel = function (e) {
                e.preventDefault();
                const rect = viewport.getBoundingClientRect();
                const xs = (e.clientX - rect.left - translateX) / scale;
                const ys = (e.clientY - rect.top - translateY) / scale;
                const delta = -Math.sign(e.deltaY) * ZOOM_SPEED;
                
                const oldScale = scale;
                scale = Math.min(Math.max(0.2, scale + delta), 3);
                
                if (oldScale !== scale) {
                    translateX = e.clientX - rect.left - xs * scale;
                    translateY = e.clientY - rect.top - ys * scale;
                    updateTransform();
                }
            };
        }

        function updateTransform() {
            const canvas = document.getElementById('bracketCanvas');
            if(canvas) canvas.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
        }

        function zoomIn() { scale = Math.min(3, scale + 0.2); updateTransform(); }
        function zoomOut() { scale = Math.max(0.2, scale - 0.2); updateTransform(); }
        function zoomReset() { scale = 1; translateX = 0; translateY = 0; updateTransform(); }
        function resetPanZoom() { scale = 1; translateX = 0; translateY = 0; panning = false; }

        init();
    </script>

</body>
</html>    