<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VALORANT // ADMIN PROTOCOL V8.0 (MISSION CONTROL)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Oswald:wght@500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- CORE VARIABLES --- */
        :root { 
            --primary: #ff4655; 
            --bg-dark: #0f1923; 
            --card-bg: #1a1d21; 
            --border: #2d3139; 
            --text-gray: #8b978f;
        }
        
        /* --- BASE STYLES --- */
        body { background: var(--bg-dark); color: #ece8e1; font-family: 'Inter', sans-serif; overflow: hidden; font-size: 16px; }
        .font-header { font-family: 'Oswald', sans-serif; text-transform: uppercase; letter-spacing: 0.05em; }
        
        /* --- SCROLLBAR --- */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f1113; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }
        
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #555; }

        /* --- COMPONENTS --- */
        .nav-btn { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); border-right: 4px solid transparent; opacity: 0.8; }
        .nav-btn:hover { background: rgba(255, 255, 255, 0.05); opacity: 1; color: white; }
        .nav-btn.active { background: linear-gradient(90deg, rgba(255, 70, 85, 0.15) 0%, transparent 100%); color: var(--primary); border-right-color: var(--primary); opacity: 1; font-weight: 700; }
        
        .glass-panel { background: #15171a; border: 1px solid var(--border); border-radius: 6px; }
        .btn-val { background: var(--primary); color: white; font-family: 'Oswald', sans-serif; letter-spacing: 1px; transition: 0.2s; position: relative; overflow: hidden; border-radius: 4px; font-weight: 600; }
        .btn-val:hover { filter: brightness(1.1); transform: translateY(-1px); }
        
        .input-dark { background: transparent; border: 1px solid transparent; border-bottom: 2px solid var(--border); color: white; transition: 0.3s; padding: 10px 0; font-size: 1rem; }
        .input-dark:focus { border-bottom-color: var(--primary); outline: none; background: transparent; }
        
        .animate-slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        
        .tab-btn { border-bottom: 3px solid transparent; transition: all 0.2s; opacity: 0.6; font-size: 0.9rem; }
        .tab-btn:hover { opacity: 1; }
        .tab-btn.active { border-color: var(--primary); color: var(--primary); opacity: 1; }
        
        .nav-badge { background: #ff4655; color: white; font-size: 11px; padding: 2px 8px; border-radius: 4px; margin-left: auto; font-weight: bold; min-width: 24px; text-align: center; }
        
        /* --- NEW: TEAM CARDS --- */
        .team-card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
            border-color: #555;
        }
        .status-indicator {
            position: absolute; top: 0; left: 0; bottom: 0; width: 4px;
        }

        /* --- TABLE STYLES --- */
        .table-val { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.95rem; }
        .table-val th { text-align: left; padding: 12px 16px; font-family: 'Oswald', sans-serif; color: #8b978f; font-weight: 500; text-transform: uppercase; border-bottom: 2px solid #333; font-size: 0.85rem; }
        .table-val td { padding: 12px 16px; border-bottom: 1px solid #222; color: #ece8e1; }
        .table-val tr:hover td { background: rgba(255,255,255,0.03); }
        
        /* --- BRACKET LAYOUT --- */
        .bracket-container { display: flex; overflow-x: auto; padding-bottom: 24px; gap: 2.5rem; }
        .bracket-round { min-width: 320px; display: flex; flex-direction: column; gap: 1.25rem; }
        .bracket-header { font-family: 'Oswald', sans-serif; font-size: 0.9rem; color: #8b978f; text-transform: uppercase; border-bottom: 2px solid #333; padding-bottom: 0.75rem; margin-bottom: 0.75rem; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }

        /* --- MAP SELECTOR STYLES --- */
        .map-select-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 0.75rem;
            max-height: 350px;
            overflow-y: auto;
            padding-right: 4px;
        }
        .map-option {
            position: relative;
            background-color: #15171a;
            background-size: cover;
            background-position: center;
            border: 1px solid #333;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 90px;
            user-select: none;
            overflow: hidden;
        }
        .map-option::before {
            content: ''; position: absolute; inset: 0;
            background: rgba(0,0,0,0.6);
            transition: 0.3s;
            z-index: 1;
        }
        .map-option:hover { border-color: #888; transform: translateY(-2px); }
        .map-option:hover::before { background: rgba(0,0,0,0.3); }
        
        .map-option.selected {
            border-color: #ff4655;
            box-shadow: 0 4px 12px rgba(255, 70, 85, 0.3);
        }
        .map-option.selected::before {
            background: rgba(255, 70, 85, 0.2);
            backdrop-filter: grayscale(100%);
        }
        .map-option.selected .map-name { color: #fff; text-shadow: 0 0 10px #ff4655; }
        .map-option.selected .check-icon { opacity: 1; transform: scale(1); }
        
        .map-option i.fa-map { display: none; }
        .map-name { 
            position: relative; z-index: 2; 
            font-size: 0.85rem; font-weight: 700; 
            color: #ece8e1; text-transform: uppercase; 
            letter-spacing: 0.1em; 
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }
        .check-icon {
            position: absolute; top: 6px; right: 6px; z-index: 2;
            color: #ff4655; font-size: 1rem;
            background: white; border-radius: 50%; padding: 1px;
            opacity: 0; transform: scale(0.5);
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        
        .map-option.disabled { opacity: 0.3; cursor: not-allowed; filter: grayscale(1); }

        /* Drag & Drop */
        .drag-over { background-color: rgba(255, 255, 255, 0.05) !important; border: 2px dashed #666 !important; }
        .draggable-item { cursor: grab; user-select: none; }
        .draggable-item:active { cursor: grabbing; }
        .dragging { opacity: 0.5; }
        .drag-over-insert { border-top: 2px solid #ff4655 !important; background: rgba(255, 70, 85, 0.1); }
        .drag-over-swap { background: rgba(255, 70, 85, 0.3) !important; border: 1px dashed #ff4655 !important; }

        /* Bracket Lines */
        #bracketSvg { overflow: visible; }
        path.connector { fill: none; stroke: #444; stroke-width: 2; opacity: 0.6; }
        path.connector.highlight { stroke: #ff4655; opacity: 1; stroke-width: 3; }

        /* Highlight Styles */
        .bracket-node.dimmed { opacity: 0.3; }
        .bracket-node.highlight-team { opacity: 1; z-index: 20; }
        .bracket-node.highlight-team > div { border-color: #ff4655; box-shadow: 0 0 15px rgba(255, 70, 85, 0.4); }
        path.connector.dimmed { opacity: 0.1; }
        path.connector.highlight-path { stroke: #ff4655; opacity: 1; stroke-width: 3; }

        .modal-content {
            opacity: 0;
            transform: translateY(12px) scale(0.98);
            transition: opacity 0.2s ease, transform 0.25s ease;
        }
        #modalBackdrop.modal-open .modal-content[data-open="true"] {
            opacity: 1;
            transform: translateY(0) scale(1);
        }

        .skeleton {
            background: linear-gradient(90deg, #171a1f 25%, #21252b 37%, #171a1f 63%);
            background-size: 400% 100%;
            animation: shimmer 1.2s ease-in-out infinite;
        }
        @keyframes shimmer {
            0% { background-position: 100% 50%; }
            100% { background-position: 0 50%; }
        }
        .btn-loading {
            pointer-events: none;
            opacity: 0.8;
        }
    </style>
</head>
<body class="flex h-screen w-full">

    <aside class="w-72 bg-[#111] border-r border-[#222] flex flex-col z-30 shadow-xl shrink-0">
        <div class="p-8 border-b border-[#222]">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 bg-white flex items-center justify-center rounded-md">
                    <i class="fa-solid fa-shield-halved text-[#111] text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-header font-bold text-white leading-none tracking-wide">ADMIN<br><span class="text-[#ff4655]">PROTOCOL</span></h1>
                </div>
            </div>
        </div>
        
        <nav class="flex-1 py-8 space-y-2 px-4">
            <p class="text-[10px] text-gray-500 font-bold uppercase tracking-widest px-4 mb-3">Main Menu</p>
            <button data-action="nav" data-view="dashboard" id="nav-dashboard" class="nav-btn active w-full flex items-center gap-4 px-4 py-3.5 rounded-md text-base">
                <i class="fa-solid fa-chart-line w-5 text-center"></i> DASHBOARD
            </button>
            <button data-action="nav" data-view="requests" id="nav-requests" class="nav-btn w-full flex items-center gap-4 px-4 py-3.5 rounded-md text-base">
                <i class="fa-solid fa-inbox w-5 text-center"></i> REQUESTS
                <span id="navBadgeReq" class="nav-badge hidden">0</span>
            </button>
            <button data-action="nav" data-view="structure" id="nav-structure" class="nav-btn w-full flex items-center gap-4 px-4 py-3.5 rounded-md text-base">
                <i class="fa-solid fa-sitemap w-5 text-center"></i> TOURNAMENTS
            </button>
            <button data-action="nav" data-view="teams" id="nav-teams" class="nav-btn w-full flex items-center gap-4 px-4 py-3.5 rounded-md text-base">
                <i class="fa-solid fa-users-gear w-5 text-center"></i> TEAMS
                <span id="navBadgeTeams" class="nav-badge hidden">0</span>
            </button>
            <button data-action="nav" data-view="logs" id="nav-logs" class="nav-btn w-full flex items-center gap-4 px-4 py-3.5 rounded-md text-base">
                <i class="fa-solid fa-clipboard-list w-5 text-center"></i> LOGS
            </button>
        </nav>

        <div class="p-6 border-t border-[#222]">
            <a href="/tournament_view.html" target="_blank" class="flex items-center gap-3 text-sm text-gray-500 hover:text-white transition p-3 rounded hover:bg-[#222] mb-3">
                <i class="fa-solid fa-sitemap"></i> Open Bracket View
            </a>
            <a href="/caster_dashboard.html" target="_blank" class="flex items-center gap-3 text-sm text-gray-500 hover:text-white transition p-3 rounded hover:bg-[#222] mb-3">
                <i class="fa-solid fa-sitemap"></i> Open Caster dashboard
            </a>
            <button data-action="logout" class="w-full py-3 border border-[#333] hover:border-[#ff4655] hover:text-[#ff4655] text-gray-400 text-xs font-bold uppercase tracking-widest transition rounded-md">
                System Logout
            </button>
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto relative isolate bg-[#0f1923]">
        
        <div id="toast" class="fixed top-8 right-8 z-[100] transform translate-x-[150%] transition-all duration-300">
            <div class="bg-white text-[#0f1923] px-8 py-5 rounded-lg shadow-2xl border-l-8 border-[#ff4655] flex items-center gap-5">
                <i class="fa-solid fa-circle-check text-[#ff4655] text-2xl"></i>
                <div>
                    <h4 class="font-header font-bold text-xl leading-none">NOTIFICATION</h4>
                    <p class="text-sm font-bold text-gray-500 mt-1" id="toastMsg">Operation Successful</p>
                </div>
            </div>
        </div>

        <div id="bulkActionBar" class="fixed bottom-0 left-72 right-0 bg-[#1a1d21] border-t-2 border-[#ff4655] p-4 z-50 transform translate-y-full transition-transform duration-300 shadow-2xl flex items-center justify-between">
            <div class="flex items-center gap-8">
                <div class="bg-[#ff4655] text-white font-header text-base px-4 py-2 rounded">
                    <span id="bulkCount">0</span> SELECTED
                </div>
                <div class="flex items-center gap-4">
                    <label class="text-xs text-gray-400 font-bold uppercase">Set Time:</label>
                    <input type="datetime-local" id="bulkTime" class="bg-[#0f1113] border border-[#333] text-white text-sm p-2 rounded [color-scheme:dark]">
                </div>
            </div>
            <div class="flex gap-3">
                <button data-action="clear-selection" class="px-6 py-2 border border-gray-600 text-gray-400 hover:text-white rounded font-bold text-xs uppercase transition">Cancel</button>
                <button data-action="apply-bulk-time" data-loading="Applying..." class="btn-val px-8 py-2 rounded font-bold text-xs uppercase">APPLY SCHEDULE</button>
            </div>
        </div>

        <div class="relative z-10 p-6 lg:p-10 max-w-[1920px] mx-auto min-h-screen flex flex-col">
            <header class="flex justify-between items-end mb-8 border-b border-white/5 pb-8">
                <div>
                    <h2 class="text-4xl font-header font-bold text-white tracking-tight" id="pageTitle">DASHBOARD</h2>
                    <p class="text-sm text-gray-400 mt-2 font-mono">SYSTEM STATUS: <span class="text-[#22c55e] font-bold">ONLINE</span></p>
                </div>
                <div class="flex items-center gap-6">
                    <div class="text-right hidden md:block">
                        <div class="text-xs text-gray-500 uppercase font-bold mb-1">Server Time</div>
                        <div class="text-2xl font-mono text-white tracking-wider" id="clock">00:00:00</div>
                    </div>
                </div>
            </header>

            <section id="view-dashboard" class="animate-slide-up space-y-8">
                <!-- SYSTEM VITALS -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="bg-[#1a1d21] p-4 rounded border border-[#2d3139] flex flex-col relative overflow-hidden">
                        <span class="text-[10px] text-gray-500 font-bold uppercase tracking-widest z-10">App CPU</span>
                        <div class="flex items-end gap-2 mt-1 z-10">
                            <span class="text-3xl text-white font-header" id="sys-cpu">0%</span>
                            <div class="w-full bg-[#333] h-1.5 rounded-full mb-2"><div id="sys-cpu-bar" class="bg-[#ff4655] h-full rounded-full transition-all duration-500" style="width: 0%"></div></div>
                        </div>
                        <i class="fa-solid fa-microchip absolute -right-2 -bottom-2 text-6xl text-white/5"></i>
                    </div>
                    <div class="bg-[#1a1d21] p-4 rounded border border-[#2d3139] flex flex-col relative overflow-hidden">
                        <span class="text-[10px] text-gray-500 font-bold uppercase tracking-widest z-10">App Memory</span>
                        <span class="text-3xl text-white font-header mt-1 z-10" id="sys-ram">0 MB</span>
                        <span class="text-[9px] text-gray-500 z-10">Host Total: <span id="sys-ram-total" class="text-gray-300">0 GB</span></span>
                        <i class="fa-solid fa-memory absolute -right-2 -bottom-2 text-6xl text-white/5"></i>
                    </div>
                    <div class="bg-[#1a1d21] p-4 rounded border border-[#2d3139] flex flex-col relative overflow-hidden">
                        <span class="text-[10px] text-gray-500 font-bold uppercase tracking-widest z-10">Concurrent Users</span>
                        <span class="text-3xl text-white font-header mt-1 z-10" id="sys-con">0</span>
                        <span class="text-[9px] text-gray-500 z-10">Active Connections</span>
                        <i class="fa-solid fa-users absolute -right-2 -bottom-2 text-6xl text-white/5"></i>
                    </div>
                    <div class="bg-[#1a1d21] p-4 rounded border border-[#2d3139] flex flex-col relative overflow-hidden">
                        <span class="text-[10px] text-gray-500 font-bold uppercase tracking-widest z-10">App Uptime</span>
                        <span class="text-3xl text-white font-header mt-1 z-10" id="sys-uptime">0h 0m</span>
                        <span class="text-[9px] text-gray-500 z-10">Server Status: <span class="text-green-500 font-bold">ONLINE</span></span>
                        <i class="fa-solid fa-clock absolute -right-2 -bottom-2 text-6xl text-white/5"></i>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-12 gap-8">
                    <div class="md:col-span-8 bg-[#15171a] border border-[#ff4655] rounded-lg p-6 relative overflow-hidden group shadow-lg shadow-red-900/10">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                            <i class="fa-solid fa-tower-broadcast text-9xl text-[#ff4655]"></i>
                        </div>
                        <div class="relative z-10">
                            <div class="flex items-center gap-3 mb-2">
                                <span class="w-3 h-3 rounded-full bg-[#ff4655] animate-pulse shadow-[0_0_10px_#ff4655]"></span>
                                <h3 class="font-header text-xl text-white">LIVE OPERATIONS</h3>
                            </div>
                            <div class="text-6xl font-header text-white font-bold tracking-tighter" id="stat-live">0</div>
                            <p class="text-gray-400 text-sm mt-2 font-mono">ACTIVE MATCHES IN PROGRESS</p>
                            <div class="mt-6 flex gap-3">
                                <button data-action="nav" data-view="structure" class="btn-val px-4 py-2 text-xs rounded">MANAGE MATCHES</button>
                                <a href="/tournament_view.html" target="_blank" class="px-4 py-2 border border-[#333] hover:bg-[#333] text-gray-300 text-xs rounded transition font-bold uppercase">View Bracket</a>
                            </div>
                        </div>
                    </div>

                    <div data-action="nav" data-view="requests" class="md:col-span-4 bg-[#1a1d21] border-l-4 border-yellow-500 rounded-r-lg p-6 cursor-pointer hover:bg-[#222] transition relative">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="text-yellow-500 text-xs font-bold uppercase tracking-widest mb-1">Attention Needed</div>
                                <h3 class="font-header text-lg text-white">SCORE APPROVALS</h3>
                            </div>
                            <div class="w-10 h-10 rounded bg-yellow-500/10 flex items-center justify-center text-yellow-500">
                                <i class="fa-solid fa-inbox"></i>
                            </div>
                        </div>
                        <div class="mt-4 flex items-baseline gap-2">
                            <span class="text-4xl font-header text-white" id="stat-pending">0</span>
                            <span class="text-xs text-gray-500">requests</span>
                        </div>
                    </div>

                    <div data-action="nav" data-view="teams" class="md:col-span-2 bg-[#1a1d21] border border-[#2d3139] rounded-lg p-5 cursor-pointer hover:border-blue-500 transition">
                        <div class="text-gray-500 text-[10px] font-bold uppercase tracking-widest mb-2">Total Teams</div>
                        <div class="text-3xl font-header text-white" id="stat-teams">0</div>
                    </div>
                    <div class="md:col-span-2 bg-[#1a1d21] border border-[#2d3139] rounded-lg p-5">
                        <div class="text-gray-500 text-[10px] font-bold uppercase tracking-widest mb-2">Finished</div>
                        <div class="text-3xl font-header text-white" id="stat-finished">0</div>
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="flex items-center justify-between border-b border-[#333] pb-4">
                        <h3 class="text-xl font-header text-white flex items-center gap-3">
                            <i class="fa-solid fa-chart-line text-[#ff4655]"></i> LIVE FEED
                        </h3>
                        <div class="flex items-center gap-2">
                            <select id="dashStageFilter" class="js-dashboard-filter bg-[#0f1113] border border-[#333] text-xs px-3 py-2 rounded text-white focus:border-[#ff4655] outline-none font-mono max-w-[200px]"><option value="all">All Stages</option></select>
                            <input id="dashSearch" placeholder="Search match..." class="js-dashboard-filter bg-[#0f1113] border border-[#333] text-sm px-4 py-2 rounded text-white focus:border-[#ff4655] outline-none w-64 placeholder-gray-600 font-mono">
                        </div>
                    </div>
                    <div id="liveMatches" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
                </div>
            </section>

            <section id="view-requests" class="hidden animate-slide-up space-y-8">
                <div class="flex items-center gap-4 mb-6">
                    <div class="w-10 h-10 rounded bg-yellow-500/10 text-yellow-500 flex items-center justify-center border border-yellow-500/30 text-xl"><i class="fa-solid fa-inbox"></i></div>
                    <div><h3 class="text-2xl font-header text-white">SCORE APPROVALS</h3><p class="text-xs text-gray-500 font-bold uppercase">Matches waiting for verification</p></div>
                </div>
                <div id="pendingScores" class="grid grid-cols-1 xl:grid-cols-2 gap-6"></div>
            </section>

            <section id="view-structure" class="hidden animate-slide-up space-y-8">
                <div id="mainTourneyHeader" class="glass-panel p-8 flex flex-col md:flex-row justify-between items-center gap-6">
                    <div class="text-center w-full py-6 text-gray-500">Loading...</div>
                </div>
                <div id="stageList" class="space-y-10"></div>
            </section>

            <section id="view-teams" class="hidden animate-slide-up space-y-8">
                <div class="flex flex-col md:flex-row justify-between items-center gap-6 bg-[#15171a] p-6 rounded-lg border border-[#2d3139]">
                    <div class="flex items-center gap-4">
                        <h2 class="text-2xl font-header text-white">REGISTERED TEAMS</h2>
                        <button data-action="reset-team-stats" data-loading="Resetting..." class="px-3 py-1.5 border border-red-500/30 text-red-500 hover:bg-red-500 hover:text-white rounded text-[10px] font-bold uppercase transition" title="Reset Wins/Losses for ALL teams">
                            <i class="fa-solid fa-rotate-left mr-1"></i> Reset W/L
                        </button>
                        <button data-action="pick-csv" class="px-3 py-1.5 border border-blue-500/30 text-blue-500 hover:bg-blue-500 hover:text-white rounded text-[10px] font-bold uppercase transition" title="Import Teams (CSV)">
                            <i class="fa-solid fa-file-csv mr-1"></i> Import CSV
                        </button>
                        <button data-action="download-csv-template" class="px-3 py-1.5 border border-green-500/30 text-green-500 hover:bg-green-500 hover:text-white rounded text-[10px] font-bold uppercase transition" title="Download CSV Template">
                            <i class="fa-solid fa-file-arrow-down mr-1"></i> Template
                        </button>
                        <button data-action="send-discord-claim" class="px-3 py-1.5 border border-indigo-500/30 text-indigo-500 hover:bg-indigo-500 hover:text-white rounded text-[10px] font-bold uppercase transition" title="Send Discord Claim Button">
                            <i class="fa-brands fa-discord mr-1"></i> Send Claim
                        </button>
                        <button data-action="sync-all-roles" data-loading="Syncing..." class="px-3 py-1.5 border border-purple-500/30 text-purple-500 hover:bg-purple-500 hover:text-white rounded text-[10px] font-bold uppercase transition" title="Create Roles & Assign Members">
                            <i class="fa-solid fa-arrows-rotate mr-1"></i> Sync Roles
                        </button>
                        <input type="file" id="csvInput" class="hidden js-import-csv" accept=".csv">
                    </div>
                    <div class="relative w-full md:w-80">
                        <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 text-sm"></i>
                        <input type="text" id="teamSearch" placeholder="Search team..." class="js-team-search w-full bg-[#0f1113] border border-[#2d3139] pl-10 pr-4 py-3 rounded text-sm focus:border-[#ff4655] outline-none transition text-white placeholder-gray-500">
                    </div>
                </div>
                <div id="teamGrid" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4"></div>
            </section>

            <section id="view-logs" class="hidden animate-slide-up space-y-6">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded bg-blue-500/10 text-blue-500 flex items-center justify-center border border-blue-500/30 text-xl"><i class="fa-solid fa-clipboard-list"></i></div>
                        <div><h3 class="text-2xl font-header text-white">SYSTEM LOGS</h3><p class="text-xs text-gray-500 font-bold uppercase">Audit Trail & Actions</p></div>
                    </div>
                    <div class="relative">
                        <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 text-xs"></i>
                        <input id="logSearch" placeholder="Search logs..." class="js-log-search bg-[#0f1113] border border-[#2d3139] text-sm pl-9 pr-4 py-2 rounded text-white focus:border-blue-500 outline-none w-64 placeholder-gray-600 font-mono transition-colors">
                    </div>
                </div>
                <div class="bg-[#15171a] border border-[#2d3139] rounded-lg overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-[#1a1d21] border-b border-[#2d3139]">
                                <tr><th class="p-4 text-xs font-bold text-gray-500 uppercase tracking-wider">Time</th><th class="p-4 text-xs font-bold text-gray-500 uppercase tracking-wider">Admin</th><th class="p-4 text-xs font-bold text-gray-500 uppercase tracking-wider">Action</th><th class="p-4 text-xs font-bold text-gray-500 uppercase tracking-wider">Target</th><th class="p-4 text-xs font-bold text-gray-500 uppercase tracking-wider">Details</th></tr>
                            </thead>
                            <tbody id="logsList" class="text-sm text-gray-300"></tbody>
                        </table>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- QUICK ACTION CONTEXT MENU -->
    <div id="matchCtxMenu" class="fixed z-[500] bg-[#1a1d21] border border-[#333] rounded shadow-2xl hidden flex-col w-48 py-1 transform scale-95 opacity-0 transition-all duration-100 origin-top-right">
        <div class="px-3 py-2 text-[10px] font-bold text-gray-500 uppercase tracking-widest border-b border-[#333] mb-1">Quick Actions</div>
        <button data-action="quick-action" data-quick="winA" class="text-left px-4 py-2.5 text-xs text-gray-300 hover:bg-[#222] hover:text-green-400 transition font-bold uppercase w-full flex items-center gap-2"><i class="fa-solid fa-trophy w-4"></i> Win: <span id="ctxNameA" class="truncate">A</span></button>
        <button data-action="quick-action" data-quick="winB" class="text-left px-4 py-2.5 text-xs text-gray-300 hover:bg-[#222] hover:text-green-400 transition font-bold uppercase w-full flex items-center gap-2"><i class="fa-solid fa-trophy w-4"></i> Win: <span id="ctxNameB" class="truncate">B</span></button>
        <div class="h-[1px] bg-[#333] my-1"></div>
        <button data-action="quick-action" data-quick="copyPass" class="text-left px-4 py-2.5 text-xs text-blue-400 hover:bg-blue-500/10 transition font-bold uppercase w-full flex items-center gap-2"><i class="fa-solid fa-key w-4"></i> Copy Password</button>
        <button data-action="quick-action" data-quick="reset" class="text-left px-4 py-2.5 text-xs text-yellow-500 hover:bg-yellow-500/10 transition font-bold uppercase w-full flex items-center gap-2"><i class="fa-solid fa-rotate-left w-4"></i> Reset Match</button>
    </div>

    <div id="modalBackdrop" class="fixed inset-0 bg-black/90 hidden items-center justify-center z-[200] backdrop-blur-sm transition-opacity duration-300">
        <div id="roundSchedulerModal" class="modal-content hidden bg-[#1a1d21] w-full max-w-md border border-[#333] rounded-lg shadow-2xl animate-slide-up">
            <div class="p-6 border-b border-[#333] flex justify-between items-center bg-[#222]">
                <h3 class="text-base font-header text-white">ROUND SCHEDULER</h3>
                <button data-action="close-modal" class="text-gray-500 hover:text-white"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            <div class="p-8 space-y-6">
                <p class="text-sm text-gray-400">Set start time for <span id="rsCount" class="text-[#ff4655] font-bold text-lg">0</span> matches.</p>
                <input type="datetime-local" id="rsTime" class="w-full input-dark [color-scheme:dark]">
                <button data-action="submit-round-schedule" data-loading="Applying..." class="btn-val w-full py-4 rounded font-bold text-sm tracking-wider">APPLY SCHEDULE</button>
            </div>
        </div>

        <div id="editMatchModal" class="modal-content hidden bg-[#1a1d21] w-full max-w-2xl border border-[#333] rounded-lg shadow-2xl animate-slide-up flex flex-col max-h-[90vh]">
            <div class="p-5 border-b border-[#333] flex justify-between items-center bg-[#21252b]">
                <h3 class="text-base font-header text-white">MATCH CONTROL</h3>
                <button data-action="close-modal" class="text-gray-500 hover:text-white"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            <div class="flex border-b border-[#333] bg-[#15171a]">
                <button data-action="switch-match-tab" data-tab="overview" id="tab-overview" class="tab-btn active flex-1 py-3 text-xs font-bold uppercase">Overview</button>
                <button data-action="switch-match-tab" data-tab="scoreboard" id="tab-scoreboard" class="tab-btn flex-1 py-3 text-xs font-bold uppercase">Scoreboard</button>
                <button data-action="switch-match-tab" data-tab="veto" id="tab-veto" class="tab-btn flex-1 py-3 text-xs font-bold uppercase">Veto Log</button>
                <button data-action="switch-match-tab" data-tab="chat" id="tab-chat" class="tab-btn flex-1 py-3 text-xs font-bold uppercase">Live Chat</button>
                <button data-action="switch-match-tab" data-tab="admin" id="tab-admin" class="tab-btn flex-1 py-3 text-xs font-bold uppercase text-red-500">Danger Zone</button>
            </div>
            <div class="p-8 overflow-y-auto flex-1 custom-scroll">
                <div id="view-tab-overview" class="space-y-6">
                    <div class="grid grid-cols-2 gap-6">
                        <div class="space-y-2"><label class="text-xs text-gray-500 font-bold uppercase">Match Name</label><input id="emName" class="w-full input-dark font-bold text-lg"></div>
                        <div class="space-y-2"><label class="text-xs text-gray-500 font-bold uppercase">Status</label><select id="emStatus" class="w-full bg-[#1a1d21] border-b-2 border-[#2d3139] text-white text-base py-2.5 outline-none"><option value="scheduled">SCHEDULED</option><option value="live">LIVE</option><option value="finished">FINISHED</option></select></div>
                    </div>
                    <div class="space-y-2"><label class="text-xs text-gray-500 font-bold uppercase">Time</label><div class="flex gap-4"><input type="datetime-local" id="emTime" class="flex-1 input-dark [color-scheme:dark]"><button data-action="adjust-time" data-minutes="15" class="px-4 bg-[#222] border border-[#333] text-gray-400 text-xs rounded hover:text-white font-bold">+15m</button></div></div>
                    <div class="flex gap-3 mt-4">
                        <button data-action="open-veto-page" class="btn-val flex-1 py-3.5 rounded text-xs font-bold uppercase">Open Veto Interface</button>
                        <button data-action="open-overlay-page" class="btn-val flex-1 py-3.5 rounded text-xs font-bold uppercase bg-blue-600 hover:bg-blue-500">Open Overlay</button>
                    </div>
                </div>
                <div id="view-tab-scoreboard" class="hidden space-y-6">
                    <div class="flex justify-between items-center"><label class="text-xs text-[#ff4655] font-bold uppercase">Manual Scores</label><select id="emFormat" class="js-em-format bg-[#0f1113] text-white text-xs p-2 border border-[#333] rounded"><option value="BO1">BO1</option><option value="BO3">BO3</option><option value="BO5">BO5</option></select></div>
                    <div id="manualScoreInputs" class="space-y-3 bg-black/20 p-4 rounded border border-[#333]"></div>
                </div>
                <div id="view-tab-veto" class="hidden space-y-6">
                    <div id="vetoSummaryContent" class="space-y-4"></div>
                    <button data-action="reset-veto" data-loading="Resetting..." class="w-full py-3 border border-red-500/30 text-red-500 hover:bg-red-500 hover:text-white rounded text-xs font-bold uppercase">RESET VETO STATE</button>
                </div>
                <div id="view-tab-chat" class="hidden h-full flex flex-col">
                    <div id="adminChatBox" class="flex-1 bg-black/20 border border-[#333] rounded p-4 overflow-y-auto custom-scroll space-y-2 mb-4 min-h-[300px]"></div>
                    <div class="flex gap-2">
                        <input id="adminChatInput" class="js-admin-chat-input flex-1 bg-[#0f1113] border border-[#333] text-white text-sm px-4 py-2 rounded focus:border-[#ff4655] outline-none" placeholder="Type message as ADMIN...">
                        <button data-action="send-admin-chat" class="btn-val px-6 py-2 rounded text-xs font-bold">SEND</button>
                    </div>
                </div>
                <div id="view-tab-admin" class="hidden space-y-6">
                    <button data-action="rematch-match" data-loading="Resetting..." class="w-full py-3 mb-2 border border-yellow-500/50 text-yellow-500 hover:bg-yellow-500 hover:text-[#111] rounded text-xs font-bold uppercase transition"><i class="fa-solid fa-rotate-left mr-2"></i> RESET & REMATCH</button>
                    <div class="bg-blue-900/5 border border-blue-500/20 p-4 rounded">
                        <label class="text-xs text-blue-400 font-bold uppercase mb-3 block">Audio System Test</label>
                        <div class="grid grid-cols-2 gap-2">
                            <button data-action="test-audio" data-sound="ready" class="bg-blue-900/10 hover:bg-blue-500 hover:text-white text-blue-400 border border-blue-500/30 py-2 rounded text-[10px] font-bold uppercase">Match Ready</button>
                            <button data-action="test-audio" data-sound="turn" class="bg-blue-900/10 hover:bg-blue-500 hover:text-white text-blue-400 border border-blue-500/30 py-2 rounded text-[10px] font-bold uppercase">Turn Change</button>
                            <button data-action="test-audio" data-sound="action" class="bg-blue-900/10 hover:bg-blue-500 hover:text-white text-blue-400 border border-blue-500/30 py-2 rounded text-[10px] font-bold uppercase">Action</button>
                            <button data-action="test-audio" data-sound="tick" class="bg-blue-900/10 hover:bg-blue-500 hover:text-white text-blue-400 border border-blue-500/30 py-2 rounded text-[10px] font-bold uppercase">Timer Tick</button>
                        </div>
                    </div>
                    <div class="bg-red-900/5 border border-red-500/20 p-4 rounded">
                        <label class="text-xs text-red-400 font-bold uppercase mb-3 block">Force Result</label>
                        <div class="flex gap-3"><button data-action="force-winner" data-side="teamA" class="flex-1 bg-red-900/10 hover:bg-red-500 hover:text-white text-red-400 border border-red-500/30 py-3 rounded text-xs font-bold uppercase">Win: <span id="forceNameA">A</span></button><button data-action="force-winner" data-side="teamB" class="flex-1 bg-red-900/10 hover:bg-red-500 hover:text-white text-red-400 border border-red-500/30 py-3 rounded text-xs font-bold uppercase">Win: <span id="forceNameB">B</span></button></div>
                    </div>
                    <button data-action="delete-match" data-loading="Deleting..." class="w-full py-3 border border-red-600/30 text-red-500 hover:bg-red-600 hover:text-white rounded text-xs font-bold uppercase">DELETE MATCH</button>
                </div>
            </div>
            <div class="p-6 border-t border-[#333] bg-[#21252b]"><button data-action="save-match-edit" data-loading="Saving..." class="btn-val w-full py-3.5 rounded font-bold text-sm tracking-widest">SAVE CHANGES</button></div>
        </div>

        <div id="stageModal" class="modal-content hidden bg-[#1a1d21] w-full h-full border-none rounded-none shadow-none animate-slide-up flex flex-col">
            <div class="p-6 border-b border-[#333] flex justify-between items-center bg-[#222]">
                <h3 class="text-base font-header text-white">CONFIGURE STAGE</h3>
                <button data-action="close-modal" class="text-gray-500 hover:text-white"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            <div class="flex flex-1 overflow-hidden">
                <!-- Format Selection Sidebar -->
                <div class="w-80 shrink-0 bg-[#15171a] border-r border-[#333] overflow-y-auto custom-scroll p-4 space-y-2">
                    <div class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2">Select Format</div>
                    <button data-action="select-format" data-format="single_elim" id="btn-fmt-single_elim" class="format-btn w-full text-left p-3 rounded border border-[#333] hover:bg-[#222] hover:border-[#ff4655] transition group">
                        <div class="font-bold text-white group-hover:text-[#ff4655]">Single Elimination</div>
                        <div class="text-[10px] text-gray-500 mt-1">Standard knockout bracket. Winners advance, losers eliminated.</div>
                    </button>
                    <button data-action="select-format" data-format="double_elim" id="btn-fmt-double_elim" class="format-btn w-full text-left p-3 rounded border border-[#333] hover:bg-[#222] hover:border-[#ff4655] transition group">
                        <div class="font-bold text-white group-hover:text-[#ff4655]">Double Elimination</div>
                        <div class="text-[10px] text-gray-500 mt-1">Winners and Losers brackets. Second chance for players.</div>
                    </button>
                    <button data-action="select-format" data-format="round_robin" id="btn-fmt-round_robin" class="format-btn w-full text-left p-3 rounded border border-[#333] hover:bg-[#222] hover:border-[#ff4655] transition group">
                        <div class="font-bold text-white group-hover:text-[#ff4655]">Round Robin</div>
                        <div class="text-[10px] text-gray-500 mt-1">League style. Everyone plays everyone.</div>
                    </button>
                    <button data-action="select-format" data-format="swiss" id="btn-fmt-swiss" class="format-btn w-full text-left p-3 rounded border border-[#333] hover:bg-[#222] hover:border-[#ff4655] transition group">
                        <div class="font-bold text-white group-hover:text-[#ff4655]">Swiss System</div>
                        <div class="text-[10px] text-gray-500 mt-1">Non-elimination. Pair by record.</div>
                    </button>
                    <button data-action="select-format" data-format="gsl" id="btn-fmt-gsl" class="format-btn w-full text-left p-3 rounded border border-[#333] hover:bg-[#222] hover:border-[#ff4655] transition group">
                        <div class="font-bold text-white group-hover:text-[#ff4655]">GSL Groups</div>
                        <div class="text-[10px] text-gray-500 mt-1">Dual Tournament group stage.</div>
                    </button>
                    <button data-action="select-format" data-format="cross_group" id="btn-fmt-cross_group" class="format-btn w-full text-left p-3 rounded border border-[#333] hover:bg-[#222] hover:border-[#ff4655] transition group">
                        <div class="font-bold text-white group-hover:text-[#ff4655]">Cross-Group</div>
                        <div class="text-[10px] text-gray-500 mt-1">Split 2 groups. A plays B.</div>
                    </button>
                </div>

                <!-- Configuration Area -->
                <div class="flex-1 p-8 overflow-y-auto custom-scroll">
                    <input type="hidden" id="stType">
                    
                    <div class="space-y-6">
                        <div>
                            <label class="text-xs text-gray-500 font-bold uppercase block mb-2">Stage Name</label>
                            <input id="stName" class="w-full input-dark" placeholder="e.g. Group Stage, Playoffs">
                        </div>

                        <div class="grid grid-cols-2 gap-6">
                            <div>
                                <label class="text-xs text-gray-500 font-bold uppercase block mb-2">Match Format</label>
                                <select id="stDefBO" class="w-full bg-[#1a1d21] text-white border-b-2 border-[#333] text-sm py-2 outline-none focus:border-[#ff4655]">
                                    <option value="BO1">Best of 1</option>
                                    <option value="BO3" selected>Best of 3</option>
                                    <option value="BO5">Best of 5</option>
                                </select>
                            </div>
                            <div class="flex items-end pb-2">
                                <div class="flex items-center gap-2">
                                    <input type="checkbox" id="stRandom" class="accent-[#ff4655] w-4 h-4">
                                    <label for="stRandom" class="text-xs text-gray-300 select-none">Randomize Seeding</label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Dynamic Settings Container -->
                        <div id="formatSettings" class="p-4 bg-[#0f1113] border border-[#2d3139] rounded hidden">
                            <!-- Injected via JS -->
                        </div>

                        <!-- Participants Import -->
                        <div class="p-4 bg-[#0f1113] border border-[#2d3139] rounded relative">
                            <div class="flex flex-col gap-3 mb-4 border-b border-[#333] pb-4">
                                <label class="text-xs text-[#ff4655] font-bold uppercase">Participants</label>
                                <div class="flex gap-2">
                                    <select id="impStage" class="bg-[#1a1d21] text-white text-xs border border-[#333] p-2 rounded flex-1 outline-none"></select>
                                    <select id="impType" class="js-imp-type bg-[#1a1d21] text-white text-xs border border-[#333] p-2 rounded flex-1 outline-none">
                                        <option value="all">All Participants</option>
                                        <option value="top_n">Top N (Standings)</option>
                                        <option value="gsl">GSL Qualified (Top 2)</option>
                                    </select>
                                    <input type="number" id="impCount" value="4" class="w-16 bg-[#1a1d21] border border-[#333] text-white text-center p-2 rounded text-xs hidden placeholder-gray-500" placeholder="N">
                                    <button data-action="run-import" class="btn-val px-4 py-1 rounded text-[10px] font-bold hover:brightness-110 transition"><i class="fa-solid fa-file-import mr-1"></i> IMPORT</button>
                                </div>
                            </div>

                            <div id="manualSelectUI" class="grid grid-cols-2 gap-6 h-[500px]">
                                <div class="flex flex-col bg-[#1a1d21] border border-[#2d3139] rounded overflow-hidden">
                                    <div class="p-2 bg-[#222] text-xs font-bold text-gray-500 uppercase flex justify-between items-center"><span>Pool</span><span id="availCount">0</span></div>
                                    <div class="px-2 py-1 border-b border-[#333]"><input id="poolSearch" class="js-pool-search w-full bg-[#0f1113] border border-[#333] text-[10px] px-2 py-1 rounded text-white focus:border-[#ff4655] outline-none placeholder-gray-600" placeholder="Search team..."></div>
                                    <div id="poolList" class="flex-1 overflow-y-auto p-2 space-y-1 custom-scroll transition-colors" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event, 'pool')"></div>
                                </div>
                                <div class="flex flex-col bg-[#1a1d21] border border-[#ff4655]/30 rounded overflow-hidden">
                                    <div class="p-2 bg-[#222] text-xs font-bold text-[#ff4655] uppercase flex justify-between"><span>Selected</span><span id="selCount">0</span></div>
                                    <div id="selectedList" class="flex-1 overflow-y-auto p-2 space-y-1 bg-[#ff4655]/5 custom-scroll transition-colors" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event, 'selected')"></div>
                                    <button data-action="clear-stage-selection" class="p-1.5 bg-[#222] border-t border-[#333] text-[10px] text-gray-500 hover:text-white uppercase font-bold w-full">Clear All</button>
                                </div>
                            </div>
                        </div>

                        <button data-action="generate-stage" data-loading="Generating..." class="btn-val w-full py-4 rounded font-bold text-sm mt-4 tracking-widest shadow-lg shadow-red-900/20">GENERATE STAGE</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="createTourneyModal" class="modal-content hidden bg-[#1a1d21] w-full max-w-lg border border-[#333] rounded-lg shadow-2xl animate-slide-up">
            <div class="p-5 border-b border-[#333] flex justify-between items-center bg-[#222]"><h3 class="text-base font-header text-white">NEW SYSTEM</h3><button data-action="close-modal" class="text-gray-500 hover:text-white"><i class="fa-solid fa-xmark"></i></button></div>
            <div class="p-8 space-y-6">
                <div class="space-y-2"><label class="text-xs text-gray-500 font-bold uppercase">Name</label><input id="tnName" class="w-full input-dark text-lg" placeholder="Tournament Name"></div>
                
                <div class="space-y-3">
                    <div class="flex justify-between items-end">
                        <label class="text-xs text-gray-500 font-bold uppercase">Map Pool Selection</label>
                        <span id="count-create" class="text-xs font-mono font-bold text-[#ff4655]">0/7</span>
                    </div>
                    <div id="createMapPoolList" class="map-select-grid custom-scroll"></div>
                    <p class="text-[10px] text-gray-600 italic text-right">* Required exactly 7 maps</p>
                </div>
                
                <button data-action="create-tournament" data-loading="Creating..." class="btn-val w-full py-3.5 rounded font-bold text-sm">INITIALIZE SYSTEM</button>
            </div>
        </div>

        <div id="tourneySettingsModal" class="modal-content hidden bg-[#1a1d21] w-full max-w-lg border border-[#333] rounded-lg shadow-2xl animate-slide-up">
            <div class="p-5 border-b border-[#333] flex justify-between items-center bg-[#222]"><h3 class="text-base font-header text-white">SETTINGS</h3><button data-action="close-modal" class="text-gray-500 hover:text-white"><i class="fa-solid fa-xmark"></i></button></div>
            <div class="p-8 space-y-6">
                <input type="hidden" id="tsId"><input id="tsName" class="w-full input-dark text-lg font-bold">
                
                <div class="space-y-2"><label class="text-xs text-gray-500 font-bold uppercase">Prize Pool</label><input id="tsPrize" class="w-full input-dark" placeholder="e.g. $10,000"></div>
                <div class="space-y-2"><label class="text-xs text-gray-500 font-bold uppercase">Format Description</label><textarea id="tsFormat" class="w-full input-dark h-40 custom-scroll bg-transparent border-b-2 border-[#2d3139] focus:border-[#ff4655] outline-none resize-none font-mono text-sm" placeholder="HTML or Text supported"></textarea></div>

                <div class="space-y-3">
                    <div class="flex justify-between items-end">
                        <label class="text-xs text-gray-500 font-bold uppercase">Active Map Pool</label>
                        <span id="count-edit" class="text-xs font-mono font-bold text-[#ff4655]">0/7</span>
                    </div>
                    <div id="editMapPoolList" class="map-select-grid custom-scroll"></div>
                    <p class="text-[10px] text-gray-600 italic text-right">* Changing this affects all pending matches</p>
                </div>
                
                <div class="pt-4 flex flex-col gap-3"><button data-action="update-tourney-name" data-loading="Updating..." class="btn-val w-full py-3 rounded font-bold text-sm">UPDATE SYSTEM</button><button data-action="delete-tourney" data-loading="Deleting..." class="w-full py-3 border border-red-600/30 text-red-500 hover:bg-red-600 hover:text-white rounded text-xs font-bold uppercase transition">DELETE SYSTEM</button></div>
            </div>
        </div>

        <div id="stageSettingsModal" class="modal-content hidden bg-[#1a1d21] w-full max-w-md border border-[#333] rounded-lg shadow-2xl animate-slide-up">
            <div class="p-5 border-b border-[#333] flex justify-between items-center bg-[#222]">
                <h3 class="text-base font-header text-white">STAGE SETTINGS</h3>
                <button data-action="close-modal" class="text-gray-500 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-8 space-y-6">
                <input type="hidden" id="ssTourneyId"><input type="hidden" id="ssStageIndex">
                <div class="space-y-2">
                    <label class="text-xs text-gray-500 font-bold uppercase">Tiebreaker Priority</label>
                    <div class="flex flex-col gap-2"><div class="flex items-center gap-2"><span class="text-xs text-gray-400 w-4">1.</span><select id="ssTb1" class="bg-[#0f1113] border border-[#333] text-white text-xs p-2 rounded flex-1 outline-none focus:border-[#ff4655]"><option value="h2h">Head to Head</option><option value="map_diff">Map Diff</option><option value="round_diff">Round Diff</option></select></div><div class="flex items-center gap-2"><span class="text-xs text-gray-400 w-4">2.</span><select id="ssTb2" class="bg-[#0f1113] border border-[#333] text-white text-xs p-2 rounded flex-1 outline-none focus:border-[#ff4655]"><option value="h2h">Head to Head</option><option value="map_diff">Map Diff</option><option value="round_diff">Round Diff</option></select></div><div class="flex items-center gap-2"><span class="text-xs text-gray-400 w-4">3.</span><select id="ssTb3" class="bg-[#0f1113] border border-[#333] text-white text-xs p-2 rounded flex-1 outline-none focus:border-[#ff4655]"><option value="h2h">Head to Head</option><option value="map_diff">Map Diff</option><option value="round_diff">Round Diff</option></select></div></div>
                </div>
                <button data-action="save-stage-settings" data-loading="Saving..." class="btn-val w-full py-3 rounded font-bold text-sm">UPDATE SETTINGS</button>
            </div>
        </div>
        
        <div id="manageTeamsModal" class="modal-content hidden bg-[#1a1d21] w-full max-w-4xl border border-[#333] rounded-lg shadow-2xl animate-slide-up flex flex-col max-h-[90vh]">
            <div class="p-5 border-b border-[#333] flex justify-between items-center bg-[#222]">
                <h3 class="text-base font-header text-white">MANAGE STAGE TEAMS</h3>
                <button data-action="close-modal" class="text-gray-500 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div id="manageTeamsContent" class="p-8 overflow-y-auto custom-scroll flex-1"></div>
        </div>

        <div id="rosterModal" class="modal-content hidden bg-[#1a1d21] w-full max-w-4xl border border-[#333] rounded-lg shadow-2xl animate-slide-up">
            <div class="p-5 border-b border-[#333] flex justify-between bg-[#222]"><h3 class="text-base font-header text-white">ROSTER MANAGEMENT</h3><button data-action="close-modal" class="text-gray-500 hover:text-white"><i class="fa-solid fa-xmark"></i></button></div>
            <div id="rosterModalContent" class="p-8"></div>
        </div>
        <div id="teamEditModal" class="modal-content hidden bg-[#1a1d21] w-full max-w-md border border-[#333] rounded-lg shadow-2xl animate-slide-up">
             <div class="p-5 border-b border-[#333] flex justify-between items-center bg-[#222]"><h3 class="text-base font-header text-white">EDIT TEAM</h3><button data-action="close-modal" class="text-gray-500 hover:text-white"><i class="fa-solid fa-xmark"></i></button></div>
            <div class="p-8 space-y-6">
                <input type="hidden" id="teId"><div class="space-y-2"><label class="text-xs text-gray-500 font-bold uppercase">Team Name</label><input id="teName" class="w-full input-dark text-base"></div><div class="space-y-2"><label class="text-xs text-gray-500 font-bold uppercase">Tag (Short Name)</label><input id="teShort" class="w-full input-dark text-base uppercase"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-2"><label class="text-xs text-gray-500 font-bold uppercase">Wins</label><input type="number" id="teWins" class="w-full input-dark text-base"></div>
                    <div class="space-y-2"><label class="text-xs text-gray-500 font-bold uppercase">Losses</label><input type="number" id="teLosses" class="w-full input-dark text-base"></div>
                </div>
                <button data-action="save-team-edit" data-loading="Saving..." class="btn-val w-full py-3.5 rounded font-bold text-sm mt-2">SAVE CHANGES</button>
            </div>
        </div>
    </div>
    
    <div id="imageViewerModal" class="fixed inset-0 z-[300] bg-black/95 hidden items-center justify-center backdrop-blur-xl" data-action="close-image-viewer">
        <div class="relative max-w-[90vw] max-h-[90vh]">
            <img id="imageViewerSrc" src="" class="max-w-full max-h-[90vh] rounded shadow-2xl border border-white/10">
        </div>
    </div>

    <script>
        const API_BASE = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') && window.location.port !== '3000' ? 'http://localhost:3000' : '';
        const socket = io(API_BASE || undefined);
        const DEFAULT_LOGO = "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQY6fJtdoDAlMIcjcUyEDsxhhXJYDLrzw7dQg&s"; 
        const ALL_MAPS = ['Abyss', 'Ascent', 'Bind', 'Corrode', 'Haven', 'Icebox', 'Lotus', 'Sunset', 'Pearl', 'Split', 'Fracture', 'Breeze', 'Kasbah'];
        const COMPETITIVE_POOL = ['Abyss', 'Ascent', 'Bind', 'Corrode', 'Haven', 'Lotus', 'Sunset'];
        
        // --- MAP PREVIEW IMAGES ---
        const MAP_IMAGES = {
            'Abyss': 'https://media.valorant-api.com/maps/224b0a95-48b9-f703-1bd8-67aca101a61f/splash.png',
            'Ascent': 'https://media.valorant-api.com/maps/7eaecc1b-4337-bbf6-6ab9-04b8f06b3319/splash.png',
            'Bind': 'https://media.valorant-api.com/maps/2c9d57ec-4431-9c5e-2939-8f9ef6dd5cba/splash.png',
            'Corrode': 'https://cms.tracker.gg/content/images/2025/06/Valorant-Corrode-Map.jpg',
            'Haven': 'https://media.valorant-api.com/maps/2bee0dc9-4ffe-519b-1cbd-7fbe763a6047/splash.png',
            'Icebox': 'https://media.valorant-api.com/maps/e2ad5c54-4114-a870-9641-8ea21279579a/splash.png',
            'Lotus': 'https://media.valorant-api.com/maps/2fe4ed3a-450a-948b-6d6b-e89a78e680a9/splash.png',
            'Sunset': 'https://media.valorant-api.com/maps/92584fbe-486a-b1b2-9faa-39b0f486b498/splash.png',
            'Pearl': 'https://media.valorant-api.com/maps/fd267378-4d1d-484f-ff52-77821ed10dc2/splash.png',
            'Split': 'https://media.valorant-api.com/maps/d960549e-485c-e861-8d71-aa9d1aed12a2/splash.png',
            'Fracture': 'https://media.valorant-api.com/maps/b529448b-4d60-346e-e89e-00a4c527a405/splash.png',
            'Breeze': 'https://media.valorant-api.com/maps/2fb9a4fd-47b8-4e7d-a969-74b4046ebd53/splash.png',
            'Kasbah': 'https://media.valorant-api.com/maps/5d6b454a-44d7-0632-0b97-469915b94805/splash.png'
        };

        const token = localStorage.getItem('token');
        if(!token) location.href='/login.html';
        
        let allTeams=[], allMatches=[], allLogs=[], allTourneys=[], activeMatchId, activeTourneyData, pendingRoundScheduleMatches=[];
        let selectedMatches = new Set();
        let stagePool = [], stageSelected = [];
        let bulkMode = false;
        let compactMode = false;
        let activeStageIndex = 0; // NEW: For Tab System
        let overviewMapPool = []; // Track map pool in overview tab
        let vetoTimerInt = null;
        let stageGroupNames = {}; // Store custom group names
        let swapSourceIndex = null; // For click-to-swap
        let activeModalId = null;

        function renderSkeletonCards(count = 6) {
            return Array.from({ length: count }, () => `
                <div class="bg-[#15171a] border border-[#2d3139] rounded-lg p-4 space-y-3">
                    <div class="skeleton h-3 w-1/3 rounded"></div>
                    <div class="skeleton h-8 w-full rounded"></div>
                    <div class="skeleton h-8 w-full rounded"></div>
                </div>
            `).join('');
        }

        function showSectionSkeletons() {
            const live = document.getElementById('liveMatches');
            const pending = document.getElementById('pendingScores');
            const teams = document.getElementById('teamGrid');
            const stages = document.getElementById('stageList');
            if (live) live.innerHTML = renderSkeletonCards(8);
            if (pending) pending.innerHTML = renderSkeletonCards(4);
            if (teams) teams.innerHTML = renderSkeletonCards(6);
            if (stages) stages.innerHTML = renderSkeletonCards(3);
        }

        async function withButtonLoading(el, task) {
            if (!el) return task();
            const restoreText = el.dataset.loadingRestore || el.innerHTML;
            el.dataset.loadingRestore = restoreText;
            const loadingText = el.dataset.loading || 'Loading...';
            el.classList.add('btn-loading');
            el.setAttribute('disabled', 'disabled');
            el.innerHTML = `<i class="fa-solid fa-spinner fa-spin mr-2"></i>${loadingText}`;
            try {
                return await task();
            } finally {
                el.classList.remove('btn-loading');
                el.removeAttribute('disabled');
                el.innerHTML = restoreText;
            }
        }

        function createRoundSection(label, matchIds, cardsHtml) {
            return `<div class="mb-8 last:mb-0"><div class="flex justify-between items-center bg-[#1a1d21] px-4 py-2.5 rounded border border-[#2d3139] mb-3"><span class="text-xs font-bold text-white uppercase tracking-widest">${label}</span><button data-action="open-round-scheduler" data-ids="${matchIds}" class="text-[10px] bg-[#222] hover:bg-white hover:text-black text-gray-400 px-3 py-1 rounded transition font-bold border border-[#333] flex items-center gap-2"><i class="fa-regular fa-clock"></i> Set Time</button></div><div class="grid grid-cols-1 md:grid-cols-2 gap-3">${cardsHtml}</div></div>`;
        }

        function createStandingsRows(standings) {
            return standings.map((st, i) => `
                <tr class="hover:bg-[#222] transition-colors border-b border-[#222] last:border-0">
                    <td class="py-3 px-4 text-center font-mono text-gray-500 border-r border-[#222]">${i+1}</td>
                    <td class="py-3 px-4 font-bold text-white">${st.name}</td>
                    <td class="py-3 px-4 text-center text-gray-300">${st.played}</td>
                    <td class="py-3 px-4 text-center font-bold text-green-400 bg-green-500/5">${st.wins}</td>
                    <td class="py-3 px-4 text-center font-bold text-red-400 bg-red-500/5">${st.losses}</td>
                    <td class="py-3 px-4 text-center font-mono text-gray-400 border-l border-[#222]">${st.mapsWon}-${st.mapsLost}</td>
                    <td class="py-3 px-4 text-center font-mono font-bold ${st.mapDiff>0?'text-green-400':(st.mapDiff<0?'text-red-400':'text-gray-500')}">${st.mapDiff>0?'+':''}${st.mapDiff}</td>
                    <td class="py-3 px-4 text-center font-mono font-bold ${st.diff>0?'text-green-400':(st.diff<0?'text-red-400':'text-gray-500')} border-l border-[#222]">${st.diff>0?'+':''}${st.diff}</td>
                </tr>
            `).join('');
        }

        function migrateInlineEvents(root = document) {
            const eventAttrs = [
                'onclick', 'onchange', 'oninput', 'onkeypress',
                'ondragstart', 'ondragover', 'ondragleave', 'ondrop', 'ondragend',
                'onmouseenter', 'onmouseleave'
            ];

            eventAttrs.forEach((attr) => {
                const eventName = attr.slice(2);
                if (root.nodeType === 1 && root.hasAttribute && root.hasAttribute(attr)) {
                    const code = root.getAttribute(attr);
                    const bindFlag = `data-bound-${attr}`;
                    if (code && root.getAttribute(bindFlag) !== '1') {
                        const handler = new Function('event', code);
                        root.addEventListener(eventName, function(event) {
                            return handler.call(root, event);
                        });
                        root.setAttribute(bindFlag, '1');
                    }
                    root.removeAttribute(attr);
                }
                const nodes = root.querySelectorAll ? root.querySelectorAll(`[${attr}]`) : [];
                nodes.forEach((node) => {
                    const code = node.getAttribute(attr);
                    if (!code) return;
                    const bindFlag = `data-bound-${attr}`;
                    if (node.getAttribute(bindFlag) === '1') {
                        node.removeAttribute(attr);
                        return;
                    }
                    const handler = new Function('event', code);
                    node.addEventListener(eventName, function(event) {
                        return handler.call(node, event);
                    });
                    node.setAttribute(bindFlag, '1');
                    node.removeAttribute(attr);
                });
            });
        }

        function bindUIEvents() {
            migrateInlineEvents(document);
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    mutation.addedNodes.forEach((node) => {
                        if (node.nodeType === 1) {
                            migrateInlineEvents(node);
                        }
                    });
                });
            });
            observer.observe(document.body, { childList: true, subtree: true });

            document.addEventListener('click', async (event) => {
                const trigger = event.target.closest('[data-action]');
                if (!trigger) return;

                const action = trigger.dataset.action;
                const run = async () => {
                    switch (action) {
                        case 'nav': return nav(trigger.dataset.view);
                        case 'logout': return logout();
                        case 'clear-selection': return clearSelection();
                        case 'apply-bulk-time': return applyBulkTime();
                        case 'reset-team-stats': return resetTeamStats();
                        case 'pick-csv': return document.getElementById('csvInput').click();
                        case 'download-csv-template': return downloadCsvTemplate();
                        case 'send-discord-claim': return sendDiscordClaim();
                        case 'sync-all-roles': return syncAllRoles();
                        case 'quick-action': return quickAction(trigger.dataset.quick);
                        case 'close-modal': return closeModal();
                        case 'submit-round-schedule': return submitRoundSchedule();
                        case 'switch-match-tab': return switchMatchTab(trigger.dataset.tab);
                        case 'adjust-time': return adjustTime(parseInt(trigger.dataset.minutes || '15', 10));
                        case 'open-veto-page': return openVetoPage();
                        case 'open-overlay-page': return openOverlayPage();
                        case 'reset-veto': return resetVeto();
                        case 'send-admin-chat': return sendAdminChat();
                        case 'rematch-match': return rematchMatch();
                        case 'clear-stage-selection': return clearStageSelection();
                        case 'generate-stage': return generateStage();
                        case 'create-tournament': return createTournament();
                        case 'update-tourney-name': return updateTourneyName();
                        case 'delete-tourney': return deleteTourney();
                        case 'save-stage-settings': return saveStageSettings();
                        case 'save-team-edit': return saveTeamEdit();
                        case 'open-edit-match': return openEditMatch(trigger.dataset.id);
                        case 'resolve-pause': return resolvePause(trigger.dataset.id);
                        case 'admin-pause-match': return adminPauseMatch(trigger.dataset.id);
                        case 'test-audio': return testAudio(trigger.dataset.sound);
                        case 'force-winner': return forceWinner(trigger.dataset.side);
                        case 'delete-match': return deleteMatch();
                        case 'save-match-edit': return saveMatchEdit();
                        case 'select-format': return selectFormat(trigger.dataset.format);
                        case 'run-import': return runImport();
                        case 'open-match-context-menu':
                            event.stopPropagation();
                            return openMatchContextMenu(event, trigger.dataset.id);
                        case 'reset-veto-timer': return resetVetoTimer();
                        case 'close-image-viewer':
                            if (event.target.id === 'imageViewerModal') {
                                trigger.classList.add('hidden');
                                trigger.classList.remove('flex');
                            }
                            return;
                        case 'open-round-scheduler':
                            return openRoundScheduler(trigger.dataset.ids || '');
                        default:
                            return;
                    }
                };

                if (trigger.dataset.loading) {
                    await withButtonLoading(trigger, run);
                    return;
                }
                await run();
            });

            document.addEventListener('change', (event) => {
                if (event.target.matches('.js-dashboard-filter')) renderDashboard(allMatches);
                if (event.target.matches('.js-import-csv')) importTeamsCSV(event.target);
                if (event.target.matches('.js-em-format')) updateScoreInputs();
                if (event.target.matches('.js-imp-type')) toggleImpInput();
                if (event.target.matches('[data-action=\"toggle-match-select\"]')) toggleMatchSelect(event.target.dataset.id);
            });

            document.addEventListener('input', (event) => {
                if (event.target.matches('.js-dashboard-filter')) renderDashboard(allMatches);
                if (event.target.matches('.js-team-search')) renderTeams(allTeams);
                if (event.target.matches('.js-log-search')) filterLogs();
                if (event.target.matches('.js-pool-search')) renderStageLists();
            });

            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && !document.getElementById('modalBackdrop').classList.contains('hidden')) {
                    closeModal();
                }
                if (event.key === 'Enter' && event.target.matches('.js-admin-chat-input')) {
                    event.preventDefault();
                    sendAdminChat();
                }
            });

            const backdrop = document.getElementById('modalBackdrop');
            backdrop.addEventListener('click', (event) => {
                if (event.target.id === 'modalBackdrop') closeModal();
            });
        }

        setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleTimeString('th-TH', {hour12:false}), 1000);

        socket.on('match_update', ()=>init(true));
        socket.on('bracket_update', ()=>init(true));
        socket.on('teams_update', ()=>init(true)); 
        
        socket.on('veto_update', (m) => {
            // Update local data for Dashboard
            const idx = allMatches.findIndex(x => x._id === m._id);
            if (idx !== -1) {
                allMatches[idx] = m;
                // Re-render dashboard only if visible (to show live status/dots)
                if (!document.getElementById('view-dashboard').classList.contains('hidden')) {
                    renderDashboard(allMatches);
                }
            }

            // Update Modal if open
            if (activeMatchId && m._id === activeMatchId) {
                renderVetoSummary(m);
            }
        });

        socket.on('system_stats', (d) => {
            // CPU
            document.getElementById('sys-cpu').innerText = d.cpu + '%';
            document.getElementById('sys-cpu-bar').style.width = d.cpu + '%';
            // RAM
            const usedMB = (d.mem.used / 1024 / 1024).toFixed(0);
            const totalGB = (d.mem.total / 1024 / 1024 / 1024).toFixed(1);
            document.getElementById('sys-ram').innerText = usedMB + ' MB';
            document.getElementById('sys-ram-total').innerText = totalGB + ' GB';
            // Users & Uptime
            document.getElementById('sys-con').innerText = d.concurrent;
            const h = Math.floor(d.uptime / 3600); const m = Math.floor((d.uptime % 3600) / 60);
            document.getElementById('sys-uptime').innerText = `${h}h ${m}m`;
        });
        
        socket.on('notification', (data) => {
            const msg = data.message || data.msg || 'Update Received';
            const type = (msg.includes('Conflict') || msg.includes('Error')) ? 'error' : 'success';
            showToast(msg, type);
        });

        socket.on('chat_new', (data) => {
            if (activeMatchId && document.getElementById('view-tab-chat') && !document.getElementById('view-tab-chat').classList.contains('hidden')) {
                renderChatMessage(data);
            }
        });

        async function init(silent=false) {
            try {
                if (!silent) showSectionSkeletons();
                const ts = Date.now();
                const [rT, rM, rTr, rL] = await Promise.all([
                    fetch(`${API_BASE}/api/teams?t=${ts}`), 
                    fetch(`${API_BASE}/api/matches?t=${ts}`), 
                    fetch(`${API_BASE}/api/tournaments?t=${ts}`),
                    fetch(`${API_BASE}/api/admin/logs?t=${ts}`, { headers: { 'Authorization': token } })
                ]);
                
                if(rT.status === 401) { logout(); return; }
                allTeams = await rT.json();
                allMatches = await rM.json();
                allTourneys = await rTr.json();
                allLogs = rL.ok ? await rL.json() : [];
                
                updateStats(allTeams, allMatches);
                populateDashStageFilter(allTourneys);
                renderDashboard(allMatches); 
                renderRequests(allMatches);
                renderTeams(allTeams); 
                renderStructure(allTourneys, allMatches);
                filterLogs();
                
                if(!silent) {
                    const lastView = localStorage.getItem('currentView') || 'dashboard';
                    nav(lastView);
                    // Ensure checkbox rendering happens after DOM update
                    setTimeout(() => renderMapCheckboxes('create'), 100);
                }
            } catch(e) { console.error(e); }
        }

        function nav(id) {
            document.querySelectorAll('section').forEach(s=>s.classList.add('hidden'));
            document.getElementById('view-'+id).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
            document.getElementById('nav-'+id).classList.add('active');
            document.getElementById('pageTitle').innerText = id.toUpperCase();
            localStorage.setItem('currentView', id);
        }

        function getSmartTBD(matchId, slot) {
            const winnerSource = allMatches.find(m => m.nextMatchId === matchId && m.nextMatchSlot === slot);
            if (winnerSource) return `<span class="text-gray-500 text-[10px] uppercase font-bold">WINNER OF</span> <span class="text-[#ff4655]">${winnerSource.name}</span>`;
            const loserSource = allMatches.find(m => m.loserMatchId === matchId && m.loserMatchSlot === slot);
            if (loserSource) return `<span class="text-gray-500 text-[10px] uppercase font-bold">LOSER OF</span> <span class="text-orange-500">${loserSource.name}</span>`;
            return 'TBD';
        }

        // --- DRAG & DROP TEAMS LOGIC ---
        let teamDragSource = null;
        function handleTeamDragStart(e, matchId, slot) {
            if(bulkMode) { e.preventDefault(); return; }
            teamDragSource = { matchId, slot };
            e.dataTransfer.effectAllowed = "move";
            e.target.classList.add('opacity-50');
        }
        function handleTeamDragLeave(e) { e.currentTarget.classList.remove('bg-white/10'); }
        function allowDrop(e) { e.preventDefault(); e.dataTransfer.dropEffect = "move"; e.currentTarget.classList.add('bg-white/10'); }
        async function handleTeamDrop(e, targetMatchId, targetSlot) {
            e.preventDefault();
            e.currentTarget.classList.remove('bg-white/10');
            document.querySelectorAll('.opacity-50').forEach(el => el.classList.remove('opacity-50'));
            
            if (!teamDragSource) return;
            if (teamDragSource.matchId === targetMatchId && teamDragSource.slot === targetSlot) return;

            try {
                const res = await fetch(`${API_BASE}/api/matches/swap-teams`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': token },
                    body: JSON.stringify({
                        match1Id: teamDragSource.matchId, slot1: teamDragSource.slot,
                        match2Id: targetMatchId, slot2: targetSlot
                    })
                });
                if (!res.ok) { const d = await res.json(); showToast(d.msg || 'Swap Failed', 'error'); }
                else { showToast('Teams Swapped'); }
            } catch (err) { showToast('Connection Error', 'error'); }
            teamDragSource = null;
        }

        function renderMatchCard(m) {
            const [sA, sB] = calculateMatchScore(m.scores);
            const isSel = selectedMatches.has(m._id);
            const check = bulkMode ? `<div class="absolute top-3 left-3 z-20"><input type="checkbox" data-action="toggle-match-select" data-id="${m._id}" class="chk-match w-4 h-4 accent-[#ff4655] cursor-pointer" ${isSel?'checked':''}></div>` : '';
            const dateObj = m.scheduledTime ? new Date(m.scheduledTime) : null;
            const timeStr = dateObj ? dateObj.toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit'}) : 'TBA';
            const dateStr = dateObj ? dateObj.toLocaleDateString('th-TH',{day:'2-digit',month:'2-digit'}) : '';
            const isLive = m.status === 'live';
            
            const isVetoPaused = m.vetoData && m.vetoData.status === 'paused';
            const isMatchPaused = m.pauseRequest && m.pauseRequest.status === 'pending';
            const isPaused = isVetoPaused || isMatchPaused;

            let cardClass = `p-3 rounded border relative transition-all duration-200 group cursor-pointer w-full shadow-sm hover:shadow-lg hover:-translate-y-0.5`;
            
            if (isSel) cardClass += ` border-[#ff4655] bg-[#ff4655]/10`;
            else if (isPaused) cardClass += ` border-yellow-500/50 bg-yellow-500/5 hover:border-yellow-400`;
            else if (isLive) cardClass += ` border-[#ff4655] bg-[#15171a] shadow-[0_0_10px_rgba(255,70,85,0.2)]`;
            else cardClass += ` border-[#2d3139] bg-[#15171a] hover:border-gray-400`;

            let pauseAlert = '';
            if (m.pauseRequest && m.pauseRequest.status === 'pending') {
                pauseAlert = `<div class="absolute inset-0 bg-yellow-500/90 z-30 flex flex-col items-center justify-center text-black animate-pulse cursor-default">
                    <i class="fa-solid fa-pause text-3xl mb-2"></i><div class="font-bold text-xs uppercase tracking-widest">PAUSE REQUESTED</div><div class="text-[10px] font-mono mb-3">"${m.pauseRequest.reason}"</div><button data-action="resolve-pause" data-id="${m._id}" class="bg-black text-white px-4 py-1 rounded text-[10px] font-bold hover:bg-gray-800">RESOLVE</button></div>`;
            }

            let statusText = isLive ? 'LIVE' : m.status.substring(0,3);
            if (isLive && m.scores && m.scores.length > 0) {
                const lastMap = m.scores[m.scores.length-1].mapName;
                if(lastMap) statusText = `LIVE <span class="text-gray-600 mx-1"></span> ${lastMap}`;
            }

            if (compactMode) {
                return `
                <div ${!bulkMode ? `data-action="open-edit-match" data-id="${m._id}"` : ''} class="${cardClass.replace('p-3', 'p-2')} text-xs">
                    ${pauseAlert}
                    ${check}
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-[9px] font-bold text-gray-500 uppercase tracking-wider ${isLive?'text-[#ff4655] animate-pulse':''}">${statusText}</span>
                        <span class="text-[9px] font-mono text-gray-500">${timeStr}</span>
                    </div>
                    <div class="flex flex-col gap-0.5">
                        <div class="flex justify-between items-center font-medium ${sA>sB?'text-white':'text-gray-400'}">
                            <span class="truncate max-w-[100px]">${m.teamA ? m.teamA.shortName : 'TBD'}</span>
                            <span class="font-mono ${sA>sB?'text-[#ff4655]':''}">${sA}</span>
                        </div>
                        <div class="flex justify-between items-center font-medium ${sB>sA?'text-white':'text-gray-400'}">
                            <span class="truncate max-w-[100px]">${m.teamB ? m.teamB.shortName : 'TBD'}</span>
                            <span class="font-mono ${sB>sA?'text-[#ff4655]':''}">${sB}</span>
                        </div>
                    </div>
                </div>`;
            }

            const matchNumStr = m.matchNumber ? `#${String(m.matchNumber).padStart(3, '0')}` : '';
            
            // Progression
            const getShortName = (id) => {
                const t = allMatches.find(x => x._id === id);
                return t ? t.name.replace(/Upper Bracket|UB/gi, 'UB').replace(/Lower Bracket|LB/gi, 'LB').replace(/Round /gi, 'R') : '';
            };
            const nextWin = m.nextMatchId ? getShortName(m.nextMatchId) : null;
            const nextLose = m.loserMatchId ? getShortName(m.loserMatchId) : null;

            const renderTeamRow = (team, slot, score, isWinner) => {
                const teamId = team ? team._id : '';
                const logo = team ? `<img src="${team.logo || DEFAULT_LOGO}" class="w-5 h-5 rounded object-cover bg-black/50 shrink-0 border border-white/10">` : '<div class="w-5 h-5 rounded bg-white/5 shrink-0 border border-white/5 flex items-center justify-center"><i class="fa-solid fa-question text-[8px] text-gray-600"></i></div>';
                const nameHtml = team ? `<span class="truncate">${team.shortName}</span>` : getSmartTBD(m._id, slot);
                const scoreColor = isWinner ? 'text-[#ff4655]' : '';
                const textColor = isWinner ? 'text-white' : 'text-gray-400';
                
                return `
                <div draggable="true" 
                    ondragstart="handleTeamDragStart(event, '${m._id}', '${slot}')" 
                    ondragover="allowDrop(event)" 
                    ondragleave="handleTeamDragLeave(event)"
                    ondrop="handleTeamDrop(event, '${m._id}', '${slot}')" 
                    onmouseenter="highlightTeam('${teamId}')" 
                    onmouseleave="resetHighlight()"
                    class="flex justify-between items-center text-sm font-medium ${textColor} transition-colors p-1.5 -mx-1.5 rounded hover:bg-white/5 cursor-grab active:cursor-grabbing border border-transparent hover:border-white/10 group/team">
                    <div class="flex items-center gap-2 overflow-hidden pointer-events-none">
                        <i class="fa-solid fa-grip-vertical text-gray-700 group-hover/team:text-gray-500 text-[10px] mr-1"></i>
                        ${logo}
                        ${nameHtml}
                    </div>
                    <span class="font-mono ${scoreColor} pointer-events-none">${score}</span>
                </div>`;
            };

            const menuBtn = !bulkMode ? `
            <div class="absolute top-2 right-2 z-20 opacity-0 group-hover:opacity-100 transition-all duration-200">
                <button data-action="open-match-context-menu" data-id="${m._id}" class="w-6 h-6 bg-[#1a1d21] border border-[#333] hover:border-gray-400 text-gray-400 hover:text-white rounded flex items-center justify-center shadow-lg">
                    <i class="fa-solid fa-ellipsis-vertical text-[10px]"></i>
                </button>
            </div>` : '';

            // --- VETO STATUS & CONTROLS ---
            const isVeto = m.status === 'scheduled' && m.vetoData && ['in_progress', 'decision', 'coin_toss', 'paused'].includes(m.vetoData.status);
            let vetoUI = '';
            
            if (isVeto) {
                const v = m.vetoData;
                const pA = m.presence && m.presence[m.teamA._id];
                const pB = m.presence && m.presence[m.teamB._id];
                const getDot = (p) => p ? (p.isAway ? 'text-yellow-500' : 'text-[#1fa474]') : 'text-gray-600';
                
                let statusText = v.status.toUpperCase().replace('_', ' ');
                let timerHtml = '';

                if (v.status === 'in_progress') {
                    const step = v.sequence[v.sequenceIndex];
                    const tName = (step.team === m.teamA._id) ? m.teamA.shortName : m.teamB.shortName;
                    statusText = `${tName} ${step.act.toUpperCase()}`;
                } else if (v.status === 'paused') {
                    statusText = "PAUSED";
                }

                if ((v.status === 'in_progress' || v.status === 'decision') && v.currentTurnDeadline) {
                    const deadlineTs = new Date(v.currentTurnDeadline).getTime();
                    timerHtml = `<span class="veto-countdown ml-1 text-[#ff4655]" data-deadline="${deadlineTs}"></span>`;
                }

                const btnAction = v.status === 'paused' 
                    ? `<button data-action="resolve-pause" data-id="${m._id}" class="px-2 py-0.5 bg-green-500/20 text-green-500 border border-green-500/50 rounded text-[9px] font-bold uppercase hover:bg-green-500 hover:text-white transition">RESUME</button>`
                    : `<button data-action="admin-pause-match" data-id="${m._id}" class="px-2 py-0.5 bg-yellow-500/20 text-yellow-500 border border-yellow-500/50 rounded text-[9px] font-bold uppercase hover:bg-yellow-500 hover:text-black transition">PAUSE</button>`;

                vetoUI = `
                <div class="mt-2 pt-2 border-t border-white/5 flex justify-between items-center bg-black/20 p-1.5 rounded">
                    <div class="flex items-center gap-3"><div class="flex items-center gap-1" title="Team A Connection"><i class="fa-solid fa-circle text-[8px] ${getDot(pA)}"></i><span class="text-[9px] font-bold text-gray-400">${m.teamA.shortName}</span></div><div class="flex items-center gap-1" title="Team B Connection"><i class="fa-solid fa-circle text-[8px] ${getDot(pB)}"></i><span class="text-[9px] font-bold text-gray-400">${m.teamB.shortName}</span></div></div>
                    <div class="flex items-center gap-2"><span class="text-[9px] font-mono text-white tracking-wider flex items-center">${statusText}${timerHtml}</span>${btnAction}</div>
                </div>`;
            }

            return `
            <div ${!bulkMode ? `data-action="open-edit-match" data-id="${m._id}"` : ''} class="${cardClass}">
                ${pauseAlert}
                ${check}
                <div class="flex justify-between items-start mb-3 border-b border-white/5 pb-2">
                    <div class="flex flex-col">
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] font-bold uppercase tracking-wider ${isLive?'text-[#ff4655] animate-pulse':'text-gray-500'}">${statusText}</span>
                            ${matchNumStr ? `<span class="text-[9px] font-mono text-gray-600 bg-black/20 px-1 rounded">${matchNumStr}</span>` : ''}
                        </div>
                    </div>
                    <div class="text-right">
                        <span class="text-[10px] font-mono text-gray-400 block leading-none">${timeStr}</span>
                        ${dateStr ? `<span class="text-[9px] font-mono text-gray-600 block leading-none mt-0.5">${dateStr}</span>` : ''}
                    </div>
                </div>
                ${menuBtn}
                <div class="flex flex-col gap-1.5 relative z-10">
                    ${renderTeamRow(m.teamA, 'teamA', sA, sA > sB)}
                    ${renderTeamRow(m.teamB, 'teamB', sB, sB > sA)}
                </div>
                ${vetoUI}
            </div>`;
        }

        // --- UPDATED RENDER STRUCTURE WITH TABS ---
        function renderStructure(tourneys, matches) {
            const list = document.getElementById('stageList');
            if(!tourneys.length) { 
                document.getElementById('mainTourneyHeader').innerHTML = `<div class="text-center w-full py-10"><div class="text-[#ff4655] text-5xl mb-4"><i class="fa-solid fa-server"></i></div><h3 class="text-xl text-white font-header">SYSTEM UNINITIALIZED</h3><button onclick="openModal('createTourneyModal'); renderMapCheckboxes('create');" class="btn-val px-8 py-3 rounded mt-6 text-sm font-bold tracking-widest">INITIALIZE NEW TOURNAMENT</button></div>`; 
                list.innerHTML = ''; 
                return; 
            }
            
            const t = tourneys[0]; 
            activeTourneyData = t; 
            if (activeStageIndex === undefined) activeStageIndex = 'overview';
            
            // Safety check for activeStageIndex
            if (activeStageIndex !== 'overview' && activeStageIndex >= t.stages.length) activeStageIndex = 'overview';

            // 1. Render Header & Tab Bar
            let tabsHtml = `<button onclick="activeStageIndex='overview'; renderStructure([activeTourneyData], allMatches)" class="px-6 py-3 text-sm font-bold uppercase tracking-wider border-b-2 transition shrink-0 ${activeStageIndex === 'overview' ? 'border-[#ff4655] text-white bg-white/5' : 'border-transparent text-gray-500 hover:text-gray-300'}">OVERVIEW</button>`;
            
            tabsHtml += t.stages.map((s, idx) => {
                const isActive = idx === activeStageIndex;
                return `<button onclick="activeStageIndex=${idx}; renderStructure([activeTourneyData], allMatches)" 
                class="px-6 py-3 text-sm font-bold uppercase tracking-wider border-b-2 transition shrink-0 ${isActive ? 'border-[#ff4655] text-white bg-white/5' : 'border-transparent text-gray-500 hover:text-gray-300'}">
                ${s.name}
                </button>`;
            }).join('');

            // Add Stage Button
            tabsHtml += `<button onclick="openStageModal()" class="px-4 py-3 text-sm font-bold uppercase tracking-wider text-[#ff4655] hover:bg-[#ff4655]/10 transition ml-2"><i class="fa-solid fa-plus"></i></button>`;

            document.getElementById('mainTourneyHeader').innerHTML = `
                <div class="flex flex-col gap-6 w-full">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="text-[10px] text-[#ff4655] font-bold uppercase tracking-[0.2em] mb-1">Active Protocol</div>
                            <h2 class="text-4xl font-header text-white">${t.name}</h2>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="toggleCompactMode()" id="btnCompactMode" class="px-4 py-2 border border-[#333] ${compactMode ? 'bg-[#ff4655] text-white border-[#ff4655]' : 'text-gray-400'} hover:text-white rounded text-xs font-bold uppercase transition"><i class="fa-solid fa-compress mr-2"></i> Compact</button>
                            <button onclick="toggleBulkMode()" id="btnBulkMode" class="px-4 py-2 border border-[#333] text-gray-400 hover:text-white rounded text-xs font-bold uppercase transition"><i class="fa-solid fa-list-check mr-2"></i> Batch Mode</button>
                        </div>
                    </div>
                    <div class="flex border-b border-[#333] w-full overflow-x-auto custom-scroll">
                        ${tabsHtml}
                    </div>
                </div>
            `;

            // 2. Render Content (Only active stage)
            if (activeStageIndex === 'overview') {
                const currentPool = t.mapPool && t.mapPool.length > 0 ? t.mapPool : ALL_MAPS;
                
                list.innerHTML = `
                <div class="animate-slide-up grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 space-y-6">
                        <div class="bg-[#1a1d21] p-6 rounded border border-[#2d3139]">
                            <h3 class="text-white font-header text-xl mb-4 border-l-4 border-[#ff4655] pl-3">General Information</h3>
                            <div class="space-y-4">
                                <div class="space-y-2"><label class="text-xs text-gray-500 font-bold uppercase">Tournament Name</label><input id="ovName" value="${t.name}" class="w-full input-dark text-lg font-bold"></div>
                                <div class="space-y-2"><label class="text-xs text-gray-500 font-bold uppercase">Prize Pool</label><input id="ovPrize" value="${t.prizePool || ''}" class="w-full input-dark" placeholder="e.g. $10,000"></div>
                                <div class="space-y-2"><label class="text-xs text-gray-500 font-bold uppercase">Format Description</label><textarea id="ovFormat" class="w-full input-dark h-40 custom-scroll bg-transparent border-b-2 border-[#2d3139] focus:border-[#ff4655] outline-none resize-none font-mono text-sm" placeholder="HTML or Text supported">${t.formatDescription || ''}</textarea></div>
                            </div>
                        </div>
                        <div class="flex justify-end"><button onclick="saveOverview()" class="btn-val px-8 py-3 rounded font-bold text-sm tracking-widest shadow-lg">SAVE CHANGES</button></div>
                    </div>
                    <div class="space-y-6">
                        <div class="bg-[#1a1d21] p-6 rounded border border-[#2d3139]">
                            <div class="flex justify-between items-end mb-4">
                                <h3 class="text-white font-header text-xl border-l-4 border-[#ff4655] pl-3">Map Pool</h3>
                                <span id="count-overview" class="text-xs font-mono font-bold text-[#ff4655]">0/7</span>
                            </div>
                            <div id="overviewMapPoolList" class="map-select-grid custom-scroll h-[400px]"></div>
                        </div>
                    </div>
                </div>`;
                
                setTimeout(() => renderMapCheckboxes('overview', currentPool), 50);

            } else if (t.stages.length > 0 && t.stages[activeStageIndex]) {
                const s = t.stages[activeStageIndex];
                const ms = s.matches.map(mid => matches.find(x=>x._id===mid)).filter(x=>x);
                
                let contentHtml = '';
                let swissBtn = '';
                let settingsBtn = '';
                let manageTeamsBtn = '';
                if (s.type === 'swiss') swissBtn = `<button onclick="generateSwissNext('${t._id}', ${activeStageIndex})" class="btn-val px-4 py-2 rounded text-[10px] font-bold ml-4">GENERATE ROUND</button>`;
                if (s.type === 'round_robin' || s.type === 'swiss') {
                     settingsBtn = `<button onclick="openStageSettings('${t._id}', ${activeStageIndex})" class="text-gray-400 hover:text-white text-xs font-bold uppercase ml-4 border border-[#333] px-3 py-1 rounded hover:bg-[#333] transition"><i class="fa-solid fa-sliders mr-2"></i> Settings</button>`;
                }
                if (s.type === 'round_robin' || s.type === 'cross_group') {
                     manageTeamsBtn = `<button onclick="openManageTeams('${t._id}', ${activeStageIndex})" class="text-blue-400 hover:text-white text-xs font-bold uppercase ml-4 border border-[#333] px-3 py-1 rounded hover:bg-[#333] transition"><i class="fa-solid fa-users-gear mr-2"></i> Manage Teams</button>`;
                }

                const stageControls = `
                    <div class="flex justify-between items-center mb-6 bg-[#1a1d21] p-4 rounded border border-[#2d3139]">
                        <div class="flex items-center gap-4">
                            <span class="text-xs text-gray-500 font-bold uppercase tracking-widest">Type: <span class="text-white">${s.type.replace('_',' ')}</span></span>
                            ${swissBtn}
                            ${settingsBtn}
                            ${manageTeamsBtn}
                            <button onclick="exportStageCSV('${t._id}', ${activeStageIndex})" class="text-green-500 hover:text-green-400 text-xs font-bold uppercase ml-4"><i class="fa-solid fa-file-csv mr-2"></i> Export CSV</button>
                        </div>
                        <button onclick="deleteStage('${t._id}', ${activeStageIndex})" class="text-red-500 hover:text-red-400 text-xs font-bold uppercase"><i class="fa-solid fa-trash mr-2"></i> Delete Stage</button>
                    </div>
                `;

                if (s.type === 'round_robin' || s.type === 'swiss' || s.type === 'gsl' || s.type === 'cross_group') {
                    if (s.type === 'cross_group') {
                        const participants = s.stageParticipants || [];
                        const mid = Math.ceil(participants.length / 2);
                        const alphaIds = participants.slice(0, mid);
                        const omegaIds = participants.slice(mid);
                        
                        const allParticipants = new Set();
                        ms.forEach(m => { if(m.teamA) allParticipants.add(m.teamA._id || m.teamA); if(m.teamB) allParticipants.add(m.teamB._id || m.teamB); });
                        const globalStandings = calculateStandings(ms, Array.from(allParticipants), s.settings);
                        
                        const alphaStandings = globalStandings.filter(st => alphaIds.includes(st.id));
                        const omegaStandings = globalStandings.filter(st => omegaIds.includes(st.id));

                        const renderAdminTable = (title, standings, color) => {
                            const rows = standings.map((st, i) => `
                                <tr class="hover:bg-[#222] transition-colors border-b border-[#222] last:border-0">
                                    <td class="py-3 px-4 text-center font-mono text-gray-500 border-r border-[#222]">${i+1}</td>
                                    <td class="py-3 px-4 font-bold text-white">${st.name}</td>
                                    <td class="py-3 px-4 text-center text-gray-300">${st.played}</td>
                                    <td class="py-3 px-4 text-center font-bold text-green-400 bg-green-500/5">${st.wins}</td>
                                    <td class="py-3 px-4 text-center font-bold text-red-400 bg-red-500/5">${st.losses}</td>
                                    <td class="py-3 px-4 text-center font-mono text-gray-400 border-l border-[#222]">${st.mapsWon}-${st.mapsLost}</td>
                                    <td class="py-3 px-4 text-center font-mono font-bold ${st.mapDiff>0?'text-green-400':(st.mapDiff<0?'text-red-400':'text-gray-500')}">${st.mapDiff>0?'+':''}${st.mapDiff}</td>
                                    <td class="py-3 px-4 text-center font-mono font-bold ${st.diff>0?'text-green-400':(st.diff<0?'text-red-400':'text-gray-500')} border-l border-[#222]">${st.diff>0?'+':''}${st.diff}</td>
                                </tr>`).join('');
                            return `<div class="bg-[#15171a] border border-[#2d3139] rounded-lg overflow-hidden shadow-sm mb-4"><div class="px-4 py-3 bg-[#1a1d21] border-b border-[#2d3139] flex justify-between items-center"><span class="text-xs font-bold ${color} uppercase tracking-widest">${title}</span><i class="fa-solid fa-table text-gray-600"></i></div><table class="w-full text-sm text-left border-collapse"><thead class="text-xs text-gray-500 uppercase bg-[#111] border-b border-[#2d3139]"><tr><th class="py-3 px-4 text-center w-12">#</th><th class="py-3 px-4">Team</th><th class="py-3 px-4 text-center w-12" title="Played">P</th><th class="py-3 px-4 text-center w-12" title="Wins">W</th><th class="py-3 px-4 text-center w-12" title="Losses">L</th><th class="py-3 px-4 text-center w-20 border-l border-[#2d3139]">Maps</th><th class="py-3 px-4 text-center w-14">M</th><th class="py-3 px-4 text-center w-14 border-l border-[#2d3139]">R</th></tr></thead><tbody>${rows}</tbody></table></div>`;
                        };

                        const rounds = {}; ms.forEach(m => { if(!rounds[m.round]) rounds[m.round] = []; rounds[m.round].push(m); });
                        let matchesListHtml = '';
                        Object.keys(rounds).sort((a,b)=>parseInt(a)-parseInt(b)).forEach(r => {
                            const roundMatches = rounds[r]; const matchIds = roundMatches.map(m => m._id).join(','); const label = `Round ${r}`;
                            matchesListHtml += createRoundSection(label, matchIds, roundMatches.map(m => renderMatchCard(m)).join(''));
                        });

                        contentHtml += `<div class="animate-slide-up">${stageControls}<div class="p-6 grid grid-cols-1 xl:grid-cols-12 gap-8"><div class="xl:col-span-5">${renderAdminTable('GROUP ALPHA', alphaStandings, 'text-[#ff4655]')}${renderAdminTable('GROUP OMEGA', omegaStandings, 'text-[#00d4ff]')}</div><div class="xl:col-span-7"><div class="flex items-center justify-between mb-4"><span class="text-xs font-bold text-gray-400 uppercase tracking-widest">Match Schedule</span></div><div class="max-h-[600px] overflow-y-auto custom-scroll pr-2">${matchesListHtml}</div></div></div></div>`;
                        list.innerHTML = contentHtml;
                        return;
                    }

                    const matchesByGroup = {};
                    ms.forEach(m => {
                        const gMatch = m.name.match(/(?:Group|Grp)\s+([A-Z0-9]{1,2})\b/i);
                        const groupName = gMatch ? `Group ${gMatch[1].toUpperCase()}` : 'General';
                        if(!matchesByGroup[groupName]) matchesByGroup[groupName] = [];
                        matchesByGroup[groupName].push(m);
                    });

                    contentHtml = `<div class="animate-slide-up">${stageControls}`;

                    Object.keys(matchesByGroup).sort().forEach(gName => {
                        const gMatches = matchesByGroup[gName];
                        let groupContent = '';
                        
                        if (s.type === 'gsl') {
                            const openA = gMatches.find(m => m.name.includes('Opening A'));
                            const openB = gMatches.find(m => m.name.includes('Opening B'));
                            const winners = gMatches.find(m => m.name.includes('Winners'));
                            const elim = gMatches.find(m => m.name.includes('Elimination'));
                            const decider = gMatches.find(m => m.name.includes('Decider'));
                            const mCard = (m) => m ? renderMatchCard(m) : '<div class="p-4 text-center text-gray-600 bg-[#15171a] border border-[#2d3139] rounded text-xs font-bold uppercase tracking-widest">TBD</div>';

                            groupContent = `
                                <div class="p-6 overflow-x-auto">
                                    <div class="flex gap-8 min-w-max">
                                        <div class="flex flex-col gap-4 w-80">
                                            <div class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-2 border-b border-[#333] pb-1">Opening Matches</div>
                                            ${mCard(openA)}
                                            ${mCard(openB)}
                                        </div>
                                        <div class="flex flex-col justify-between w-80">
                                            <div>
                                                <div class="text-xs font-bold text-[#1fa474] uppercase tracking-widest mb-2 border-b border-[#1fa474]/30 pb-1">Winners Match</div>
                                                ${mCard(winners)}
                                            </div>
                                            <div>
                                                <div class="text-xs font-bold text-[#ff4655] uppercase tracking-widest mb-2 border-b border-[#ff4655]/30 pb-1">Elimination Match</div>
                                                ${mCard(elim)}
                                            </div>
                                        </div>
                                        <div class="flex flex-col justify-center w-80">
                                            <div class="text-xs font-bold text-yellow-500 uppercase tracking-widest mb-2 border-b border-yellow-500/30 pb-1">Decider Match</div>
                                            ${mCard(decider)}
                                        </div>
                                    </div>
                                </div>
                            `;
                        } else {
                            // Round Robin / Swiss
                            const groupParticipants = new Set();
                            gMatches.forEach(m => { if(m.teamA) groupParticipants.add(m.teamA._id || m.teamA); if(m.teamB) groupParticipants.add(m.teamB._id || m.teamB); });
                            const standings = calculateStandings(gMatches, Array.from(groupParticipants), s.settings);
                            const rows = createStandingsRows(standings);
                            
                            const tableHtml = `
                                <div class="bg-[#15171a] border border-[#2d3139] rounded-lg overflow-hidden shadow-sm">
                                    <div class="px-4 py-3 bg-[#1a1d21] border-b border-[#2d3139] flex justify-between items-center">
                                        <span class="text-xs font-bold text-gray-400 uppercase tracking-widest">Group Standings</span>
                                        <i class="fa-solid fa-table text-gray-600"></i>
                                    </div>
                                    <table class="w-full text-sm text-left border-collapse">
                                        <thead class="text-xs text-gray-500 uppercase bg-[#111] border-b border-[#2d3139]">
                                            <tr>
                                                <th class="py-3 px-4 text-center w-12">#</th>
                                                <th class="py-3 px-4">Team</th>
                                                <th class="py-3 px-4 text-center w-12" title="Played">P</th>
                                                <th class="py-3 px-4 text-center w-12" title="Wins">W</th>
                                                <th class="py-3 px-4 text-center w-12" title="Losses">L</th>
                                                <th class="py-3 px-4 text-center w-20 border-l border-[#2d3139]">Maps</th>
                                                <th class="py-3 px-4 text-center w-14">M</th>
                                                <th class="py-3 px-4 text-center w-14 border-l border-[#2d3139]">R</th>
                                            </tr>
                                        </thead>
                                        <tbody>${rows}</tbody>
                                    </table>
                                </div>`;
                            
                            const rounds = {}; gMatches.forEach(m => { if(!rounds[m.round]) rounds[m.round] = []; rounds[m.round].push(m); });
                            let matchesListHtml = '';
                            Object.keys(rounds).sort((a,b)=>parseInt(a)-parseInt(b)).forEach(r => {
                                const roundMatches = rounds[r]; const matchIds = roundMatches.map(m => m._id).join(','); const label = `Round ${r}`;
                                matchesListHtml += createRoundSection(label, matchIds, roundMatches.map(m => renderMatchCard(m)).join(''));
                            });
                            groupContent = `<div class="p-6 grid grid-cols-1 xl:grid-cols-12 gap-8"><div class="xl:col-span-5">${tableHtml}</div><div class="xl:col-span-7"><div class="flex items-center justify-between mb-4"><span class="text-xs font-bold text-gray-400 uppercase tracking-widest">Match Schedule</span></div><div class="max-h-[600px] overflow-y-auto custom-scroll pr-2">${matchesListHtml}</div></div></div>`;
                        }

                        contentHtml += `
                            <div class="mb-10 bg-[#15171a] border border-[#2d3139] rounded-lg overflow-hidden">
                                <div class="bg-[#1a1d21] px-6 py-4 border-b border-[#2d3139] flex justify-between items-center"><h3 class="text-lg font-header text-white tracking-wide border-l-4 border-[#ff4655] pl-3">${gName}</h3><span class="text-xs font-mono text-gray-500">${s.type.toUpperCase().replace('_',' ')}</span></div>
                                ${groupContent}
                            </div>
                        `;
                    });
                    
                    contentHtml += `</div>`;
                }
                else {
                    // Group matches by Group Name
                    const groups = {};
                    ms.forEach(m => { 
                        const matchGroup = m.name.match(/(?:Group|Grp)\s+([A-Z0-9]{1,2})\b/i);
                        const gName = matchGroup ? `Group ${matchGroup[1].toUpperCase()}` : 'Main Bracket';
                        if (!groups[gName]) groups[gName] = [];
                        groups[gName].push(m);
                    });

                    const sortedGroups = Object.keys(groups).sort();
                    let groupsHtml = '';

                    sortedGroups.forEach((gName, idx) => {
                        const groupMatches = groups[gName];
                        const upper = [], middle = [], lower = [], final = [];
                        groupMatches.forEach(m => { 
                            if(m.matchOrder === 999 || m.round === 999) final.push(m); 
                            else if(m.round >= 200) lower.push(m); 
                            else if(m.round >= 100) middle.push(m); 
                            else upper.push(m); 
                        });

                        // Merge Final into Upper for continuous display
                        const upperAndFinal = [...upper, ...final];

                        const renderSection = (matches, label, color = 'border-[#ff4655]') => {
                            if(matches.length === 0) return '';
                            const rounds = {}; matches.forEach(m => { if(!rounds[m.round]) rounds[m.round] = []; rounds[m.round].push(m); });
                            const sortedRounds = Object.keys(rounds).sort((a,b) => parseInt(a)-parseInt(b));
                            const columnsHtml = sortedRounds.map(r => {
                                const roundMatches = rounds[r].sort((a,b) => a.matchOrder - b.matchOrder); const matchIds = roundMatches.map(m => m._id).join(',');
                                let displayRound = `Round ${r}`;
                                if (parseInt(r) === 999) displayRound = "Grand Final";
                                else if (parseInt(r) >= 200) displayRound = `Round ${r - 200}`;
                                else if (parseInt(r) >= 100) displayRound = `Round ${r - 100}`;
                                
                                const widthStyle = compactMode ? 'min-width: 200px;' : '';
                                return `<div class="bracket-round" style="${widthStyle}"><div class="bracket-header"><span>${displayRound}</span><button data-action="open-round-scheduler" data-ids="${matchIds}" class="text-gray-500 hover:text-white transition" title="Set Time"><i class="fa-regular fa-clock"></i></button></div><div class="flex flex-col justify-around flex-1">${roundMatches.map(m => `<div id="bracket-match-${m._id}" class="relative z-10 bracket-node">${renderMatchCard(m)}</div>`).join('')}</div></div>`;
                            }).join('');
                            return `<div class="mb-8 relative z-10"><div class="text-xs font-bold text-white uppercase tracking-widest mb-4 pl-1 border-l-4 ${color} py-1 bg-[#1a1d21] inline-block pr-4 rounded-r">${label}</div><div class="bracket-container" style="overflow: visible">${columnsHtml}</div></div>`;
                        };

                        const upperSection = renderSection(upperAndFinal, "Upper Bracket", "border-[#ff4655]");
                        const middleLabel = s.type === 'triple_elim' ? "Middle Bracket" : "Lower Bracket";
                        const middleColor = s.type === 'triple_elim' ? "border-[#dda828]" : "border-[#00d4ff]";
                        const middleSection = renderSection(middle, middleLabel, middleColor);
                        const lowerSection = s.type === 'triple_elim'
                            ? renderSection(lower, "Lower Bracket", "border-[#00d4ff]")
                            : '';

                        groupsHtml += `
                            <div class="mb-16 bg-[#15171a]/50 border border-[#333] rounded-lg p-6 relative">
                                ${sortedGroups.length > 1 ? `<h3 class="text-xl font-header text-white mb-6 border-l-4 border-[#ff4655] pl-3">${gName}</h3>` : ''}
                                <div class="overflow-x-auto relative">
                                    <div class="relative min-w-max">
                                        <svg id="bracketSvg-${idx}" class="absolute inset-0 w-full h-full pointer-events-none z-0"></svg>
                                        ${upperSection}
                                        ${middleSection}
                                        ${lowerSection}
                                    </div>
                                </div>
                            </div>`;
                    });

                    contentHtml = `<div class="animate-slide-up">${stageControls}<div class="p-8">${groupsHtml}</div></div>`;
                    
                    setTimeout(() => {
                        sortedGroups.forEach((gName, idx) => {
                            drawBracketLines(groups[gName], `bracketSvg-${idx}`);
                        });
                    }, 50);
                }

                list.innerHTML = contentHtml;
            } else {
                list.innerHTML = `<div class="p-20 text-center text-gray-500 italic border-2 border-dashed border-[#333] rounded-lg mt-4">No stages found. Create one to begin.</div>`;
            }
        }

        function openRoundScheduler(ids) { pendingRoundScheduleMatches = ids.split(','); document.getElementById('rsCount').innerText = pendingRoundScheduleMatches.length; openModal('roundSchedulerModal'); }
        async function submitRoundSchedule() {
            const time = document.getElementById('rsTime').value;
            if(!time || pendingRoundScheduleMatches.length === 0) return;
            const promises = pendingRoundScheduleMatches.map(id => fetch(`${API_BASE}/api/matches/${id}`, { method: 'PUT', headers: {'Authorization': token, 'Content-Type': 'application/json'}, body: JSON.stringify({ scheduledTime: time }) }));
            await Promise.all(promises); closeModal(); init(true); showToast("Round Schedule Updated");
        }

        function calculateStandings(matches, participants, settings) {
            let stats = {}; 
            participants.forEach(pid => { const team = allTeams.find(t=>t._id === pid); if(team) stats[pid] = { id: pid, name: team.shortName, wins:0, losses:0, played:0, diff:0, mapsWon:0, mapsLost:0, mapDiff:0, h2h: {}, group: 'A' }; });
            
            matches.forEach(m => {
                const gMatch = m.name.match(/(?:Group|Grp)\s+([A-Z0-9]{1,2})\b/i);
                const group = gMatch ? gMatch[1] : 'A';
                if (m.teamA && stats[m.teamA._id || m.teamA]) stats[m.teamA._id || m.teamA].group = group;
                if (m.teamB && stats[m.teamB._id || m.teamB]) stats[m.teamB._id || m.teamB].group = group;

                if(m.status === 'finished' && m.winner) {
                    const winnerId = m.winner._id || m.winner; const loserId = (m.teamA._id === winnerId || m.teamA === winnerId) ? (m.teamB._id || m.teamB) : (m.teamA._id || m.teamA);
                    
                    if(stats[winnerId]) { 
                        stats[winnerId].wins++; stats[winnerId].played++; 
                        stats[winnerId].h2h[loserId] = 'win';
                    } 
                    if(stats[loserId]) { 
                        stats[loserId].losses++; stats[loserId].played++; 
                        stats[loserId].h2h[winnerId] = 'loss';
                    }
                    
                    let sA = 0, sB = 0; let mapsA = 0, mapsB = 0;
                    if(m.scores && m.scores.length > 0) {
                        m.scores.forEach(s => { const scA = parseInt(s.teamAScore)||0; const scB = parseInt(s.teamBScore)||0; sA += scA; sB += scB; if (scA > scB) mapsA++; else if (scB > scA) mapsB++; });
                        const tA = m.teamA._id || m.teamA; const tB = m.teamB._id || m.teamB;
                        if(stats[tA]) { stats[tA].diff += (sA - sB); stats[tA].mapsWon += mapsA; stats[tA].mapsLost += mapsB; stats[tA].mapDiff += (mapsA - mapsB); }
                        if(stats[tB]) { stats[tB].diff += (sB - sA); stats[tB].mapsWon += mapsB; stats[tB].mapsLost += mapsA; stats[tB].mapDiff += (mapsB - mapsA); }
                    }
                }
            });
            
            const tiebreakers = settings?.tiebreakers || ['h2h', 'map_diff', 'round_diff'];

            return Object.values(stats).sort((a,b) => { 
                if(b.wins !== a.wins) return b.wins - a.wins;
                
                for (const rule of tiebreakers) {
                    if (rule === 'h2h') {
                        if (a.h2h[b.id]) return a.h2h[b.id] === 'win' ? -1 : 1;
                    } else if (rule === 'map_diff') {
                        if (b.mapDiff !== a.mapDiff) return b.mapDiff - a.mapDiff;
                    } else if (rule === 'round_diff') {
                        if (b.diff !== a.diff) return b.diff - a.diff;
                    }
                }
                return 0;
            });
        }

        function populateDashStageFilter(tourneys) {
            const sel = document.getElementById('dashStageFilter');
            if (!sel) return;
            const current = sel.value;
            let html = '<option value="all">All Stages</option>';
            tourneys.forEach(t => {
                t.stages.forEach((s, i) => {
                    html += `<option value="${t._id}_${i}">${t.name} - ${s.name}</option>`;
                });
            });
            sel.innerHTML = html;
            if (current && sel.querySelector(`option[value="${current}"]`)) sel.value = current;
        }

        function renderDashboard(matches) {
            const query = document.getElementById('dashSearch')?.value.toLowerCase() || '';
            const stageFilter = document.getElementById('dashStageFilter')?.value || 'all';
            
            let stageMatchIds = null;
            if (stageFilter !== 'all') {
                const [tid, sIdx] = stageFilter.split('_');
                const t = allTourneys.find(x => x._id === tid);
                if (t && t.stages[sIdx]) stageMatchIds = new Set(t.stages[sIdx].matches);
            }

            const filtered = matches.filter(m => {
                if (stageMatchIds && !stageMatchIds.has(m._id)) return false;
                return (m.name.toLowerCase().includes(query) || m.teamA?.name.toLowerCase().includes(query) || m.teamB?.name.toLowerCase().includes(query));
            });

            const vetoing = [], live = [], upcoming = [], finished = [];
            filtered.forEach(m => {
                if (m.status === 'live') live.push(m);
                else if (m.status === 'scheduled') {
                    if (m.vetoData && (m.vetoData.status === 'in_progress' || m.vetoData.status === 'decision' || m.vetoData.status === 'coin_toss' || m.vetoData.status === 'paused')) vetoing.push(m);
                    else upcoming.push(m);
                } else if (m.status === 'finished') finished.push(m);
            });

            upcoming.sort((a, b) => new Date(a.scheduledTime) - new Date(b.scheduledTime));
            finished.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));

            const container = document.getElementById('liveMatches');
            container.innerHTML = '';

            const renderSection = (title, items, icon, color) => {
                if (items.length === 0) return '';
                return `
                    <div class="col-span-full mb-2 mt-4 flex items-center gap-2 border-b border-white/5 pb-2">
                        <i class="${icon} ${color}"></i><h4 class="text-sm font-bold text-white uppercase tracking-widest">${title} <span class="text-gray-500 text-xs ml-2">(${items.length})</span></h4>
                    </div>
                    ${items.map(m => renderMatchCard(m)).join('')}`;
            };

            let html = renderSection('Veto In Progress', vetoing, 'fa-solid fa-list-check', 'text-yellow-500') +
                       renderSection('Live Matches', live, 'fa-solid fa-tower-broadcast', 'text-[#ff4655]') +
                       renderSection('Upcoming / Scheduled', upcoming, 'fa-regular fa-clock', 'text-blue-400') +
                       renderSection('Recently Finished', finished.slice(0, 8), 'fa-solid fa-flag-checkered', 'text-green-500');
            
            container.innerHTML = html || '<div class="col-span-full text-center text-gray-600 text-sm italic py-10 bg-[#15171a] rounded border border-[#2d3139]">No matches found</div>';
        }
        
        // --- UPDATED RENDER TEAMS WITH CARD STYLE ---
        function renderTeams(t){
            const pendingCount = t.filter(x => x.status === 'pending').length; const nameChangeCount = t.filter(x => x.members.some(m => m.pendingUpdate)).length; const totalAction = pendingCount + nameChangeCount;
            const badge = document.getElementById('navBadgeTeams'); if (totalAction > 0) { badge.innerText = totalAction; badge.classList.remove('hidden'); } else { badge.classList.add('hidden'); }
            
            const query = document.getElementById('teamSearch')?.value.toLowerCase() || '';
            const filtered = t.filter(x => x.name.toLowerCase().includes(query) || x.shortName.toLowerCase().includes(query));

            document.getElementById('teamGrid').innerHTML = filtered.map(x => {
                const isPending = x.status === 'pending'; 
                const hasNameChange = x.members.some(m => m.pendingUpdate);
                const totalMatches = (x.wins || 0) + (x.losses || 0);
                const winRate = totalMatches > 0 ? Math.round((x.wins / totalMatches) * 100) : 0;
                
                return `
                <div class="bg-[#15171a] p-0 border border-[#2d3139] rounded-lg relative overflow-hidden group team-card-hover transition duration-200 hover:border-[#ff4655]/50">
                    ${isPending ? '<div class="status-indicator bg-yellow-500 animate-pulse"></div>' : ''}
                    ${hasNameChange && !isPending ? '<div class="status-indicator bg-orange-500"></div>' : ''}
                    
                    <div class="p-5 flex items-start justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-14 h-14 rounded bg-[#0f1113] border border-[#333] overflow-hidden flex-shrink-0">
                                <img src="${x.logo||DEFAULT_LOGO}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition">
                            </div>
                            <div onclick="openRosterModal('${x._id}')" class="cursor-pointer">
                                <h4 class="font-header text-xl text-white group-hover:text-[#ff4655] transition leading-none mb-1">${x.name}</h4>
                                <div class="flex items-center gap-2 text-xs font-mono text-gray-500">
                                    <span class="bg-[#222] px-1.5 rounded text-gray-300 border border-[#333]">${x.shortName}</span>
                                    <span></span>
                                    <span>${x.members.length} Players</span>
                                </div>
                                <div class="mt-3 w-32 h-1 bg-[#222] rounded-full overflow-hidden flex">
                                    <div class="h-full bg-[#ff4655]" style="width: ${winRate}%"></div>
                                </div>
                                <div class="text-[9px] text-gray-500 mt-1 font-mono">${x.wins}W - ${x.losses}L (${winRate}%)</div>
                            </div>
                        </div>
                        
                        <div class="flex gap-1 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity bg-[#15171a] pl-2">
                            ${isPending ? `<button onclick="approveTeam('${x._id}')" class="text-green-500 hover:bg-green-500/10 p-2 rounded"><i class="fa-solid fa-check"></i></button>` : ''}
                            
                            <button onclick="editTeam('${x._id}')" class="text-gray-400 hover:text-white p-2 rounded hover:bg-[#222]"><i class="fa-solid fa-pen"></i></button>
                            
                            <button onclick="resetTeamPassword('${x._id}', '${x.name}')" class="text-yellow-500 hover:text-yellow-300 p-2 rounded hover:bg-yellow-500/10"><i class="fa-solid fa-key"></i></button>

                            <button onclick="deleteTeam('${x._id}')" class="text-gray-600 hover:text-red-500 p-2 rounded hover:bg-red-500/10"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                    
                    ${(isPending || hasNameChange) ? `
                    <div class="px-5 py-2 bg-[#1a1d21] border-t border-[#222] flex gap-2">
                        ${isPending ? '<span class="text-[9px] font-bold text-yellow-500 uppercase tracking-wider"><i class="fa-solid fa-circle-exclamation mr-1"></i> Awaiting Approval</span>' : ''}
                        ${hasNameChange ? '<span class="text-[9px] font-bold text-orange-500 uppercase tracking-wider"><i class="fa-solid fa-pen-nib mr-1"></i> Name Change Req</span>' : ''}
                    </div>` : ''}
                </div>`;
            }).join('');
        }

        function renderLogs(logs) {
            const list = document.getElementById('logsList');
            if(!list) return;
            list.innerHTML = logs.map(l => `
                <tr class="border-b border-[#2d3139] hover:bg-[#1a1d21] transition">
                    <td class="p-4 font-mono text-xs text-gray-500 whitespace-nowrap">${new Date(l.createdAt).toLocaleString('th-TH')}</td>
                    <td class="p-4 font-bold text-white">${l.adminUsername}</td>
                    <td class="p-4"><span class="bg-[#222] border border-[#333] px-2 py-1 rounded text-[10px] font-bold uppercase text-[#ff4655]">${l.action}</span></td>
                    <td class="p-4 text-gray-400">${l.target}</td>
                    <td class="p-4 font-mono text-xs text-gray-500 truncate max-w-[200px]" title='${JSON.stringify(l.details)}'>${JSON.stringify(l.details)}</td>
                </tr>
            `).join('');
        }

        function filterLogs() {
            const el = document.getElementById('logSearch');
            const query = el ? el.value.toLowerCase() : '';
            const filtered = allLogs.filter(l => 
                (l.adminUsername && l.adminUsername.toLowerCase().includes(query)) || 
                (l.action && l.action.toLowerCase().includes(query)) ||
                (l.target && l.target.toLowerCase().includes(query))
            );
            renderLogs(filtered);
        }

        function renderRequests(matches) {
            const pending = matches.filter(m => m.status === 'pending_approval'); const el = document.getElementById('pendingScores'); const badge = document.getElementById('navBadgeReq');
            if(pending.length > 0) { badge.innerText = pending.length; badge.classList.remove('hidden'); } else { badge.classList.add('hidden'); }
            if(pending.length === 0) { el.innerHTML = `<div class="col-span-2 flex flex-col items-center justify-center py-20 border-2 border-dashed border-[#333] rounded-lg text-gray-500"><i class="fa-solid fa-check-circle text-4xl mb-4 opacity-20"></i><span class="font-bold text-xs uppercase tracking-widest">All caught up</span></div>`; return; }
            el.innerHTML = pending.map(m => {
                const [winsA, winsB] = calculateMatchScore(m.scoreSubmission.tempScores);
                const mapsHtml = m.scoreSubmission.tempScores.map((s) => `<div class="flex items-center justify-between py-2.5 border-b border-white/5 last:border-0 text-sm"><div class="w-1/3 truncate text-gray-300 font-bold">${s.mapName}</div><div class="flex items-center justify-center gap-4 font-mono font-bold text-white"><span class="${parseInt(s.teamAScore)>parseInt(s.teamBScore)?'text-green-400':'text-gray-500'}">${m.teamA.shortName} ${s.teamAScore}</span><span class="text-gray-700">:</span><span class="${parseInt(s.teamBScore)>parseInt(s.teamAScore)?'text-green-400':'text-gray-500'}">${s.teamBScore} ${m.teamB.shortName}</span></div><div class="w-1/3 text-right">${s.proofImage?`<button onclick="viewImage('${s.proofImage}')" class="text-[10px] bg-[#ff4655] hover:bg-white hover:text-[#ff4655] text-white px-2 py-1 rounded transition ml-2 font-bold"><i class="fa-regular fa-image mr-1"></i> VIEW PROOF</button>`:`<span class="text-[10px] text-gray-600 italic">No Proof</span>`}</div></div>`).join('');
                return `<div class="bg-[#15171a] rounded-lg border border-[#2d3139] overflow-hidden shadow-xl hover:border-gray-500 transition group"><div class="bg-[#1a1d21] px-6 py-4 flex justify-between items-center border-b border-[#2d3139]"><div class="flex items-center gap-3"><div class="w-2 h-2 rounded-full bg-yellow-500 animate-pulse"></div><h4 class="text-xs font-bold text-gray-300 uppercase tracking-widest">${m.name}</h4></div><span class="text-xs font-mono text-gray-500">${new Date(m.scheduledTime).toLocaleDateString()}</span></div><div class="p-6"><div class="flex justify-between items-end mb-6 px-4"><div class="text-center"><div class="text-xl font-header font-bold text-white">${m.teamA.name}</div><div class="text-[10px] text-gray-500 font-bold uppercase">Score: <span class="text-white text-lg ml-1">${winsA}</span></div></div><div class="text-gray-700 font-header text-lg pb-1">VS</div><div class="text-center"><div class="text-xl font-header font-bold text-white">${m.teamB.name}</div><div class="text-[10px] text-gray-500 font-bold uppercase">Score: <span class="text-white text-lg ml-1">${winsB}</span></div></div></div><div class="bg-[#0f1113] rounded p-3 mb-5 border border-white/5">${mapsHtml}</div><div class="grid grid-cols-2 gap-3"><button onclick="approveScore('${m._id}')" class="bg-green-500/10 hover:bg-green-600 hover:text-white text-green-500 border border-green-500/20 py-3 rounded text-xs font-bold uppercase transition">Approve</button><button onclick="rejectScore('${m._id}')" class="bg-red-500/10 hover:bg-red-600 hover:text-white text-red-500 border border-red-500/20 py-3 rounded text-xs font-bold uppercase transition">Reject</button></div></div></div>`;
            }).join('');
        }
        function renderMemberRow(tid, m) {
            const statusColor = m.status === 'rejected' ? 'text-red-400' : (m.status === 'pending' ? 'text-blue-400' : 'text-emerald-400');
            const statusDot = m.status === 'rejected' ? 'bg-red-500' : (m.status === 'pending' ? 'bg-blue-500' : 'bg-emerald-500');
            const safeRole = m.role || 'player';
            const safeTag = m.tag || '-';

            if (m.status === 'pending' && m.pendingUpdate) {
                return `
                <div class="bg-gradient-to-r from-orange-500/10 to-transparent border border-orange-500/40 rounded-xl p-4 mb-3 shadow-lg shadow-orange-900/10">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-[10px] font-bold bg-orange-500 text-black px-2 py-0.5 rounded uppercase tracking-widest">Name Change Request</span>
                        <div class="text-[10px] text-gray-500 font-mono">ID: ${m.pendingUpdate.riotId || 'N/A'}</div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-[1fr_auto_1fr] gap-3 items-center bg-black/20 border border-white/5 rounded-lg p-3 mb-3">
                        <div class="text-right">
                            <div class="text-[10px] text-gray-500 uppercase font-bold">Current</div>
                            <div class="font-bold text-white text-sm line-through decoration-red-500">${m.name}</div>
                            <div class="font-mono text-[10px] text-gray-500">#${safeTag}</div>
                        </div>
                        <div class="text-orange-400 text-sm text-center"><i class="fa-solid fa-arrow-right"></i></div>
                        <div class="text-left">
                            <div class="text-[10px] text-orange-400 uppercase font-bold">New Name</div>
                            <div class="font-bold text-white text-sm">${m.pendingUpdate.name}</div>
                            <div class="font-mono text-[10px] text-orange-200">#${m.pendingUpdate.tag || '-'}</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="updateMemberStatus('${tid}', '${m._id}', 'approved')" class="bg-green-600/15 hover:bg-green-600 hover:text-white text-green-400 border border-green-600/40 py-2.5 rounded-lg text-[10px] font-bold uppercase transition"><i class="fa-solid fa-check mr-1"></i> Approve Change</button>
                        <button onclick="updateMemberStatus('${tid}', '${m._id}', 'rejected')" class="bg-red-600/15 hover:bg-red-600 hover:text-white text-red-400 border border-red-600/40 py-2.5 rounded-lg text-[10px] font-bold uppercase transition"><i class="fa-solid fa-xmark mr-1"></i> Reject</button>
                    </div>
                </div>`;
            }

            if (m.status === 'pending') {
                return `
                <div class="bg-gradient-to-r from-blue-500/10 to-transparent border border-blue-500/30 rounded-xl p-3.5 mb-2 flex justify-between items-center">
                    <div class="flex items-center gap-3 min-w-0">
                        <div class="w-9 h-9 rounded-lg bg-blue-500/15 border border-blue-500/30 text-blue-300 flex items-center justify-center shrink-0">
                            <i class="fa-solid fa-user-plus text-xs"></i>
                        </div>
                        <div class="min-w-0">
                            <div class="flex items-center gap-2">
                                <span class="text-white font-bold text-sm truncate">${m.name}</span>
                                <span class="bg-blue-500/20 text-blue-300 text-[9px] font-bold px-1.5 py-0.5 rounded border border-blue-500/30">NEW</span>
                            </div>
                            <div class="text-[10px] font-mono text-gray-500 mt-0.5">#${safeTag}  ${safeRole}</div>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="updateMemberStatus('${tid}', '${m._id}', 'approved')" class="w-8 h-8 rounded-lg bg-[#0f1113] border border-[#333] text-green-500 hover:bg-green-600 hover:text-white hover:border-green-600 transition"><i class="fa-solid fa-check text-sm"></i></button>
                        <button onclick="updateMemberStatus('${tid}', '${m._id}', 'rejected')" class="w-8 h-8 rounded-lg bg-[#0f1113] border border-[#333] text-red-500 hover:bg-red-600 hover:text-white hover:border-red-600 transition"><i class="fa-solid fa-xmark text-sm"></i></button>
                    </div>
                </div>`;
            }

            return `
            <div class="group bg-[#14171b] border border-[#272b31] hover:border-[#3a404a] rounded-xl p-3.5 mb-2 transition">
                <div class="flex justify-between items-center gap-3">
                    <div class="flex items-center gap-3 min-w-0">
                        <div class="w-9 h-9 rounded-lg bg-black/30 border border-white/10 flex items-center justify-center shrink-0">
                            <i class="fa-solid fa-user text-[11px] ${statusColor}"></i>
                        </div>
                        <div class="min-w-0">
                            <div class="text-sm font-bold text-gray-200 group-hover:text-white truncate">${m.name}</div>
                            <div class="text-[10px] font-mono text-gray-500">#${safeTag} <span class="text-gray-700 mx-1">|</span> ${safeRole}</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-3 shrink-0">
                        <div class="text-[10px] uppercase font-bold tracking-wider text-gray-500 flex items-center gap-1.5">
                            <span class="w-1.5 h-1.5 rounded-full ${statusDot}"></span>${m.status}
                        </div>
                        <button onclick="deleteMember('${tid}', '${m._id}')" class="opacity-0 group-hover:opacity-100 text-gray-600 hover:text-red-500 transition px-2"><i class="fa-solid fa-trash-can text-sm"></i></button>
                    </div>
                </div>
            </div>`;
        }

        function openRosterModal(teamId) {
            const team = allTeams.find(t => t._id === teamId);
            if(!team) return;

            const total = team.members.length;
            const pending = team.members.filter(m => m.status === 'pending').length;
            const nameChanges = team.members.filter(m => m.pendingUpdate).length;
            const approved = Math.max(0, total - pending - team.members.filter(m => m.status === 'rejected').length);

            const membersHtml = team.members.length
                ? team.members.map(m => renderMemberRow(team._id, m)).join('')
                : `<div class="text-center text-gray-600 text-sm py-10 border border-dashed border-[#333] rounded-lg">No roster members</div>`;

            document.getElementById('rosterModalContent').innerHTML = `
                <div class="-m-8 mb-6 p-7 bg-gradient-to-r from-[#1f232a] via-[#1a1d21] to-[#16181c] border-b border-[#2f343d] rounded-t-lg">
                    <div class="flex items-start gap-5">
                        <img src="${team.logo || DEFAULT_LOGO}" class="w-20 h-20 rounded-xl bg-black object-cover border border-[#3a3f49] shadow-lg">
                        <div class="flex-1 min-w-0">
                            <h2 class="text-3xl font-header text-white leading-none mb-1 truncate">${team.name}</h2>
                            <div class="text-xs text-gray-400 font-bold uppercase tracking-widest mb-4"><span class="text-[#ff4655]">[${team.shortName}]</span> Roster Management</div>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                                <div class="bg-[#121417] border border-[#2d3139] rounded-lg px-3 py-2"><div class="text-[9px] text-gray-500 uppercase font-bold">Total</div><div class="text-lg font-header text-white">${total}</div></div>
                                <div class="bg-[#121417] border border-emerald-500/30 rounded-lg px-3 py-2"><div class="text-[9px] text-emerald-400 uppercase font-bold">Approved</div><div class="text-lg font-header text-emerald-300">${approved}</div></div>
                                <div class="bg-[#121417] border border-blue-500/30 rounded-lg px-3 py-2"><div class="text-[9px] text-blue-400 uppercase font-bold">Pending</div><div class="text-lg font-header text-blue-300">${pending}</div></div>
                                <div class="bg-[#121417] border border-orange-500/30 rounded-lg px-3 py-2"><div class="text-[9px] text-orange-400 uppercase font-bold">Name Changes</div><div class="text-lg font-header text-orange-300">${nameChanges}</div></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="max-h-[60vh] overflow-y-auto pr-2 custom-scroll">
                    ${membersHtml}
                </div>
            `;
            openModal('rosterModal');
        }
        async function updateMemberStatus(tid, mid, status) { await fetch(`${API_BASE}/api/teams/${tid}/members/${mid}/status`, { method: 'PUT', headers: { 'Authorization': token, 'Content-Type': 'application/json' }, body: JSON.stringify({ status }) }); await init(true); openRosterModal(tid); showToast(status === 'approved' ? 'Action Completed' : 'Rejected / Reverted'); }
        async function deleteMember(tid, mid) { if(!confirm("Kick Member?")) return; await fetch(`${API_BASE}/api/teams/${tid}/members/${mid}`, { method: 'DELETE', headers: { 'Authorization': token } }); await init(true); openRosterModal(tid); showToast('Member Removed'); }
        
        function toggleBulkMode() { bulkMode = !bulkMode; const btn = document.getElementById('btnBulkMode'); if(bulkMode) { btn.classList.add('bg-[#ff4655]', 'text-white', 'border-[#ff4655]'); btn.classList.remove('text-gray-400'); } else { btn.classList.remove('bg-[#ff4655]', 'text-white', 'border-[#ff4655]'); btn.classList.add('text-gray-400'); selectedMatches.clear(); updateBulkUI(); } init(true); }
        function toggleCompactMode() { compactMode = !compactMode; init(true); }
        function toggleMatchSelect(id) { if(selectedMatches.has(id)) selectedMatches.delete(id); else selectedMatches.add(id); updateBulkUI(); }
        function updateBulkUI() { const bar = document.getElementById('bulkActionBar'); document.getElementById('bulkCount').innerText = selectedMatches.size; if(selectedMatches.size > 0) bar.classList.remove('translate-y-full'); else bar.classList.add('translate-y-full'); }
        async function applyBulkTime() { const time = document.getElementById('bulkTime').value; if(!time || selectedMatches.size===0) return; const promises = Array.from(selectedMatches).map(id => fetch(`${API_BASE}/api/matches/${id}`, { method: 'PUT', headers: {'Authorization': token, 'Content-Type': 'application/json'}, body: JSON.stringify({ scheduledTime: time }) })); await Promise.all(promises); selectedMatches.clear(); updateBulkUI(); toggleBulkMode(); showToast("Schedule Updated"); }
        function clearSelection() { selectedMatches.clear(); updateBulkUI(); toggleBulkMode(); }
        function viewImage(url) { const fullUrl = url.startsWith('http') ? url : `${url}`; document.getElementById('imageViewerSrc').src = fullUrl; document.getElementById('imageViewerModal').classList.remove('hidden'); document.getElementById('imageViewerModal').classList.add('flex'); }
        function openStageModal() { 
            // [UPDATED] Auto-Save Restore
            const saved = localStorage.getItem('stage_autosave');
            if (saved) {
                try {
                    const savedIds = JSON.parse(saved);
                    stageSelected = savedIds.map(id => allTeams.find(t => t._id === id)).filter(t => t);
                    stagePool = allTeams.filter(t => t.status === 'approved' && !stageSelected.some(s => s._id === t._id));
                    if(stageSelected.length > 0) showToast('Restored Auto-Saved Bracket');
                } catch (e) {
                    stageSelected = []; 
                    stagePool = allTeams.filter(t => t.status === 'approved'); 
                }
            } else {
                stageSelected = []; 
                stagePool = allTeams.filter(t => t.status === 'approved'); 
                stageGroupNames = {};
                swapSourceIndex = null;
            }
            if(document.getElementById('poolSearch')) document.getElementById('poolSearch').value = '';
            
            // Populate Import Dropdown
            const sel = document.getElementById('impStage');
            sel.innerHTML = '<option value="" disabled selected>Select Source Stage</option>';
            if(activeTourneyData && activeTourneyData.stages) {
                activeTourneyData.stages.forEach((s, i) => {
                    sel.innerHTML += `<option value="${i}">${i+1}. ${s.name} (${s.type.toUpperCase()})</option>`;
                });
            }
            
            renderStageLists(); 
            selectFormat('single_elim'); // Default
            toggleImpInput();
            openModal('stageModal'); 
        }

        function selectFormat(type) {
            document.getElementById('stType').value = type;
            document.querySelectorAll('.format-btn').forEach(b => {
                b.classList.remove('bg-[#ff4655]/10', 'border-[#ff4655]');
                b.classList.add('border-[#333]');
            });
            const btn = document.getElementById('btn-fmt-' + type);
            if(btn) {
                btn.classList.remove('border-[#333]');
                btn.classList.add('bg-[#ff4655]/10', 'border-[#ff4655]');
            }
            
            const settingsDiv = document.getElementById('formatSettings');
            settingsDiv.classList.remove('hidden');
            settingsDiv.innerHTML = '';

            if (type === 'single_elim') {
                settingsDiv.innerHTML = `
                    <div class="space-y-3">
                        <div class="flex items-center gap-3">
                            <label class="text-xs text-gray-500 font-bold uppercase">Groups:</label>
                            <input type="number" id="stGroupCount" value="1" min="1" class="bg-[#1a1d21] border border-[#333] text-white w-16 text-center rounded p-1">
                        </div>
                        <div class="flex items-center gap-3">
                            <label class="text-xs text-gray-500 font-bold uppercase">Qualified Teams:</label>
                            <input type="number" id="stQualifiedCount" value="1" min="1" class="bg-[#1a1d21] border border-[#333] text-white w-16 text-center rounded p-1">
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="stThirdPlace" class="accent-[#ff4655] w-4 h-4">
                            <label for="stThirdPlace" class="text-xs text-gray-300 select-none">Include 3rd Place Match</label>
                        </div>
                    </div>
                    <p class="text-[10px] text-gray-500 mt-2">Winners advance, losers are eliminated.</p>
                `;
            } else if (type === 'double_elim') {
                settingsDiv.innerHTML = `
                    <div class="space-y-3">
                        <div class="flex items-center gap-3">
                            <label class="text-xs text-gray-500 font-bold uppercase">Groups:</label>
                            <input type="number" id="stGroupCount" value="1" min="1" class="bg-[#1a1d21] border border-[#333] text-white w-16 text-center rounded p-1">
                        </div>
                        <div class="flex items-center gap-3">
                            <label class="text-xs text-gray-500 font-bold uppercase">Qualified Teams:</label>
                            <input type="number" id="stQualifiedCount" value="1" min="1" class="bg-[#1a1d21] border border-[#333] text-white w-16 text-center rounded p-1">
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="stSplitParticipants" class="accent-[#ff4655] w-4 h-4">
                            <label for="stSplitParticipants" class="text-xs text-gray-300 select-none">Split Participants (Half start in Losers)</label>
                        </div>
                    </div>
                    <p class="text-[10px] text-gray-500 mt-2">Players have a second chance in the Losers Bracket.</p>
                `;
            } else if (type === 'triple_elim') {
                settingsDiv.innerHTML = `
                    <div class="space-y-3">
                        <div class="flex items-center gap-3">
                            <label class="text-xs text-gray-500 font-bold uppercase">Teams to seed:</label>
                            <input type="number" id="stTripleTeamCount" value="${Math.max(4, stageSelected.length || 8)}" min="4" class="bg-[#1a1d21] border border-[#333] text-white w-20 text-center rounded p-1">
                            <span class="text-[10px] text-gray-500">Use first N teams from Selected list</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <label class="text-xs text-gray-500 font-bold uppercase">Final Format:</label>
                            <select id="stFinalBO" class="bg-[#1a1d21] border border-[#333] text-white text-xs p-1.5 rounded outline-none">
                                <option value="BO3">BO3</option>
                                <option value="BO5" selected>BO5</option>
                            </select>
                        </div>
                    </div>
                    <p class="text-[10px] text-gray-500 mt-2">Triple Elim generates 3 brackets: Upper, Middle, and Lower.</p>
                `;
            } else if (type === 'round_robin') {
                settingsDiv.innerHTML = `
                    <div class="space-y-3">
                        <div class="flex items-center gap-3">
                            <label class="text-xs text-gray-500 font-bold uppercase">Qualified (per group):</label>
                            <input type="number" id="stQualifiedCount" value="2" min="1" class="bg-[#1a1d21] border border-[#333] text-white w-16 text-center rounded p-1">
                        </div>
                        <div class="flex items-center gap-3">
                            <label class="text-xs text-gray-500 font-bold uppercase">Iterations:</label>
                            <input type="number" id="stRoundCount" value="1" min="1" max="5" class="bg-[#1a1d21] border border-[#333] text-white w-16 text-center rounded p-1">
                            <span class="text-xs text-gray-500">(1x, 2x, 3x...)</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <label class="text-xs text-gray-500 font-bold uppercase">Groups:</label>
                            <input type="number" id="stGroupCount" value="1" min="1" max="8" class="bg-[#1a1d21] border border-[#333] text-white w-16 text-center rounded p-1">
                        </div>
                        <div class="border-t border-[#333] pt-2">
                            <label class="text-xs text-gray-500 font-bold uppercase block mb-1">Tiebreakers</label>
                            <div class="flex gap-2">
                                <select id="tb1" class="bg-[#1a1d21] border border-[#333] text-white text-[10px] p-1 rounded flex-1"><option value="h2h">Head to Head</option><option value="map_diff">Map Diff</option><option value="round_diff">Round Diff</option></select>
                                <select id="tb2" class="bg-[#1a1d21] border border-[#333] text-white text-[10px] p-1 rounded flex-1"><option value="map_diff" selected>Map Diff</option><option value="h2h">Head to Head</option><option value="round_diff">Round Diff</option></select>
                                <select id="tb3" class="bg-[#1a1d21] border border-[#333] text-white text-[10px] p-1 rounded flex-1"><option value="round_diff" selected>Round Diff</option><option value="h2h">Head to Head</option><option value="map_diff">Map Diff</option></select>
                            </div>
                        </div>
                    </div>
                `;
            } else if (type === 'swiss') {
                settingsDiv.innerHTML = `
                    <div class="space-y-3">
                        <div class="flex items-center gap-3">
                            <label class="text-xs text-gray-500 font-bold uppercase">Qualified Teams:</label>
                            <input type="number" id="stQualifiedCount" value="8" min="1" class="bg-[#1a1d21] border border-[#333] text-white w-16 text-center rounded p-1">
                        </div>
                        <div class="flex items-center gap-3">
                            <label class="text-xs text-gray-500 font-bold uppercase">Total Rounds:</label>
                            <input type="number" id="stSwissRounds" value="3" min="1" max="10" class="bg-[#1a1d21] border border-[#333] text-white w-16 text-center rounded p-1">
                        </div>
                    </div>
                    <p class="text-[10px] text-gray-500 mt-2">Players paired with similar records. Median-Buchholz tiebreakers.</p>
                `;
            } else if (type === 'gsl') {
                settingsDiv.innerHTML = `
                    <div class="flex items-center gap-3 mb-2">
                        <label class="text-xs text-gray-500 font-bold uppercase">Qualified (per group):</label>
                        <input type="number" id="stQualifiedCount" value="2" min="1" class="bg-[#1a1d21] border border-[#333] text-white w-16 text-center rounded p-1">
                    </div>
                    <div id="gslInfo" class="text-xs text-white font-bold uppercase mb-2"></div>
                    <p class="text-[10px] text-gray-500 mt-2">Double elimination groups (4 teams per group).</p>
                `;
            } else if (type === 'cross_group') {
                settingsDiv.innerHTML = `
                    <div class="space-y-2">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-xs font-bold text-[#ff4655] uppercase">Format:</span>
                            <span class="text-xs text-white">Inter-Group Round Robin</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <label class="text-xs text-gray-500 font-bold uppercase">Qualified (Total):</label>
                            <input type="number" id="stQualifiedCount" value="4" min="1" class="bg-[#1a1d21] border border-[#333] text-white w-16 text-center rounded p-1">
                        </div>
                    </div>
                    <p class="text-[10px] text-gray-500">Teams are split into two groups (Alpha & Omega). Each team in Alpha plays every team in Omega once.</p>
                    <div class="mt-3 p-2 bg-[#1a1d21] border border-[#333] rounded">
                        <div class="text-[10px] text-gray-400 font-bold uppercase mb-1">Structure</div>
                        <div class="flex justify-between items-center text-xs font-mono">
                            <span class="text-[#ff4655]">Group Alpha</span>
                            <i class="fa-solid fa-xmark text-gray-600"></i>
                            <span class="text-[#00d4ff]">Group Omega</span>
                        </div>
                    </div>
                `;
            }
            
            renderStageLists();
        }

        function updateGroupName(idx, val) {
            stageGroupNames[idx] = val;
            // No re-render needed, input keeps focus
        }

        function toggleImpInput() {
            const val = document.getElementById('impType').value;
            const el = document.getElementById('impCount');
            if(val === 'top_n') el.classList.remove('hidden');
            else el.classList.add('hidden');
        }

        function runImport() {
            const stageIdx = parseInt(document.getElementById('impStage').value);
            const type = document.getElementById('impType').value;
            if(isNaN(stageIdx) || stageIdx < 0) return showToast('Select a source stage', 'error');
            
            const stage = activeTourneyData.stages[stageIdx];
            const ms = stage.matches.map(mid => allMatches.find(m => m._id === mid)).filter(m => m);
            let importedIds = [];

            if (type === 'all') {
                importedIds = stage.stageParticipants;
            } else if (type === 'top_n') {
                const count = parseInt(document.getElementById('impCount').value) || 2;
                const standings = calculateStandings(ms, stage.stageParticipants, stage.settings);
                
                const grouped = {};
                standings.forEach(s => { const g = s.group || 'A'; if(!grouped[g]) grouped[g] = []; grouped[g].push(s); });
                
                Object.keys(grouped).sort().forEach(g => {
                    const top = grouped[g].slice(0, count);
                    importedIds.push(...top.map(s => s.id));
                });
            } else if (type === 'gsl') {
                const winners = []; const runners = [];
                ms.forEach(m => {
                    if (m.status === 'finished' && m.winner) {
                        if (m.name.includes('Winners')) winners.push({ team: m.winner._id || m.winner, group: m.name });
                        if (m.name.includes('Decider')) runners.push({ team: m.winner._id || m.winner, group: m.name });
                    }
                });
                winners.sort((a,b) => a.group.localeCompare(b.group));
                runners.sort((a,b) => a.group.localeCompare(b.group));
                importedIds = [...winners.map(x=>x.team), ...runners.map(x=>x.team)];
            }

            // Move to Selected
            let movedCount = 0;
            importedIds.forEach(id => {
                const inPoolIdx = stagePool.findIndex(t => String(t._id) === String(id));
                if (inPoolIdx > -1) {
                    stageSelected.push(stagePool[inPoolIdx]);
                    stagePool.splice(inPoolIdx, 1);
                    movedCount++;
                }
            });
            
            renderStageLists();
            showToast(`Imported ${movedCount} teams`);
            saveStageState();
        }

        function saveStageState() {
            const ids = stageSelected.map(t => t._id);
            localStorage.setItem('stage_autosave', JSON.stringify(ids));
        }

        function handleSwapClick(idx) {
            if (swapSourceIndex === null) {
                swapSourceIndex = idx;
                renderStageLists(); // Re-render to show highlight
            } else {
                if (swapSourceIndex !== idx) {
                    // Swap
                    [stageSelected[swapSourceIndex], stageSelected[idx]] = [stageSelected[idx], stageSelected[swapSourceIndex]];
                    saveStageState();
                }
                swapSourceIndex = null;
                renderStageLists();
            }
        }

        function renderStageLists() { 
            const query = document.getElementById('poolSearch')?.value.toLowerCase() || '';
            const filteredPool = stagePool.filter(t => t.name.toLowerCase().includes(query) || t.shortName.toLowerCase().includes(query));

            document.getElementById('poolList').innerHTML = filteredPool.map(t => 
                `<div draggable="true" ondragstart="handleDragStart(event, '${t._id}', 'pool')" ondragend="handleDragEnd(event)" onclick="selectTeamForStage('${t._id}')" class="draggable-item p-2 rounded bg-[#1a1d21] border border-[#333] hover:border-gray-500 flex items-center gap-3 group transition"><i class="fa-solid fa-plus text-gray-600 text-xs group-hover:text-green-500"></i><span class="text-xs text-gray-300 font-bold truncate">${t.name}</span></div>`
            ).join(''); 
            document.getElementById('availCount').innerText = query ? `${filteredPool.length}/${stagePool.length}` : stagePool.length; 
            
            const container = document.getElementById('selectedList');
            const type = document.getElementById('stType').value;
            const groupCountInput = document.getElementById('stGroupCount');
            const groupCount = groupCountInput ? parseInt(groupCountInput.value) || 1 : 1;
            
            let html = '';
            
            // Helper to render a team item
            const renderItem = (t, idx) => {
                const isSwapSource = swapSourceIndex === idx;
                const swapClass = isSwapSource ? 'border-[#ff4655] bg-[#ff4655]/20' : 'border-[#333] bg-[#0f1113] hover:border-gray-500';
                return `
                <div draggable="true" ondragstart="handleDragStart(event, '${t._id}', 'selected', ${idx})" ondragend="handleDragEnd(event)" ondragover="handleItemDragOver(event)" ondragleave="handleItemDragLeave(event)" ondrop="handleItemDrop(event, ${idx})" 
                    class="draggable-item p-2 rounded ${swapClass} border flex justify-between items-center group transition mb-1">
                    <div class="flex items-center gap-3 overflow-hidden">
                        <span class="text-[10px] bg-[#333] text-white px-1.5 rounded font-mono">${idx+1}</span>
                        <span class="text-xs text-white font-bold truncate">${t.name}</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <button onclick="handleSwapClick(${idx})" class="w-6 h-6 flex items-center justify-center rounded hover:bg-white/10 text-gray-500 hover:text-white transition" title="Swap Position">
                            <i class="fa-solid fa-arrow-right-arrow-left text-[10px]"></i>
                        </button>
                        <button onclick="removeTeamFromStage('${t._id}')" class="w-6 h-6 flex items-center justify-center rounded hover:bg-red-500/20 text-gray-500 hover:text-red-500 transition">
                            <i class="fa-solid fa-xmark text-xs"></i>
                        </button>
                    </div>
                </div>`;
            };

            // Helper to render a group container
            const renderGroup = (name, teams, startIndex, groupIndex) => {
                const customName = stageGroupNames[groupIndex] !== undefined ? stageGroupNames[groupIndex] : name;
                let itemsHtml = '';
                teams.forEach((t, i) => itemsHtml += renderItem(t, startIndex + i));
                
                return `
                <div class="mb-2 bg-[#15171a] border border-[#333] rounded overflow-hidden">
                    <div class="px-2 py-1 bg-[#222] flex justify-between items-center">
                        <input type="text" value="${customName}" oninput="updateGroupName(${groupIndex}, this.value)" class="bg-transparent border-b border-transparent hover:border-gray-600 focus:border-[#ff4655] text-[10px] font-bold text-gray-400 uppercase outline-none w-32 transition-colors" placeholder="Group Name">
                        <span class="text-[10px] font-bold text-gray-600">${teams.length}</span>
                    </div>
                    <div class="p-1">${itemsHtml}</div>
                </div>`;
            };

            if (type === 'gsl') {
                const count = Math.ceil(stageSelected.length / 4) || 1;
                for (let i = 0; i < count; i++) {
                    const groupTeams = stageSelected.slice(i * 4, (i * 4) + 4);
                    html += renderGroup(`Group ${String.fromCharCode(65 + i)}`, groupTeams, i * 4, i);
                }
            } else if (type === 'cross_group') {
                const mid = Math.ceil(stageSelected.length / 2);
                html += renderGroup('Group Alpha', stageSelected.slice(0, mid), 0, 0);
                html += renderGroup('Group Omega', stageSelected.slice(mid), mid, 1);
            } else if ((type === 'round_robin' || type === 'single_elim' || type === 'double_elim') && groupCount > 1) {
                // Distribute teams into groups for visualization
                const groups = Array.from({length: groupCount}, () => []);
                stageSelected.forEach((t, i) => groups[i % groupCount].push({t, idx: i}));
                
                // Note: In Round Robin/Elim with groups, BracketManager distributes by modulo (i % groupCount).
                // But for UI "Swap" to work intuitively with the flat list `stageSelected`, 
                // we should display them in the order they appear in the array if possible, 
                // OR we display them grouped but keep track of real index.
                // BracketManager logic: groups[i % groupCount].push(t)
                // So Team 0 -> Grp 0, Team 1 -> Grp 1, Team 2 -> Grp 0...
                
                // To make "Move to Group B" intuitive (drag/drop), it's better if the array is sliced (0..N -> A, N+1..M -> B).
                // BUT BracketManager uses modulo distribution for fairness by default.
                // Let's stick to visualizing the modulo distribution so the user knows where teams land.
                
                groups.forEach((g, i) => {
                    const groupName = `Group ${String.fromCharCode(65 + i)}`;
                    const customName = stageGroupNames[i] !== undefined ? stageGroupNames[i] : groupName;
                    
                    html += `
                    <div class="mb-2 bg-[#15171a] border border-[#333] rounded overflow-hidden">
                        <div class="px-2 py-1 bg-[#222] flex justify-between items-center">
                            <input type="text" value="${customName}" oninput="updateGroupName(${i}, this.value)" class="bg-transparent border-b border-transparent hover:border-gray-600 focus:border-[#ff4655] text-[10px] font-bold text-gray-400 uppercase outline-none w-32 transition-colors" placeholder="Group Name">
                            <span class="text-[10px] font-bold text-gray-600">${g.length}</span>
                        </div>
                        <div class="p-1">
                            ${g.map(item => renderItem(item.t, item.idx)).join('')}
                        </div>
                    </div>`;
                });
            } else {
                stageSelected.forEach((t, idx) => {
                    html += renderItem(t, idx);
                });
            }

            container.innerHTML = html;
            document.getElementById('selCount').innerText = stageSelected.length; 
            
            if (type === 'gsl') updateGSLInfo();
        }
        
        function updateGSLInfo() {
            const el = document.getElementById('gslInfo');
            if(el) {
                const count = Math.ceil(stageSelected.length / 4) || 0;
                el.innerText = `${count} Group${count !== 1 ? 's' : ''} will be created`;
            }
        }
        function selectTeamForStage(tid) { const idx = stagePool.findIndex(t => t._id === tid); if(idx > -1) { stageSelected.push(stagePool[idx]); stagePool.splice(idx, 1); renderStageLists(); saveStageState(); } }
        function removeTeamFromStage(tid) { const idx = stageSelected.findIndex(t => t._id === tid); if(idx > -1) { stagePool.push(stageSelected[idx]); stageSelected.splice(idx, 1); stagePool.sort((a,b) => a.name.localeCompare(b.name)); renderStageLists(); saveStageState(); } }
        function clearStageSelection() { stagePool = [...stagePool, ...stageSelected].sort((a,b)=>a.name.localeCompare(b.name)); stageSelected = []; renderStageLists(); saveStageState(); }
        function toggleRoundCount() { const type = document.getElementById('stType').value; const div = document.getElementById('stRoundCountContainer'); if(type==='round_robin') div.classList.remove('hidden'); else div.classList.add('hidden'); }
        function calculateMatchScore(scores) { if (!scores) return [0,0]; let a=0,b=0; scores.forEach(s=>{ if(parseInt(s.teamAScore)>parseInt(s.teamBScore)) a++; else if(parseInt(s.teamBScore)>parseInt(s.teamAScore)) b++; }); return [a,b]; }
        function updateStats(teams, matches) { document.getElementById('stat-live').innerText=matches.filter(m=>m.status==='live').length; document.getElementById('stat-pending').innerText=matches.filter(m=>m.status==='pending_approval').length; document.getElementById('stat-teams').innerText=teams.length; document.getElementById('stat-finished').innerText=matches.filter(m=>m.status==='finished').length; }
        function openModal(id) {
            const backdrop = document.getElementById('modalBackdrop');
            const modal = document.getElementById(id);
            if (!modal) return;
            activeModalId = id;
            backdrop.classList.remove('hidden');
            backdrop.classList.add('flex', 'modal-open');
            document.querySelectorAll('.modal-content').forEach(e => {
                e.classList.add('hidden');
                e.dataset.open = 'false';
            });
            modal.classList.remove('hidden');
            requestAnimationFrame(() => { modal.dataset.open = 'true'; });
        }
        function closeModal() { 
            if(vetoTimerInt) clearInterval(vetoTimerInt);
            const backdrop = document.getElementById('modalBackdrop');
            if (activeModalId) {
                const modal = document.getElementById(activeModalId);
                if (modal) modal.dataset.open = 'false';
            }
            setTimeout(() => {
                document.querySelectorAll('.modal-content').forEach(e => {
                    e.classList.add('hidden');
                    e.dataset.open = 'false';
                });
                backdrop.classList.add('hidden');
                backdrop.classList.remove('flex', 'modal-open');
                activeModalId = null;
            }, 180);
        }
        
        function showToast(msg, type='success') { 
            const t=document.getElementById('toast'); 
            document.getElementById('toastMsg').innerText=msg; 
            const icon = t.querySelector('i');
            if(type === 'error') {
                t.classList.replace('border-[#ff4655]', 'border-red-600');
                icon.className = 'fa-solid fa-triangle-exclamation text-red-600 text-2xl';
            } else {
                t.classList.replace('border-red-600', 'border-[#ff4655]');
                icon.className = 'fa-solid fa-circle-check text-[#ff4655] text-2xl';
            }
            t.style.transform="translateX(0)"; 
            setTimeout(()=>t.style.transform="translateX(150%)",4000); 
        }

        function logout() { localStorage.removeItem('token'); location.href='/login.html'; }
        function openEditMatch(id) { 
            const m = allMatches.find(x=>x._id===id); if(!m) return; activeMatchId = id; 
            document.getElementById('emName').value = m.name; 
            document.getElementById('emStatus').value = m.status; 
            document.getElementById('emFormat').value = m.format || 'BO1'; 
            document.getElementById('emTime').value = m.scheduledTime ? new Date(new Date(m.scheduledTime).getTime() - new Date().getTimezoneOffset()*60000).toISOString().slice(0,16) : '';
            document.getElementById('forceNameA').innerText = m.teamA?.shortName || 'Team A'; 
            document.getElementById('forceNameB').innerText = m.teamB?.shortName || 'Team B';
            socket.emit('join_match', id);
            switchMatchTab('overview'); 
            updateScoreInputs(m); 
            renderVetoSummary(m);
            renderMatchChat(m);
            openModal('editMatchModal'); 
        }
        function switchMatchTab(t) { document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); document.getElementById('tab-'+t).classList.add('active'); ['overview','scoreboard','admin','veto','chat'].forEach(x=>document.getElementById('view-tab-'+x).classList.add('hidden')); document.getElementById('view-tab-'+t).classList.remove('hidden'); }
        function updateScoreInputs(mIn) { 
            const m = mIn || allMatches.find(x => x._id === activeMatchId); if(!m) return;
            const format = document.getElementById('emFormat').value;
            const count = format === 'BO1' ? 1 : (format === 'BO3' ? 3 : 5);
            const nameA = m.teamA ? m.teamA.shortName : 'TEAM A'; const nameB = m.teamB ? m.teamB.shortName : 'TEAM B';
            let html = `<div class="grid grid-cols-12 gap-2 mb-2 text-[10px] text-gray-500 font-bold uppercase tracking-widest text-center"><div class="col-span-4 text-left pl-2">Map Name</div><div class="col-span-3 text-[#ff4655]">${nameA} Score</div><div class="col-span-2">VS</div><div class="col-span-3 text-[#ff4655]">${nameB} Score</div></div>`;
            for(let i=0; i<count; i++) { 
                let mapName = `Map ${i+1}`;
                let sA = 0, sB = 0;
                
                if(m.scores && m.scores[i]) {
                    mapName = m.scores[i].mapName;
                    sA = m.scores[i].teamAScore;
                    sB = m.scores[i].teamBScore;
                } else if (m.vetoData && m.vetoData.pickedMaps && m.vetoData.pickedMaps[i]) {
                    mapName = m.vetoData.pickedMaps[i].map;
                }

                html += `<div class="grid grid-cols-12 gap-2 mb-2 items-center bg-[#15171a] p-2 rounded border border-[#333]"><div class="col-span-4"><input id="ms_m_${i}" value="${mapName}" class="w-full bg-black/30 border border-[#444] px-2 py-1.5 rounded text-gray-300 text-xs focus:border-[#ff4655] outline-none placeholder-gray-600" placeholder="Map Name"></div><div class="col-span-3"><input type="number" id="ms_a_${i}" value="${sA}" class="w-full bg-black/30 border border-[#444] px-1 py-1.5 rounded text-center text-white font-bold text-sm focus:border-[#ff4655] outline-none"></div><div class="col-span-2 text-center text-gray-600 font-bold">:</div><div class="col-span-3"><input type="number" id="ms_b_${i}" value="${sB}" class="w-full bg-black/30 border border-[#444] px-1 py-1.5 rounded text-center text-white font-bold text-sm focus:border-[#ff4655] outline-none"></div></div>`; 
            }
            document.getElementById('manualScoreInputs').innerHTML = html; 
        }
        function renderVetoSummary(m) {
            const container = document.getElementById('vetoSummaryContent');
            if(vetoTimerInt) clearInterval(vetoTimerInt);

            if (!m.vetoData || m.vetoData.status === 'pending') {
                container.innerHTML = '<div class="text-center text-gray-500 italic py-8">Veto process has not started.</div>';
                return;
            }
            
            let statusHtml = '';
            const v = m.vetoData;

            if (v.status === 'in_progress' || v.status === 'decision' || v.status === 'coin_toss') {
                let isPaused = (m.pauseRequest && m.pauseRequest.status === 'pending') || (v.pausedRemainingTime > 0);
                
                if (isPaused) {
                    statusHtml = `
                    <div class="bg-yellow-500/10 border border-yellow-500/50 p-4 rounded mb-4 text-center animate-pulse">
                        <div class="text-yellow-500 font-bold text-lg tracking-widest"><i class="fa-solid fa-pause mr-2"></i> VETO PAUSED</div>
                        <div class="text-xs text-yellow-200/70 font-mono mt-1">Time Remaining: ${Math.ceil((v.pausedRemainingTime||0)/1000)}s</div>
                    </div>`;
                } else {
                    let activeTeamName = 'System';
                    let activeAction = v.status.toUpperCase().replace('_', ' ');
                    
                    if (v.status === 'decision') {
                        activeTeamName = v.coinTossWinner ? (v.coinTossWinner.shortName || v.coinTossWinner.name) : 'Winner';
                        activeAction = 'DECIDING SIDE/PICK';
                    } else if (v.sequence && v.sequence[v.sequenceIndex]) {
                        const step = v.sequence[v.sequenceIndex];
                        const teamId = step.team;
                        const team = (m.teamA._id === teamId || m.teamA === teamId) ? m.teamA : m.teamB;
                        activeTeamName = team ? (team.shortName || team.name) : 'Unknown';
                        activeAction = step.act.toUpperCase();
                    }

                    let timerHtml = '';
                    if (v.currentTurnDeadline) {
                        const deadline = new Date(v.currentTurnDeadline).getTime();
                        timerHtml = `<div class="text-right">
                            <div class="text-[10px] text-gray-500 font-bold uppercase mb-1">Time</div>
                            <div class="flex items-center gap-2 justify-end"><button data-action="reset-veto-timer" class="w-6 h-6 flex items-center justify-center bg-[#333] hover:bg-white hover:text-black text-gray-400 border border-gray-600 rounded transition" title="Reset Timer"><i class="fa-solid fa-rotate-right text-[10px]"></i></button><div id="adminVetoTimer" class="text-3xl font-mono font-bold text-white leading-none">--</div></div>
                        </div>`;
                        
                        vetoTimerInt = setInterval(() => {
                            const now = Date.now();
                            const diff = deadline - now;
                            const el = document.getElementById('adminVetoTimer');
                            if(el) {
                                if(diff <= 0) { el.innerText = "0.0s"; el.classList.add('text-red-500'); clearInterval(vetoTimerInt); } 
                                else { el.innerText = (diff/1000).toFixed(1) + "s"; if(diff < 10000) el.classList.add('text-[#ff4655]'); else el.classList.remove('text-[#ff4655]'); }
                            } else { clearInterval(vetoTimerInt); }
                        }, 100);
                    }

                    statusHtml = `
                    <div class="bg-[#15171a] border border-[#333] p-4 rounded mb-4 flex justify-between items-center shadow-lg">
                        <div><div class="text-[10px] text-gray-500 font-bold uppercase tracking-widest mb-1">Current Status</div><div class="text-white font-header text-2xl flex items-center gap-2"><span class="text-gray-300">${activeTeamName}</span><i class="fa-solid fa-chevron-right text-xs text-gray-600"></i><span class="text-[#ff4655]">${activeAction}</span></div></div>
                        ${timerHtml}
                    </div>`;
                }
            }
            
            let html = statusHtml;
            html += `<div class="grid grid-cols-2 gap-4 mb-4">
                <div class="bg-black/20 p-3 rounded border border-white/5">
                    <div class="text-[10px] text-red-500 font-bold uppercase mb-2">Bans</div>
                    <div class="flex flex-wrap gap-2">
                        ${(m.vetoData.bannedMaps||[]).map(map => `<span class="px-2 py-1 bg-red-500/10 border border-red-500/30 text-red-400 text-[10px] rounded">${map}</span>`).join('')}
                    </div>
                </div>
                <div class="bg-black/20 p-3 rounded border border-white/5">
                    <div class="text-[10px] text-green-500 font-bold uppercase mb-2">Picks</div>
                    <div class="flex flex-col gap-1">
                        ${(m.vetoData.pickedMaps||[]).map((p, i) => `<div class="flex justify-between text-[10px] text-gray-300"><span>${i+1}. ${p.map}</span><span class="text-gray-500">${p.teamAStartingSide||'-'}/${p.teamBStartingSide||'-'}</span></div>`).join('')}
                    </div>
                </div>
            </div>`;
            
            const getConnStatus = (tid) => {
                const p = m.presence && m.presence[tid] ? m.presence[tid] : null;
                if (!p) return '<span class="text-gray-600 font-bold text-[10px] uppercase flex items-center gap-1"><div class="w-1.5 h-1.5 rounded-full bg-gray-600"></div> OFFLINE</span>';
                if (p.isAway) return '<span class="text-yellow-500 font-bold text-[10px] uppercase flex items-center gap-1"><div class="w-1.5 h-1.5 rounded-full bg-yellow-500 animate-pulse"></div> AWAY</span>';
                return '<span class="text-[#1fa474] font-bold text-[10px] uppercase flex items-center gap-1"><div class="w-1.5 h-1.5 rounded-full bg-[#1fa474] shadow-[0_0_5px_#1fa474]"></div> ONLINE</span>';
            };

            html += `<div class="grid grid-cols-2 gap-4 mb-4">
                <div class="bg-black/20 p-3 rounded border border-white/5">
                    <div class="flex justify-between items-center mb-2 border-b border-white/5 pb-2"><div class="text-[10px] text-gray-500 font-bold uppercase">${m.teamA.name}</div>${getConnStatus(m.teamA._id)}</div>
                    <div class="space-y-1">
                        ${(m.teamA.members||[]).map(p => `<div class="text-[10px] text-gray-400 flex justify-between"><span>${p.name}</span><span class="text-gray-600">#${p.tag}</span></div>`).join('')}
                    </div>
                </div>
                <div class="bg-black/20 p-3 rounded border border-white/5">
                    <div class="flex justify-between items-center mb-2 border-b border-white/5 pb-2"><div class="text-[10px] text-gray-500 font-bold uppercase">${m.teamB.name}</div>${getConnStatus(m.teamB._id)}</div>
                    <div class="space-y-1">
                        ${(m.teamB.members||[]).map(p => `<div class="text-[10px] text-gray-400 flex justify-between"><span>${p.name}</span><span class="text-gray-600">#${p.tag}</span></div>`).join('')}
                    </div>
                </div>
            </div>`;
            
            html += `<div class="text-[10px] text-gray-500 font-bold uppercase mb-2">Log History</div>
            <div class="bg-black/40 p-2 rounded border border-white/5 h-48 overflow-y-auto custom-scroll font-mono text-[10px] text-gray-400 space-y-1">
                ${(m.vetoData.history||[]).slice().reverse().map(h => `<div><span class="text-gray-600">[${new Date(h.timestamp).toLocaleTimeString()}]</span> ${h.text}</div>`).join('')}
            </div>`;
            
            container.innerHTML = html;
        }
        function renderMatchChat(m) {
            const box = document.getElementById('adminChatBox');
            box.innerHTML = '';
            if (m.chat && m.chat.length > 0) {
                m.chat.forEach(c => renderChatMessage(c));
            } else {
                box.innerHTML = '<div class="text-center text-gray-600 text-xs italic mt-4">No messages yet.</div>';
            }
            box.scrollTop = box.scrollHeight;
        }
        function renderChatMessage(data) {
            const box = document.getElementById('adminChatBox');
            if (box.innerHTML.includes('No messages yet')) box.innerHTML = '';
            
            const isAdmin = data.senderId === 'admin';
            const bg = isAdmin ? 'bg-[#ff4655]/20 border-[#ff4655]/40' : 'bg-[#1a1d21] border-[#333]';
            const senderColor = isAdmin ? 'text-[#ff4655]' : 'text-gray-400';
            
            const html = `<div class="flex flex-col ${isAdmin ? 'items-end' : 'items-start'}"><span class="text-[9px] font-bold uppercase ${senderColor} mb-0.5">${data.sender}</span><div class="${bg} border px-3 py-2 rounded text-xs text-gray-200 max-w-[80%] break-words">${data.message}</div></div>`;
            
            box.insertAdjacentHTML('beforeend', html);
            box.scrollTop = box.scrollHeight;
        }
        function sendAdminChat() {
            const input = document.getElementById('adminChatInput');
            const msg = input.value.trim();
            if (!msg || !activeMatchId) return;
            socket.emit('send_chat', { matchId: activeMatchId, teamId: 'admin', message: msg });
            input.value = '';
        }
        async function saveMatchEdit() { 
            const body = { name:document.getElementById('emName').value, status:document.getElementById('emStatus').value, scheduledTime:document.getElementById('emTime').value, format:document.getElementById('emFormat').value };
            await fetch(`${API_BASE}/api/matches/${activeMatchId}`, {method:'PUT', headers: {'Authorization': token, 'Content-Type': 'application/json'}, body:JSON.stringify(body)});
            const c = document.getElementById('emFormat').value==='BO1'?1:(document.getElementById('emFormat').value==='BO3'?3:5);
            const scores = []; for(let i=0; i<c; i++) scores.push({ mapName:document.getElementById(`ms_m_${i}`).value, teamAScore: parseInt(document.getElementById(`ms_a_${i}`).value)||0, teamBScore: parseInt(document.getElementById(`ms_b_${i}`).value)||0 });
            await fetch(`${API_BASE}/api/matches/${activeMatchId}/manual-score`, {method:'PUT', headers: {'Authorization': token, 'Content-Type': 'application/json'}, body:JSON.stringify({scores})});
            closeModal(); init(); showToast('Match Saved');
        }

        function renderMapCheckboxes(ctx, preselected = []) {
            const id = ctx === 'create' ? 'createMapPoolList' : 'editMapPoolList';
            const targetId = ctx === 'overview' ? 'overviewMapPoolList' : id;
            const countId = ctx === 'create' ? 'count-create' : 'count-edit';
            const container = document.getElementById(targetId);
            if(!container) return; 
            
            container.innerHTML = ALL_MAPS.map(m => {
                let isChecked = false;
                if (ctx === 'create') isChecked = COMPETITIVE_POOL.includes(m);
                else isChecked = preselected.includes(m);
                
                const bgImg = MAP_IMAGES[m] || MAP_IMAGES['Abyss'];

                return `
                <div class="map-option ${isChecked ? 'selected' : ''}" onclick="toggleMap('${ctx}', '${m}', this)" style="background-image: url('${bgImg}');">
                    <input type="checkbox" value="${m}" class="chk-map-${ctx} hidden" ${isChecked ? 'checked' : ''}>
                    <span class="map-name">${m}</span>
                    <i class="fa-solid fa-circle-check check-icon"></i>
                </div>`;
            }).join('');

            updateMapSelectionUI(ctx);
        }

        function toggleMap(ctx, mapName, el) {
            const countId = ctx === 'create' ? 'count-create' : (ctx === 'overview' ? 'count-overview' : 'count-edit');
            const checkbox = el.querySelector('input');
            const container = el.parentElement;
            const currentCount = container.querySelectorAll('input:checked').length;
            
            if (!checkbox.checked) {
                if (currentCount >= 7) {
                    showToast("Map Pool Limited to 7 Maps", 'error');
                    return;
                }
                checkbox.checked = true;
                el.classList.add('selected');
            } else {
                checkbox.checked = false;
                el.classList.remove('selected');
            }
            
            updateMapSelectionUI(ctx);
        }

        function updateMapSelectionUI(ctx) {
            const id = ctx === 'create' ? 'createMapPoolList' : 'editMapPoolList';
            const targetId = ctx === 'overview' ? 'overviewMapPoolList' : id;
            const countId = ctx === 'create' ? 'count-create' : 'count-edit';
            const targetCountId = ctx === 'overview' ? 'count-overview' : countId;
            const container = document.getElementById(targetId);
            const countEl = document.getElementById(targetCountId);
            
            const checkboxes = container.querySelectorAll('input');
            const checkedCount = container.querySelectorAll('input:checked').length;
            
            countEl.innerText = `${checkedCount}/7`;
            countEl.className = checkedCount === 7 ? "text-xs font-mono font-bold text-[#22c55e]" : "text-xs font-mono font-bold text-[#ff4655]";
            
            const options = container.querySelectorAll('.map-option');
            options.forEach(opt => {
                const cb = opt.querySelector('input');
                if (!cb.checked) {
                    if (checkedCount >= 7) opt.classList.add('disabled');
                    else opt.classList.remove('disabled');
                } else {
                    opt.classList.remove('disabled');
                }
            });
        }

        async function createTournament() { 
            const name = document.getElementById('tnName').value; 
            if(!name) return showToast("Name is required", 'error');
            const approvedTeams = allTeams.filter(t=>t.status==='approved');
            if(approvedTeams.length < 2) return showToast("Need at least 2 approved teams!", 'error');
            const selectedMaps = Array.from(document.querySelectorAll('.chk-map-create:checked')).map(c => c.value);
            if(selectedMaps.length !== 7) return showToast(`Selected ${selectedMaps.length}/7 Maps! Exact 7 required.`, 'error');
            await fetch(`${API_BASE}/api/tournaments`, {
                method:'POST', 
                headers: {'Authorization': token, 'Content-Type': 'application/json'}, 
                body:JSON.stringify({name, teamIds: approvedTeams.map(t=>t._id), mapPool: selectedMaps})
            }); 
            closeModal(); init(); 
        }

        async function saveOverview() {
            const id = activeTourneyData._id;
            const name = document.getElementById('ovName').value;
            const prizePool = document.getElementById('ovPrize').value;
            const formatDescription = document.getElementById('ovFormat').value;
            const selectedMaps = Array.from(document.querySelectorAll('.chk-map-overview:checked')).map(c => c.value);
            
            if(selectedMaps.length !== 7) return showToast(`Selected ${selectedMaps.length}/7 Maps! Exact 7 required.`, 'error');
            
            await fetch(`${API_BASE}/api/tournaments/${id}`, {
                method:'PUT', 
                headers: {'Authorization': token, 'Content-Type': 'application/json'}, 
                body:JSON.stringify({name, mapPool: selectedMaps, prizePool, formatDescription})
            }); 
            init(); showToast('Tournament Updated'); 
        }
        
        async function deleteTourney() { const id=document.getElementById('tsId').value; if(confirm("DELETE SYSTEM?")) { await fetch(`${API_BASE}/api/tournaments/${id}`, {method:'DELETE', headers: {'Authorization': token}}); closeModal(); init(); showToast('Deleted'); } }
        async function approveScore(id) { if(confirm('Approve Result?')) await fetch(`${API_BASE}/api/matches/${id}/approve-score`, {method:'POST', headers: {'Authorization': token}}); init(); showToast('Score Approved'); }
        async function rejectScore(id) { const r=prompt('Reason for rejection:'); if(r) await fetch(`${API_BASE}/api/matches/${id}/reject-score`, {method:'POST', headers: {'Authorization': token, 'Content-Type': 'application/json'}, body:JSON.stringify({reason:r})}); init(); showToast('Score Rejected'); }
        async function forceWinner(side) { const m=allMatches.find(x=>x._id===activeMatchId); if(confirm('Force Win?')) await fetch(`${API_BASE}/api/matches/${activeMatchId}/force-winner`, {method:'POST', headers: {'Authorization': token, 'Content-Type': 'application/json'}, body:JSON.stringify({winnerId: side==='teamA'?m.teamA._id:m.teamB._id})}); closeModal(); init(); }
        async function deleteMatch() { if(confirm('Delete Match?')) await fetch(`${API_BASE}/api/matches/${activeMatchId}`, {method:'DELETE', headers: {'Authorization': token}}); closeModal(); init(); }
        async function deleteStage(tid, idx) { if(confirm('Delete Stage?')) await fetch(`${API_BASE}/api/tournaments/${tid}/stages/${idx}`, {method:'DELETE', headers: {'Authorization': token}}); init(); }
        async function rematchMatch() { if(!confirm(" Reset Match for Rematch?")) return; await fetch(`${API_BASE}/api/matches/${activeMatchId}/reset`, {method:'POST', headers:{'Authorization': token}}); closeModal(); init(); showToast('Reset Complete'); }
        async function resolvePause(mid) { if(!confirm("Resolve Pause Request?")) return; await fetch(`${API_BASE}/api/matches/${mid}/pause/resolve`, {method:'POST', headers:{'Authorization': token}}); init(); showToast('Pause Resolved'); }
        async function adminPauseMatch(mid) { await fetch(`${API_BASE}/api/matches/${mid}/admin-pause`, {method:'POST', headers:{'Authorization': token}}); init(); showToast('Veto Paused'); }
        async function resetVetoTimer() { if(!confirm("Reset current turn timer?")) return; await fetch(`${API_BASE}/api/matches/${activeMatchId}/reset-timer`, {method:'POST', headers: {'Authorization': token}}); }
        async function resetVeto() {
            if(!confirm("Reset Veto State? This will clear bans/picks.")) return;
            await fetch(`${API_BASE}/api/matches/${activeMatchId}/reset-veto`, {method:'POST', headers: {'Authorization': token}});
            closeModal(); init(); showToast('Veto Reset');
        }
        async function testAudio(sound) { if(!activeMatchId) return; await fetch(`${API_BASE}/api/matches/${activeMatchId}/audio`, {method:'POST', headers: {'Authorization': token, 'Content-Type': 'application/json'}, body:JSON.stringify({sound})}); showToast(`Audio Triggered: ${sound}`); }
        async function approveTeam(id) { if(confirm('Approve Team Entry?')) { await fetch(`${API_BASE}/api/teams/${id}/approve`, {method:'POST', headers: {'Authorization': token}}); init(); showToast('Team Approved'); } }
        function editTeam(id) { 
            const t = allTeams.find(x => x._id === id);
            if(!t) return;
            document.getElementById('teId').value = id; 
            document.getElementById('teName').value = t.name; 
            document.getElementById('teShort').value = t.shortName; 
            document.getElementById('teWins').value = t.wins || 0;
            document.getElementById('teLosses').value = t.losses || 0;
            openModal('teamEditModal'); 
        }
        async function saveTeamEdit() { 
            const id = document.getElementById('teId').value;
            const name = document.getElementById('teName').value;
            const shortName = document.getElementById('teShort').value;
            const wins = document.getElementById('teWins').value;
            const losses = document.getElementById('teLosses').value;
            if(!name || !shortName) return showToast('Please fill all fields', 'error');
            const res = await fetch(`${API_BASE}/api/teams/${id}`, { method: 'PUT', headers: { 'Authorization': token, 'Content-Type': 'application/json' }, body: JSON.stringify({ name, shortName, wins, losses }) });
            const data = await res.json();
            if (res.ok && data.success) { showToast('Team Updated Successfully'); closeModal(); init(); } else { showToast(data.msg || 'Update Failed', 'error'); }
        }
        async function generateSwissNext(tid, sIdx) { if(!confirm("Generate Next Swiss Round?\nEnsure all current matches are finished.")) return; const res = await fetch(`${API_BASE}/api/tournaments/${tid}/stages/${sIdx}/swiss-next`, { method: 'POST', headers: {'Authorization': token} }); const d = await res.json(); if(res.ok) { showToast(`Round Generated: ${d.matchesCreated} Matches`); init(); } else { alert(d.msg || 'Error'); } }
        async function deleteTeam(id){ if(confirm('Delete Team?')) await fetch(`${API_BASE}/api/teams/${id}`, {method:'DELETE', headers: {'Authorization': token}}); init(); }
        async function resetTeamPassword(id, name) {
            const newPass = prompt(`Enter NEW Password for team: ${name}`);
            if (!newPass) return;
            const res = await fetch(`${API_BASE}/api/teams/${id}/reset-password`, { method: 'PUT', headers: { 'Authorization': token, 'Content-Type': 'application/json' }, body: JSON.stringify({ newPassword: newPass }) });
            const data = await res.json();
            if (res.ok) { showToast(`Password for ${name} changed!`); } else { showToast(data.msg || 'Error', 'error'); }
        }
        async function resetTeamStats() {
            if(!confirm(" RESET ALL TEAM WINS/LOSSES?\nThis will set Wins and Losses to 0 for ALL teams.\nThis cannot be undone.")) return;
            const res = await fetch(`${API_BASE}/api/teams/reset-stats`, { method: 'POST', headers: { 'Authorization': token } });
            if(res.ok) { showToast('Stats Reset Successfully'); init(); }
            else showToast('Error Resetting Stats', 'error');
        }
        async function importTeamsCSV(input) {
            if (!input.files[0]) return;
            if (!confirm("Import Teams from CSV?\nFormat: Team Name, Short Name, Username, Password, M1 Name, M1 Tag, M2 Name, M2 Tag...")) { input.value = ''; return; }
            const fd = new FormData(); fd.append('file', input.files[0]);
            try {
                const res = await fetch(`${API_BASE}/api/teams/import`, { method: 'POST', headers: { 'Authorization': token }, body: fd });
                const data = await res.json();
                if (res.ok) { showToast(data.msg); init(); } else { showToast(data.msg || 'Import Failed', 'error'); }
            } catch (e) { showToast('Error uploading file', 'error'); }
            input.value = '';
        }
        function downloadCsvTemplate() {
            const headers = [
                "Team Name", "Short Name", "Username", "Password",
                "Member 1 Name", "Member 1 Tag",
                "Member 2 Name", "Member 2 Tag",
                "Member 3 Name", "Member 3 Tag",
                "Member 4 Name", "Member 4 Tag",
                "Member 5 Name", "Member 5 Tag",
                "Sub 1 Name", "Sub 1 Tag",
                "Sub 2 Name", "Sub 2 Tag",
                "Coach Name", "Coach Tag"
            ];
            const exampleRow = [
                "Example Team", "EXT", "example_user", "pass123",
                "PlayerOne", "1111", "PlayerTwo", "2222", "PlayerThree", "3333", "PlayerFour", "4444", "PlayerFive", "5555",
                "SubOne", "6666", "SubTwo", "7777", "CoachName", "8888"
            ];
            const csvContent = "\uFEFF" + headers.join(",") + "\n" + exampleRow.join(",");
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a"); link.href = url; link.download = "team_import_template.csv";
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }
        function openVetoPage() { window.open(`/veto.html?match=${activeMatchId}`, '_blank'); }
        function openOverlayPage() { window.open(`/overlay.html?match=${activeMatchId}`, '_blank'); }
        
        async function sendDiscordClaim() {
            if(!confirm("Send 'Claim Role' message to Discord channel?")) return;
            const res = await fetch(`${API_BASE}/api/admin/discord/send-claim`, { method: 'POST', headers: { 'Authorization': token } });
            if(res.ok) showToast('Discord Message Sent');
            else { const d = await res.json(); showToast(d.msg || 'Error', 'error'); }
        }
        
        async function syncAllRoles() {
            if(!confirm("Create Discord Roles for ALL teams and assign to members?\nThis may take a while.")) return;
            const res = await fetch(`${API_BASE}/api/admin/discord/sync-all-roles`, { method: 'POST', headers: { 'Authorization': token } });
            const d = await res.json();
            if(res.ok) showToast(d.msg);
            else showToast(d.msg || 'Error', 'error');
        }

        function exportStageCSV(tourneyId, stageIndex) {
            const t = activeTourneyData;
            if (!t || t._id !== tourneyId) return showToast('Tournament data mismatch', 'error');
            
            const stage = t.stages[stageIndex];
            if (!stage) return showToast('Stage not found', 'error');

            const ms = stage.matches.map(mid => allMatches.find(m => m._id === mid)).filter(m => m);
            if (ms.length === 0) return showToast('No matches to export', 'error');

            const headers = ['Round', 'Match Name', 'Status', 'Scheduled Time', 'Team A', 'Score A', 'Score B', 'Team B', 'Winner'];
            const rows = ms.map(m => {
                const teamA = m.teamA ? m.teamA.name : 'TBD';
                const teamB = m.teamB ? m.teamB.name : 'TBD';
                const [sA, sB] = calculateMatchScore(m.scores);
                const winner = m.winner ? (m.winner.name || (m.winner === m.teamA?._id ? teamA : teamB)) : '-';
                const time = m.scheduledTime ? new Date(m.scheduledTime).toLocaleString() : 'TBD';

                return [m.round, `"${m.name||''}"`, m.status, `"${time}"`, `"${teamA}"`, sA, sB, `"${teamB}"`, `"${winner}"`].join(',');
            });

            const csvContent = "\uFEFF" + headers.join(",") + "\n" + rows.join("\n");
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = `${t.name.replace(/[^a-z0-9]/gi, '_')}_Stage_${stageIndex+1}.csv`;
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }
        function adjustTime(m) { const i=document.getElementById('emTime'); const d=i.value?new Date(i.value):new Date(); d.setMinutes(d.getMinutes()+m); i.value=new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,16); }
        async function generateStage() { 
            // Prepare group names array
            const groupNames = [];
            Object.keys(stageGroupNames).forEach(k => groupNames[parseInt(k)] = stageGroupNames[k]);
            const stageType = document.getElementById('stType').value;
            const tripleTeamCount = parseInt(document.getElementById('stTripleTeamCount')?.value) || 0;
            let selectedParticipantIds = stageSelected.map(t=>t._id);

            if (stageType === 'triple_elim' && tripleTeamCount > 0) {
                if (selectedParticipantIds.length < tripleTeamCount) {
                    showToast(`Need at least ${tripleTeamCount} selected teams for Triple Elim`, 'error');
                    return;
                }
                selectedParticipantIds = selectedParticipantIds.slice(0, tripleTeamCount);
            }

            const body = { 
                name: document.getElementById('stName').value, 
                type: stageType, 
                participants: selectedParticipantIds, 
                settings: { 
                    defaultFormat: document.getElementById('stDefBO').value, 
                    roundCount: parseInt(document.getElementById('stRoundCount')?.value) || 1, 
                    randomize: document.getElementById('stRandom')?.checked,
                    hasThirdPlace: document.getElementById('stThirdPlace')?.checked,
                    splitParticipants: document.getElementById('stSplitParticipants')?.checked,
                    groupCount: parseInt(document.getElementById('stGroupCount')?.value) || 1,
                    tiebreakers: [document.getElementById('tb1')?.value, document.getElementById('tb2')?.value, document.getElementById('tb3')?.value].filter(Boolean),
                    swissRounds: parseInt(document.getElementById('stSwissRounds')?.value) || 3,
                    qualifiedCount: parseInt(document.getElementById('stQualifiedCount')?.value) || 1,
                    teamCount: tripleTeamCount || undefined,
                    finalFormat: document.getElementById('stFinalBO')?.value || 'BO5',
                    groupNames: groupNames,
                    sourceStageIndex: -1 // Always manual mode now
                } 
            }; 
            const res = await fetch(`${API_BASE}/api/tournaments/${activeTourneyData._id}/stages/generate`, {
                method:'POST', 
                headers: {'Authorization': token, 'Content-Type': 'application/json'}, 
                body:JSON.stringify(body)
            }); 
            
            if (res.ok) {
                closeModal(); init();
                localStorage.removeItem('stage_autosave');
                showToast('Stage Generated');
            } else {
                const d = await res.json().catch(() => ({}));
                showToast(d.message || d.msg || 'Error Generating Stage', 'error');
            }
        }

        function openStageSettings(tid, idx) {
            const t = allTourneys.find(x => x._id === tid);
            if(!t || !t.stages[idx]) return;
            const s = t.stages[idx];
            const tb = (s.settings && s.settings.tiebreakers) ? s.settings.tiebreakers : ['h2h', 'map_diff', 'round_diff'];
            document.getElementById('ssTourneyId').value = tid; document.getElementById('ssStageIndex').value = idx;
            document.getElementById('ssTb1').value = tb[0]; document.getElementById('ssTb2').value = tb[1]; document.getElementById('ssTb3').value = tb[2];
            openModal('stageSettingsModal');
        }

        async function saveStageSettings() {
            const tid = document.getElementById('ssTourneyId').value; const idx = document.getElementById('ssStageIndex').value;
            const tiebreakers = [document.getElementById('ssTb1').value, document.getElementById('ssTb2').value, document.getElementById('ssTb3').value];
            await fetch(`${API_BASE}/api/tournaments/${tid}/stages/${idx}/settings`, { method: 'PUT', headers: {'Authorization': token, 'Content-Type': 'application/json'}, body: JSON.stringify({ settings: { tiebreakers } }) });
            closeModal(); init(true); showToast('Settings Updated');
        }
        
        // --- MANAGE TEAMS (ADD/SWAP) ---
        let manageTeamsState = { tid: null, sIdx: null, swapSrc: null };
        
        function openManageTeams(tid, idx) {
            manageTeamsState = { tid, sIdx: idx, swapSrc: null };
            const t = allTourneys.find(x => x._id === tid);
            const s = t.stages[idx];
            const ms = s.matches.map(mid => allMatches.find(m => m._id === mid)).filter(m => m);
            
            // Group Teams
            const groups = {};
            if (s.type === 'cross_group') {
                const mid = Math.ceil(s.stageParticipants.length / 2);
                groups['Group Alpha'] = s.stageParticipants.slice(0, mid);
                groups['Group Omega'] = s.stageParticipants.slice(mid);
            } else {
                // Round Robin: Infer from matches or just list all if 1 group
                // For simplicity in UI, we try to group by match names or just show "Group A" etc.
                // If we can't infer, we just show one big list, but user asked for groups.
                // Let's use the same logic as renderStructure to find groups
                ms.forEach(m => {
                    const gMatch = m.name.match(/(?:Group|Grp)\s+([A-Z0-9]{1,2})\b/i);
                    const gName = gMatch ? `Group ${gMatch[1].toUpperCase()}` : 'General';
                    if (!groups[gName]) groups[gName] = new Set();
                    if (m.teamA) groups[gName].add(m.teamA._id);
                    if (m.teamB) groups[gName].add(m.teamB._id);
                });
                // Convert Sets to Arrays
                Object.keys(groups).forEach(k => groups[k] = Array.from(groups[k]));
                if (Object.keys(groups).length === 0) groups['General'] = s.stageParticipants;
            }

            let html = '<div class="grid grid-cols-1 md:grid-cols-2 gap-6">';
            Object.keys(groups).sort().forEach((gName, gIdx) => {
                const teamIds = groups[gName];
                html += `
                <div class="bg-[#0f1113] border border-[#333] rounded flex flex-col">
                    <div class="p-3 bg-[#1a1d21] border-b border-[#333] font-bold text-xs text-white uppercase tracking-widest">${gName}</div>
                    <div class="p-2 flex-1 space-y-1">
                        ${teamIds.map(tid => {
                            const team = allTeams.find(t => t._id === tid);
                            if(!team) return '';
                            return `<div onclick="handleManageSwap('${tid}')" class="p-2 bg-[#1a1d21] border border-[#333] rounded flex justify-between items-center cursor-pointer hover:border-[#ff4655] transition group manage-team-item" data-id="${tid}">
                                <span class="text-xs font-bold text-gray-300 group-hover:text-white">${team.name}</span>
                                <i class="fa-solid fa-arrow-right-arrow-left text-[10px] text-gray-600 group-hover:text-[#ff4655]"></i>
                            </div>`;
                        }).join('')}
                    </div>
                    <div class="p-2 border-t border-[#333]">
                        <div class="flex gap-2">
                            <select id="addTeamSel_${gIdx}" class="bg-[#1a1d21] text-white text-[10px] border border-[#333] rounded flex-1 outline-none"><option value="">Select Team to Add...</option>${allTeams.filter(t => t.status==='approved' && !s.stageParticipants.includes(t._id)).map(t => `<option value="${t._id}">${t.name}</option>`).join('')}</select>
                            <button onclick="addTeamToStageSubmit(${gIdx})" class="bg-green-600/20 text-green-500 hover:bg-green-600 hover:text-white border border-green-600/50 px-3 rounded text-[10px] font-bold uppercase transition">ADD</button>
                        </div>
                    </div>
                </div>`;
            });
            html += '</div><p class="mt-4 text-[10px] text-gray-500 italic">* Click two teams to swap them. Adding a team generates extra matches automatically.</p>';
            
            document.getElementById('manageTeamsContent').innerHTML = html;
            openModal('manageTeamsModal');
        }

        async function handleManageSwap(tid) {
            if (!manageTeamsState.swapSrc) {
                manageTeamsState.swapSrc = tid;
                document.querySelectorAll('.manage-team-item').forEach(el => el.classList.remove('border-[#ff4655]', 'bg-[#ff4655]/10'));
                const el = document.querySelector(`.manage-team-item[data-id="${tid}"]`);
                if(el) el.classList.add('border-[#ff4655]', 'bg-[#ff4655]/10');
            } else {
                if (manageTeamsState.swapSrc !== tid) {
                    if(confirm("Swap these two teams in all matches?")) {
                        await fetch(`${API_BASE}/api/tournaments/${manageTeamsState.tid}/stages/${manageTeamsState.sIdx}/teams/swap`, {
                            method: 'POST', headers: {'Authorization': token, 'Content-Type': 'application/json'},
                            body: JSON.stringify({ team1Id: manageTeamsState.swapSrc, team2Id: tid })
                        });
                        init(true);
                        openManageTeams(manageTeamsState.tid, manageTeamsState.sIdx); // Refresh modal
                        showToast('Teams Swapped');
                    }
                }
                manageTeamsState.swapSrc = null;
                document.querySelectorAll('.manage-team-item').forEach(el => el.classList.remove('border-[#ff4655]', 'bg-[#ff4655]/10'));
            }
        }

        async function addTeamToStageSubmit(gIdx) {
            const teamId = document.getElementById(`addTeamSel_${gIdx}`).value;
            if(!teamId) return;
            if(!confirm("Add team and generate matches?")) return;
            
            await fetch(`${API_BASE}/api/tournaments/${manageTeamsState.tid}/stages/${manageTeamsState.sIdx}/teams/add`, {
                method: 'POST', headers: {'Authorization': token, 'Content-Type': 'application/json'},
                body: JSON.stringify({ teamId, groupIndex: gIdx })
            });
            init(true);
            openManageTeams(manageTeamsState.tid, manageTeamsState.sIdx);
            showToast('Team Added');
        }

        // Drag & Drop Logic
        let draggedItem = null;
        function handleDragStart(e, id, source, index) { draggedItem = { id, source, index }; e.dataTransfer.effectAllowed = "move"; e.target.classList.add('dragging'); }
        function handleDragEnd(e) { 
            e.target.classList.remove('dragging'); 
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over')); 
            document.querySelectorAll('.drag-over-item').forEach(el => el.classList.remove('drag-over-item'));
        }
        function handleDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = "move"; e.currentTarget.classList.add('drag-over'); }
        function handleDragLeave(e) { e.currentTarget.classList.remove('drag-over'); }
        function handleDrop(e, target) { 
            e.preventDefault(); e.currentTarget.classList.remove('drag-over'); 
            if (!draggedItem) return; 
            if (target === 'selected') {
                if (draggedItem.source === 'pool') selectTeamForStage(draggedItem.id);
                else {
                    const item = stageSelected.splice(draggedItem.index, 1)[0];
                    stageSelected.push(item);
                    renderStageLists();
                    saveStageState();
                }
            } else {
                if (draggedItem.source === 'selected') removeTeamFromStage(draggedItem.id);
            }
            draggedItem = null; 
        }

        function handleItemDragOver(e) { 
            e.preventDefault(); e.stopPropagation(); e.dataTransfer.dropEffect = "move"; 
            if (draggedItem && draggedItem.source === 'selected') e.currentTarget.classList.add('drag-over-swap');
            else e.currentTarget.classList.add('drag-over-insert');
        }
        function handleItemDragLeave(e) { e.currentTarget.classList.remove('drag-over-insert', 'drag-over-swap'); }
        function handleItemDrop(e, targetIndex) {
            e.preventDefault(); e.stopPropagation(); e.currentTarget.classList.remove('drag-over-insert', 'drag-over-swap');
            if (!draggedItem) return;
            if (draggedItem.source === 'selected') {
                // Swap Logic (Better for Groups/Seeding)
                const srcIdx = draggedItem.index;
                if (srcIdx !== targetIndex) {
                    [stageSelected[srcIdx], stageSelected[targetIndex]] = [stageSelected[targetIndex], stageSelected[srcIdx]];
                }
            } else {
                const poolIndex = stagePool.findIndex(t => t._id === draggedItem.id);
                if (poolIndex > -1) { const item = stagePool.splice(poolIndex, 1)[0]; stageSelected.splice(targetIndex, 0, item); }
            }
            renderStageLists(); draggedItem = null; saveStageState();
        }

        // --- QUICK ACTIONS & BROADCAST ---
        let ctxMatchId = null;
        function openMatchContextMenu(e, id) {
            e.preventDefault();
            ctxMatchId = id;
            const m = allMatches.find(x => x._id === id);
            if(!m) return;

            const menu = document.getElementById('matchCtxMenu');
            const rect = (e.currentTarget || e.target).getBoundingClientRect();
            
            document.getElementById('ctxNameA').innerText = m.teamA ? m.teamA.shortName : 'Team A';
            document.getElementById('ctxNameB').innerText = m.teamB ? m.teamB.shortName : 'Team B';
            
            menu.style.top = `${rect.bottom + 5}px`;
            menu.style.left = `${rect.right - 190}px`; // Align right
            menu.classList.remove('hidden');
            
            // Small delay for animation
            requestAnimationFrame(() => {
                menu.classList.remove('opacity-0', 'scale-95');
                menu.classList.add('opacity-100', 'scale-100');
            });
        }

        async function quickAction(action) {
            const menu = document.getElementById('matchCtxMenu');
            menu.classList.add('hidden');
            if(!ctxMatchId) return;
            
            const m = allMatches.find(x => x._id === ctxMatchId);
            if(action === 'winA') { activeMatchId = ctxMatchId; forceWinner('teamA'); }
            else if(action === 'winB') { activeMatchId = ctxMatchId; forceWinner('teamB'); }
            else if(action === 'reset') { activeMatchId = ctxMatchId; rematchMatch(); }
            else if(action === 'copyPass') {
                if(m.roomPassword) { navigator.clipboard.writeText(m.roomPassword); showToast('Password Copied'); }
                else showToast('No Password Set', 'error');
            }
        }

        // Close context menu on click outside
        window.addEventListener('click', () => {
            const menu = document.getElementById('matchCtxMenu');
            if (menu && !menu.classList.contains('hidden')) {
                menu.classList.add('hidden', 'opacity-0', 'scale-95');
                menu.classList.remove('opacity-100', 'scale-100');
            }
        });

        // Veto Countdown Timer
        setInterval(() => {
            document.querySelectorAll('.veto-countdown').forEach(el => {
                const deadline = parseInt(el.dataset.deadline);
                if(!deadline) return;
                const diff = Math.ceil((deadline - Date.now()) / 1000);
                el.innerText = diff > 0 ? `(${diff}s)` : '(0s)';
                if(diff <= 10 && diff > 0) el.classList.add('animate-pulse'); else el.classList.remove('animate-pulse');
            });
        }, 1000);

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            bindUIEvents();
            renderMapCheckboxes('create');
        });
        init();

        // --- BRACKET LINES UTILS ---
        function drawBracketLines(matches, svgId) {
            const svg = document.getElementById(svgId);
            if(!svg) return;
            svg.innerHTML = '';
            const container = svg.parentElement;
            svg.setAttribute('width', container.scrollWidth);
            svg.setAttribute('height', container.scrollHeight);

            matches.forEach(m => {
                const sourceEl = document.getElementById(`bracket-match-${m._id}`);
                if(!sourceEl) return;
                if(m.nextMatchId) {
                    const targetMatch = allMatches.find(x => x._id === m.nextMatchId);
                    const targetEl = document.getElementById(`bracket-match-${m.nextMatchId}`);
                    if(targetEl) drawPath(svg, sourceEl, targetEl, false);
                }
            });
        }
        function drawPath(svg, startEl, endEl, isLoser) {
            const startRect = startEl.getBoundingClientRect();
            const endRect = endEl.getBoundingClientRect();
            const containerRect = svg.getBoundingClientRect();
            const startX = startRect.right - containerRect.left;
            const startY = startRect.top + (startRect.height / 2) - containerRect.top;
            const endX = endRect.left - containerRect.left;
            const endY = endRect.top + (endRect.height / 2) - containerRect.top;
            const midX = (startX + endX) / 2;
            const d = `M ${startX} ${startY} C ${midX} ${startY}, ${midX} ${endY}, ${endX} ${endY}`;
            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            path.setAttribute("d", d); path.setAttribute("fill", "none"); path.setAttribute("stroke", "#444"); path.setAttribute("stroke-width", "2"); path.classList.add("connector");
            svg.appendChild(path);
        }
    </script>
</body>
</html>
