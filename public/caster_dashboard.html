<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caster Control Center | VCT Style</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Oswald:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #0f1923; color: #ece8e1; font-family: 'Inter', sans-serif; }
        .font-header { font-family: 'Oswald', sans-serif; text-transform: uppercase; letter-spacing: 0.05em; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f1923; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #ff4655; }

        .glass-panel {
            background: #1a1d21;
            border: 1px solid #2d3139;
            border-radius: 8px;
            transition: all 0.2s;
        }
        .glass-panel:hover { border-color: #ff4655; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }

        .btn-action {
            background: #222;
            border: 1px solid #333;
            color: #ccc;
            font-family: 'Oswald', sans-serif;
            text-transform: uppercase;
            font-weight: bold;
            transition: all 0.2s;
        }
        .btn-action:hover { background: #ff4655; color: white; border-color: #ff4655; }

        .live-indicator {
            width: 8px; height: 8px; background: #ff4655; border-radius: 50%;
            box-shadow: 0 0 10px #ff4655; animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="h-16 bg-[#111] border-b border-[#222] flex items-center justify-between px-8 shrink-0 z-20">
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 bg-[#ff4655] flex items-center justify-center rounded">
                <i class="fa-solid fa-microphone-lines text-white text-xl"></i>
            </div>
            <div>
                <h1 class="text-xl font-header font-bold text-white leading-none">CASTER<br><span class="text-[#ff4655]">DASHBOARD</span></h1>
            </div>
        </div>
        <div class="flex items-center gap-6">
            <div class="text-right">
                <div class="text-[10px] text-gray-500 font-bold uppercase">System Status</div>
                <div class="text-xs text-green-500 font-mono font-bold flex items-center justify-end gap-2">
                    ONLINE <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                </div>
            </div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <!-- Sidebar -->
        <aside class="w-80 bg-[#15171a] border-r border-[#222] flex flex-col p-6 overflow-y-auto custom-scroll">
            <div class="mb-8">
                <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4 border-b border-[#333] pb-2">Quick Links</h3>
                <div class="space-y-2">
                    <a href="/tournament_view.html" target="_blank" class="block p-3 bg-[#222] border border-[#333] rounded hover:border-[#ff4655] hover:text-white text-gray-400 text-sm font-bold transition flex items-center justify-between group">
                        <span><i class="fa-solid fa-sitemap mr-2"></i> Public Bracket</span>
                        <i class="fa-solid fa-arrow-up-right-from-square text-xs opacity-0 group-hover:opacity-100 transition"></i>
                    </a>
                    <a href="/overlay.html" target="_blank" class="block p-3 bg-[#222] border border-[#333] rounded hover:border-[#ff4655] hover:text-white text-gray-400 text-sm font-bold transition flex items-center justify-between group">
                        <span><i class="fa-solid fa-layer-group mr-2"></i> Main Overlay</span>
                        <i class="fa-solid fa-arrow-up-right-from-square text-xs opacity-0 group-hover:opacity-100 transition"></i>
                    </a>
                </div>
            </div>

            <div>
                <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4 border-b border-[#333] pb-2">Live Matches</h3>
                <div id="liveMatchList" class="space-y-3">
                    <!-- Live matches injected here -->
                    <div class="text-center text-gray-600 text-xs italic py-4">No live matches</div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-8 overflow-y-auto custom-scroll relative">
            <div class="max-w-6xl mx-auto">
                
                <!-- Active Match Control -->
                <div id="activeMatchPanel" class="hidden mb-10 animate-slide-up">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-2xl font-header text-white flex items-center gap-3">
                            <i class="fa-solid fa-tower-broadcast text-[#ff4655]"></i> Active Match Control
                        </h2>
                        <span class="text-xs font-mono text-gray-500" id="activeMatchId">ID: --</span>
                    </div>

                    <div class="glass-panel p-6 relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-1 h-full bg-[#ff4655]"></div>
                        
                        <div class="flex justify-between items-center mb-8">
                            <div class="text-center w-1/3">
                                <h3 class="text-3xl font-header text-white" id="teamAName">TEAM A</h3>
                                <div class="text-4xl font-bold text-[#ff4655] mt-2" id="scoreA">0</div>
                            </div>
                            <div class="text-center">
                                <div class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-1">Current Map</div>
                                <div class="text-xl font-bold text-white" id="currentMap">Ascent</div>
                                <div class="mt-4 px-4 py-1 bg-[#222] rounded text-xs font-mono text-gray-400 border border-[#333]" id="matchStatus">LIVE</div>
                            </div>
                            <div class="text-center w-1/3">
                                <h3 class="text-3xl font-header text-white" id="teamBName">TEAM B</h3>
                                <div class="text-4xl font-bold text-[#ff4655] mt-2" id="scoreB">0</div>
                            </div>
                        </div>

                        <div class="grid grid-cols-3 gap-4">
                            <button onclick="copyOverlayLink()" class="btn-action py-3 rounded flex items-center justify-center gap-2">
                                <i class="fa-solid fa-link"></i> Copy Overlay URL
                            </button>
                            <button onclick="openOverlayWindow()" class="btn-action py-3 rounded flex items-center justify-center gap-2">
                                <i class="fa-solid fa-window-restore"></i> Open Overlay Popup
                            </button>
                            <button onclick="openPostMatchWindow()" class="btn-action py-3 rounded flex items-center justify-center gap-2">
                                <i class="fa-solid fa-flag-checkered"></i> Post-Match
                            </button>
                            <button onclick="refreshData()" class="btn-action py-3 rounded flex items-center justify-center gap-2">
                                <i class="fa-solid fa-rotate"></i> Refresh Data
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Upcoming Schedule -->
                <div>
                    <h2 class="text-xl font-header text-white mb-6 border-l-4 border-blue-500 pl-3">Upcoming Schedule</h2>
                    <div id="scheduleList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Schedule items -->
                    </div>
                </div>

            </div>
        </main>
    </div>

    <script>
        const API_BASE = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') && window.location.port !== '3000' ? 'http://localhost:3000' : '';
        const socket = io(API_BASE || undefined);
        
        let allMatches = [];
        let activeMatch = null;

        socket.on('match_update', () => fetchData());
        socket.on('bracket_update', () => fetchData());

        async function fetchData() {
            try {
                const res = await fetch(`${API_BASE}/api/matches`);
                allMatches = await res.json();
                renderDashboard();
            } catch (e) { console.error(e); }
        }

        function renderDashboard() {
            const liveContainer = document.getElementById('liveMatchList');
            const scheduleContainer = document.getElementById('scheduleList');
            
            const liveMatches = allMatches.filter(m => m.status === 'live');
            const upcomingMatches = allMatches.filter(m => m.status === 'scheduled').sort((a,b) => new Date(a.scheduledTime) - new Date(b.scheduledTime));

            // Render Live Sidebar
            if (liveMatches.length > 0) {
                liveContainer.innerHTML = liveMatches.map(m => `
                    <div onclick="selectMatch('${m._id}')" class="p-3 bg-[#222] border border-[#333] rounded cursor-pointer hover:border-[#ff4655] transition group">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-[10px] font-bold text-[#ff4655] flex items-center gap-1"><div class="live-indicator"></div> LIVE</span>
                            <span class="text-[10px] text-gray-500 font-mono">BO${m.format === 'BO1' ? '1' : (m.format === 'BO3' ? '3' : '5')}</span>
                        </div>
                        <div class="flex justify-between items-center text-sm font-bold text-white">
                            <span>${m.teamA ? m.teamA.shortName : 'TBD'}</span>
                            <span class="text-gray-500 text-xs">vs</span>
                            <span>${m.teamB ? m.teamB.shortName : 'TBD'}</span>
                        </div>
                    </div>
                `).join('');
            } else {
                liveContainer.innerHTML = '<div class="text-center text-gray-600 text-xs italic py-4">No live matches</div>';
            }

            // Render Schedule
            scheduleContainer.innerHTML = upcomingMatches.map(m => `
                <div class="glass-panel p-4">
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-xs font-bold text-blue-400 uppercase tracking-wider">Scheduled</span>
                        <span class="text-xs font-mono text-gray-500">${m.scheduledTime ? new Date(m.scheduledTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : 'TBD'}</span>
                    </div>
                    <div class="text-lg font-header text-white mb-1">${m.teamA ? m.teamA.name : 'TBD'}</div>
                    <div class="text-xs text-gray-500 font-bold mb-1">VS</div>
                    <div class="text-lg font-header text-white">${m.teamB ? m.teamB.name : 'TBD'}</div>
                    <div class="mt-4 pt-3 border-t border-[#333] flex justify-end">
                        <button onclick="selectMatch('${m._id}')" class="text-xs font-bold text-gray-400 hover:text-white uppercase transition">Select Match <i class="fa-solid fa-arrow-right ml-1"></i></button>
                    </div>
                </div>
            `).join('');

            // Update Active Panel if selected
            if (activeMatch) {
                const updated = allMatches.find(m => m._id === activeMatch._id);
                if (updated) selectMatch(updated._id);
            }
        }

        function selectMatch(id) {
            activeMatch = allMatches.find(m => m._id === id);
            if (!activeMatch) return;

            document.getElementById('activeMatchPanel').classList.remove('hidden');
            document.getElementById('activeMatchId').innerText = `ID: ${activeMatch._id}`;
            document.getElementById('teamAName').innerText = activeMatch.teamA ? activeMatch.teamA.shortName : 'TBD';
            document.getElementById('teamBName').innerText = activeMatch.teamB ? activeMatch.teamB.shortName : 'TBD';
            
            // Calculate Score
            let sA = 0, sB = 0;
            if (activeMatch.scores) {
                activeMatch.scores.forEach(s => {
                    if (parseInt(s.teamAScore) > parseInt(s.teamBScore)) sA++;
                    else if (parseInt(s.teamBScore) > parseInt(s.teamAScore)) sB++;
                });
            }
            document.getElementById('scoreA').innerText = sA;
            document.getElementById('scoreB').innerText = sB;
            
            // Current Map
            let currentMap = "Veto Phase";
            if (activeMatch.vetoData && activeMatch.vetoData.pickedMaps && activeMatch.vetoData.pickedMaps.length > 0) {
                // Simple logic: last picked map or based on scores
                const mapIdx = Math.min(sA + sB, activeMatch.vetoData.pickedMaps.length - 1);
                if (activeMatch.vetoData.pickedMaps[mapIdx]) {
                    currentMap = activeMatch.vetoData.pickedMaps[mapIdx].map;
                }
            }
            document.getElementById('currentMap').innerText = currentMap;
            document.getElementById('matchStatus').innerText = activeMatch.status.toUpperCase();
        }

        function copyOverlayLink() {
            if (!activeMatch) return;
            const url = `${window.location.origin}/overlay.html?match=${activeMatch._id}`;
            navigator.clipboard.writeText(url).then(() => alert('Overlay URL Copied!'));
        }

        function openOverlayWindow() {
            if (!activeMatch) return;
            window.open(`/overlay.html?match=${activeMatch._id}`, 'Overlay', 'width=1920,height=1080,menubar=no,toolbar=no');
        }

        function openPostMatchWindow() {
            if (!activeMatch) return;
            window.open(`/post_match.html?match=${activeMatch._id}`, 'PostMatch', 'width=1920,height=1080,menubar=no,toolbar=no');
        }

        function refreshData() {
            fetchData();
        }

        // Init
        fetchData();
    </script>
</body>
</html>